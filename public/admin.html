<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | Guardianes 2027</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/lucide@0.446.0/dist/umd/lucide.min.js"></script>
    <style>
        :root {
            --primary: #060f3b;
            --accent: #ca8a04;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background-color: var(--primary);
            color: #f8fafc;
        }

        .sidebar {
            background: #0f172a;
            border-right: 1px solid rgba(255, 255, 255, 0.05);
        }

        .glass-card {
            background: rgba(30, 41, 59, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(12px);
        }

        .btn-accent {
            background: var(--accent);
            color: #020617;
            transition: all 0.2s;
            font-weight: 900;
        }

        .btn-accent:hover {
            background: #eab308;
            transform: translateY(-1px);
            box-shadow: 0 10px 20px rgba(234, 179, 8, 0.2);
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 999px;
            font-size: 9px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .status-active {
            background: rgba(16, 185, 129, 0.15);
            color: #10b981;
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        .status-paused {
            background: rgba(244, 63, 94, 0.15);
            color: #f43f5e;
            border: 1px solid rgba(244, 63, 94, 0.2);
        }
    </style>
</head>

<body class="flex min-h-screen">
    <!-- SIDEBAR -->
    <aside class="w-80 sidebar flex flex-col p-10 gap-12">
        <div class="flex items-center gap-4">
            <div
                class="w-12 h-12 bg-amber-600 rounded-xl flex items-center justify-center font-black text-3xl shadow-xl shadow-amber-900/40">
                A</div>
            <div>
                <h1 class="text-xl font-black tracking-tighter uppercase italic">Control <span
                        class="text-amber-500">2027</span></h1>
                <p class="text-[14px] font-black opacity-30 uppercase tracking-[0.4em]">Estrategia Gubernamental</p>
            </div>
        </div>

        <nav class="flex flex-col gap-4">
            <button onclick="switchView('dashboard')"
                class="nav-item flex items-center gap-4 p-5 rounded-[1.25rem] font-black text-[18px] uppercase tracking-widest hover:bg-white/5 transition text-left opacity-40">
                <i data-lucide="layout-dashboard" class="w-5 h-5"></i> Dashboard
            </button>
            <button onclick="switchView('surveys')"
                class="nav-item active flex items-center gap-4 p-5 rounded-[1.25rem] font-black text-[18px] uppercase tracking-widest bg-amber-600 text-slate-950 shadow-2xl shadow-amber-900/40 text-left">
                <i data-lucide="clipboard-list" class="w-5 h-5"></i> Gesti√≥n de Encuestas
            </button>
            <button onclick="switchView('incidents')"
                class="nav-item flex items-center gap-4 p-5 rounded-[1.25rem] font-black text-[18px] uppercase tracking-widest hover:bg-white/5 transition text-left opacity-40">
                <i data-lucide="alert-triangle" class="w-5 h-5"></i> Panel de Alertas
            </button>
            <button onclick="switchView('users')"
                class="nav-item flex items-center gap-4 p-5 rounded-[1.25rem] font-black text-[18px] uppercase tracking-widest hover:bg-white/5 transition text-left opacity-40">
                <i data-lucide="users" class="w-5 h-5"></i> Registro Civil
            </button>
        </nav>

        <div class="mt-auto pt-10 border-t border-white/5">
            <div class="flex items-center gap-3 px-4 mb-6">
                <div class="w-8 h-8 rounded-full bg-slate-800 border border-white/10 overflow-hidden">
                    <img src="https://ui-avatars.com/api/?name=Admin&background=0f172a&color=fff" alt="Profile">
                </div>
                <div class="flex-1">
                    <p class="text-[10px] font-black uppercase">Administrador</p>
                    <p class="text-[8px] font-bold text-slate-500">Sesi√≥n Segura Activada</p>
                </div>
            </div>
            <button onclick="adminLogout()"
                class="w-full flex items-center justify-center gap-3 text-red-400 font-black text-[10px] uppercase tracking-widest p-4 rounded-xl hover:bg-red-500/5 transition">
                <i data-lucide="log-out" class="w-4 h-4"></i> Terminar Sesi√≥n
            </button>
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="flex-1 p-16 overflow-y-auto">

        <!-- LOGIN OVERLAY -->
        <div id="login-overlay" class="fixed inset-0 z-[1000] bg-slate-950 flex items-center justify-center p-4">
            <div
                class="w-full max-w-sm glass-card p-12 rounded-[3rem] text-center border-white/10 shadow-2xl animate-in zoom-in-95 duration-500">
                <div
                    class="w-20 h-20 bg-amber-600 mx-auto rounded-3xl mb-8 flex items-center justify-center font-black text-4xl shadow-2xl shadow-amber-900/40 italic">
                    G</div>
                <h2 class="text-3xl font-black mb-1 italic uppercase tracking-tighter">Entorno <span
                        class="text-amber-500">Privado</span></h2>
                <p class="text-[9px] font-bold text-slate-500 mb-10 uppercase tracking-widest">Ingrese credenciales de
                    Comandancia</p>
                <div class="space-y-4">
                    <input type="text" id="admin-user" placeholder="Usuario"
                        class="w-full bg-slate-900 border border-white/10 p-5 rounded-2xl text-center font-bold outline-none focus:border-amber-600 transition tracking-widest">
                    <input type="password" id="admin-pass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                        class="w-full bg-slate-900 border border-white/10 p-5 rounded-2xl text-center font-bold outline-none focus:border-amber-600 transition tracking-[0.3em]">
                </div>
                <button onclick="handleLogin()"
                    class="w-full btn-accent p-5 rounded-2xl font-black uppercase text-xs tracking-widest mt-8 shadow-xl">Autenticar
                    Sistema</button>
                <p class="text-[8px] mt-8 opacity-20 uppercase font-bold tracking-widest">Acceso monitoreado y grabado
                    en archivo</p>
            </div>
        </div>

        <!-- DASHBOARD VIEW -->
        <div id="view-dashboard" class="admin-view hidden animate-in fade-in slide-in-from-right-8 duration-500">
            <header class="flex justify-between items-center mb-16">
                <div>
                    <h2 class="text-5xl font-black tracking-tighter uppercase italic">Estado del <span
                            class="text-amber-500">Sistema</span></h2>
                    <p class="text-slate-500 text-[10px] font-black mt-3 uppercase tracking-[0.4em]">M√©tricas Globales
                        de Intervenci√≥n</p>
                </div>
            </header>
            <div id="stats-dashboard-grid" class="grid grid-cols-4 gap-8 mb-16">
                <!-- Stats injected here -->
            </div>
            <!-- Recent Activity Placeholder -->
            <div
                class="glass-card p-12 rounded-[3rem] border-white/5 opacity-30 text-center uppercase font-black italic tracking-widest">
                Monitoreo de Actividad en Tiempo Real
            </div>
        </div>

        <!-- SURVEYS VIEW -->
        <div id="view-surveys" class="admin-view animate-in fade-in slide-in-from-right-8 duration-500">
            <header class="flex justify-between items-center mb-16">
                <div>
                    <h2 class="text-5xl font-black tracking-tighter uppercase italic">Terminal de <span
                            class="text-amber-500">Encuestas</span></h2>
                    <p class="text-slate-500 text-[10px] font-black mt-3 uppercase tracking-[0.4em]">Intervenci√≥n
                        Democr√°tica en Tiempo Real</p>
                </div>
                <button onclick="openCreateModal()"
                    class="btn-accent px-8 py-4 rounded-[1.25rem] text-[10px] flex items-center gap-3 shadow-2xl uppercase tracking-widest transition transform hover:scale-105">
                    <i data-lucide="plus" class="w-4 h-4"></i> Desplegar Nueva Encuesta
                </button>
            </header>

            <div class="glass-card rounded-[3rem] overflow-hidden shadow-2xl border-white/5">
                <table class="w-full text-left">
                    <thead class="bg-white/5 text-[9px] font-black uppercase text-slate-500 tracking-[0.3em]">
                        <tr>
                            <th class="px-10 py-8">Cartograf√≠a / T√≠tulo</th>
                            <th class="px-10 py-8">Nivel Estrat√©gico</th>
                            <th class="px-10 py-8">Estado Operativo</th>
                            <th class="px-10 py-8 text-center">Votos Registrados</th>
                            <th class="px-10 py-8 text-right">Protocolos</th>
                        </tr>
                    </thead>
                    <tbody id="surveys-table-body" class="divide-y divide-white/5 italic">
                        <!-- Table rows injected here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- INCIDENTS VIEW -->
        <div id="view-incidents" class="admin-view hidden animate-in fade-in slide-in-from-right-8 duration-500">
            <header class="flex justify-between items-center mb-16">
                <div>
                    <h2 class="text-5xl font-black tracking-tighter uppercase italic">Centro de <span
                            class="text-red-500">Alertas</span></h2>
                    <p class="text-slate-500 text-[10px] font-black mt-3 uppercase tracking-[0.4em]">Reportes de
                        Anomal√≠as Territoriales</p>
                </div>
            </header>
            <div id="incidents-container" class="grid grid-cols-1 gap-6">
                <!-- Incidents injected here -->
                <div
                    class="glass-card p-20 rounded-[3rem] text-center opacity-20 uppercase font-black italic tracking-[0.3em]">
                    Buscando reportes activos en la red...
                </div>
            </div>
        </div>

        <!-- USERS VIEW -->
        <div id="view-users" class="admin-view hidden animate-in fade-in slide-in-from-right-8 duration-500">
    <header class="flex justify-between items-center mb-16">
        <div>
            <h2 class="text-5xl font-black tracking-tighter uppercase italic">Registro <span
                    class="text-emerald-500">Civil</span></h2>
            <p class="text-slate-500 text-[10px] font-black mt-3 uppercase tracking-[0.4em]">Base de Datos de
                Influencia Ciudadana</p>
        </div>
    </header>
    
    <!-- TABLA DE USUARIOS -->
    <div class="glass-card rounded-[3rem] overflow-hidden shadow-2xl border-white/5">
        <table class="w-full text-left">
            <thead class="bg-white/5 text-[9px] font-black uppercase text-slate-500 tracking-[0.3em]">
                <tr>
                    <th class="px-10 py-8">Tel√©fono</th>
                    <th class="px-10 py-8">Nombre</th>
                    <th class="px-10 py-8 text-center">Puntos</th>
                    <th class="px-10 py-8">Nivel</th>
                    <th class="px-10 py-8 text-right">Total Votos</th>
                </tr>
            </thead>
            <tbody id="users-table-body" class="divide-y divide-white/5 italic">
                <!-- Rows injected by loadUsers() -->
                <tr>
                    <td colspan="5" class="p-20 text-center opacity-20 uppercase font-black italic tracking-widest">
                        Cargando registros...
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>
    </main>

    <!-- MODAL -->
    <div id="create-modal"
        class="fixed inset-0 z-[500] hidden bg-black/90 backdrop-blur-2xl flex items-center justify-center p-4">
        <div
            class="w-full max-w-xl glass-card p-14 rounded-[3.5rem] relative border-white/10 shadow-[0_0_80px_rgba(0,0,0,0.5)] animate-in zoom-in-95 duration-300">
            <button onclick="closeCreateModal()"
                class="absolute top-10 right-10 opacity-30 hover:opacity-100 transition text-2xl font-thin">&times;</button>
            <h3 class="text-4xl font-black mb-10 italic uppercase tracking-tighter leading-none">Nueva <span
                    class="text-amber-500">Misi√≥n</span></h3>

            <div class="space-y-8 max-h-[60vh] overflow-y-auto pr-4 scrollbar-hide">
                <div>
                    <label
                        class="text-[9px] font-black text-slate-500 uppercase tracking-[0.3em] block mb-3 pl-1">T√≠tulo
                        de Inteligencia</label>
                    <input type="text" id="s-title" placeholder="Ej: Tendencia Gubernatura Guerrero 2027"
                        class="w-full bg-slate-900 border border-white/10 p-5 rounded-2xl font-black outline-none focus:border-amber-600 transition text-lg tracking-tight italic">
                </div>
                <div>
                    <label
                        class="text-[9px] font-black text-slate-500 uppercase tracking-[0.3em] block mb-3 pl-1">Descripci√≥n
                        de Operaci√≥n</label>
                    <textarea id="s-desc"
                        class="w-full bg-slate-900 border border-white/10 p-5 rounded-2xl font-medium h-24 outline-none focus:border-amber-600 transition placeholder:opacity-20 italic"
                        placeholder="Breve contexto para el ciudadano..."></textarea>
                </div>
                    <div class="grid grid-cols-2 gap-6">
                    <div>
                        <label
                            class="text-[9px] font-black text-slate-500 uppercase tracking-[0.3em] block mb-3 pl-1">√Åmbito
                            Geogr√°fico</label>
                        <select id="s-level" onchange="toggleMunicipalitySelector()"
                            class="w-full bg-slate-900 border border-white/10 p-5 rounded-2xl font-black outline-none focus:border-amber-600 transition text-xs tracking-widest uppercase italic">
                            <option value="Gubernatura">Gubernatura</option>
                            <option value="Municipio">Municipio</option>
                            <option value="Distrito Local">Distrito Local</option>
                        </select>
                    </div>
                    <div>
                        <label
                            class="text-[9px] font-black text-slate-500 uppercase tracking-[0.3em] block mb-3 pl-1">Tipo
                            de Evento</label>
                        <select id="s-type"
                            class="w-full bg-slate-900 border border-white/10 p-5 rounded-2xl font-black outline-none focus:border-amber-600 transition text-xs tracking-widest uppercase italic">
                            <option value="gubernatura">ELECCIONES 2027</option>
                            <option value="ayuntamiento">AYUNTAMIENTOS</option>
                            <option value="general">CONSULTA GENERAL</option>
                        </select>
                    </div>
                </div>

                <!-- SELECTOR DE MUNICIPIO (solo visible cuando es Municipal) -->
                <div id="municipality-selector" class="hidden">
                    <label
                        class="text-[9px] font-black text-slate-500 uppercase tracking-[0.3em] block mb-3 pl-1">Municipio
                        Espec√≠fico</label>
                    <select id="s-municipality"
                        class="w-full bg-slate-900 border border-white/10 p-5 rounded-2xl font-black outline-none focus:border-amber-600 transition text-xs tracking-widest uppercase italic">
                        <option value="">CARGANDO MUNICIPIOS...</option>
                    </select>
                </div>

                <!-- OPTIONS BUILDER -->
                <div class="pt-6 border-t border-white/5">
                    <div class="flex justify-between items-center mb-4">
                        <label
                            class="text-[9px] font-black text-slate-500 uppercase tracking-[0.3em] block pl-1">Candidatos
                            / Opciones</label>
                        <button onclick="addOptionField()"
                            class="text-amber-500 text-[10px] font-black uppercase tracking-widest hover:underline">+
                            A√±adir</button>
                    </div>
                    <div id="options-list" class="space-y-3">
                        <!-- Dynamic fields -->
                    </div>
                </div>

                <div class="p-6 bg-amber-600/5 border border-amber-600/10 rounded-[2rem] flex gap-4 items-center">
                    <div
                        class="w-10 h-10 rounded-full bg-amber-600/10 flex items-center justify-center flex-shrink-0 text-amber-500">
                        <i data-lucide="shield-check" class="w-5 h-5"></i>
                    </div>
                    <p class="text-[9px] font-black text-slate-500 uppercase tracking-widest italic leading-relaxed">
                        Se incluir√° autom√°ticamente el <span class="text-amber-500">slider de confianza</span> al final
                        de la encuesta.
                    </p>
                </div>
            </div>

            <div class="flex gap-6 mt-12">
                <button onclick="closeCreateModal()"
                    class="flex-1 p-5 rounded-2xl font-black text-[10px] uppercase tracking-[0.2em] text-slate-500 hover:text-white transition">Interrumpir</button>
                <button onclick="createSurvey()"
                    class="flex-[3] btn-accent p-5 rounded-2xl text-[11px] uppercase tracking-[0.3em] shadow-2xl">Confirmar
                    Despliegue</button>
            </div>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script>
        const API_URL = '/api';
        let adminToken = localStorage.getItem('guardianAdminToken');

        // --- AUTH ---
        async function handleLogin() {
            const username = document.getElementById('admin-user').value;
            const password = document.getElementById('admin-pass').value;

            try {
                const res = await fetch(`${API_URL}/admin/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const data = await res.json();
                if (data.success) {
                    localStorage.setItem('guardianAdminToken', data.token);
                    adminToken = data.token;
                    showPortal();
                } else { alert('Acceso Denegado: ' + (data.error || '')); }
            } catch (e) { alert('Error de Red Critico'); }
        }

        function showPortal() {
            document.getElementById('login-overlay').classList.add('hidden');
            // document.getElementById('admin-portal').classList.remove('hidden'); // Eliminado ID inexistente
            lucide.createIcons();
            loadStats();
            loadSurveys();
        }

        // --- DATA ---
        async function loadStats() {
            try {
                const res = await fetch(`${API_URL}/admin/stats`, {
                    headers: { 'Authorization': `Bearer ${adminToken}` }
                });
                const data = await res.json();
                const grids = document.querySelectorAll('#stats-dashboard-grid');
                grids.forEach(grid => {
                    grid.innerHTML = `
                        <div class="glass-card p-8 rounded-[2.5rem] shadow-xl border-white/5">
                            <span class="text-[9px] font-black text-slate-500 uppercase tracking-widest block mb-2">Unidad Poblacional</span>
                            <div class="text-4xl font-black italic tracking-tighter">${data.totalUsers || 0} <span class="text-sm not-italic opacity-40 uppercase tracking-widest font-thin ml-1">Cels</span></div>
                        </div>
                        <div class="glass-card p-8 rounded-[2.5rem] shadow-xl border-white/5">
                            <span class="text-[9px] font-black text-slate-500 uppercase tracking-widest block mb-2">Predicciones Almacenadas</span>
                            <div class="text-4xl font-black italic tracking-tighter">${data.governorVotes || 0} <span class="text-sm not-italic opacity-40 uppercase tracking-widest font-thin ml-1">Vot.</span></div>
                        </div>
                        <div class="glass-card p-8 rounded-[2.5rem] shadow-xl border-l-[6px] border-amber-600">
                            <span class="text-[9px] font-black text-amber-500 uppercase tracking-widest block mb-2">Operaciones Activas</span>
                            <div class="text-4xl font-black italic tracking-tighter text-amber-500">${data.activeSurveys || 0} <span class="text-sm not-italic opacity-40 uppercase tracking-widest font-thin ml-1">Enc.</span></div>
                        </div>
                        <div class="glass-card p-8 rounded-[2.5rem] shadow-xl border-white/5">
                            <span class="text-[9px] font-black text-red-500 uppercase tracking-widest block mb-2">Focos de Alerta</span>
                            <div class="text-4xl font-black italic tracking-tighter text-red-500">${data.pendingIncidents || 0} <span class="text-sm not-italic opacity-40 uppercase tracking-widest font-thin ml-1">Inc.</span></div>
                        </div>
                    `;
                });
            } catch (e) { }
        }

   async function loadSurveys() {
  try {
    const res = await fetch(`${API_URL}/admin/surveys`, {
      headers: { 'Authorization': `Bearer ${adminToken}` }
    });
    
    const surveys = await res.json();
    const tbody = document.getElementById('surveys-table-body');
    
    tbody.innerHTML = surveys.map(s => `
      <tr class="hover:bg-amber-600/[0.03] transition-all group">
        <td class="px-10 py-10">
          <div class="font-black text-base uppercase tracking-tighter">${s.title}</div>
          <div class="text-[9px] font-bold text-slate-600 mt-2 line-clamp-1 uppercase tracking-widest overflow-hidden opacity-60">${s.description || '- SIN DESCRIPCI√ìN -'}</div>
        </td>
        <td class="px-10 py-10 font-black text-[10px] text-amber-500 uppercase tracking-[0.2em] italic">${s.election_type || 'GENERAL'}</td>
        <td class="px-10 py-10">
          <span class="status-badge ${s.is_active ? 'status-active' : 'status-paused'}">
            ${s.is_active ? 'Operativo' : 'Inactivo'}
          </span>
        </td>
        <td class="px-10 py-10 text-center font-black text-2xl tracking-tighter italic opacity-80">${s.total_responses || 0}</td>
        <td class="px-10 py-10 text-right">
          <div class="flex flex-col gap-2 opacity-30 group-hover:opacity-100 transition-opacity">
            <button onclick="exportCSV(${s.id})" class="text-[9px] font-black uppercase tracking-[0.2em] border border-white/10 px-3 py-2 rounded-lg hover:border-amber-600 hover:text-amber-500 transition shadow-inner shadow-black/20">üì• Exportar</button>
            <button onclick="toggleStatus(${s.id}, ${s.is_active})" class="text-[9px] font-black uppercase tracking-[0.2em] border border-white/10 px-3 py-2 rounded-lg ${s.is_active ? 'hover:border-amber-600 hover:text-amber-500' : 'hover:border-emerald-600 hover:text-emerald-500'} transition shadow-inner shadow-black/20">üîÑ ${s.is_active ? 'Pausar' : 'Activar'}</button>
            <button onclick="deleteSurvey(${s.id})" class="text-[9px] font-black uppercase tracking-[0.2em] border border-white/10 px-3 py-2 rounded-lg hover:border-red-600 hover:text-red-500 transition shadow-inner shadow-black/20">üóëÔ∏è Eliminar</button>
          </div>
        </td>
      </tr>
    `).join('');
    
  } catch (e) { 
    console.error('Error cargando encuestas:', e);
    showToast('Error cargando encuestas', 'error');
  }
}


        async function toggleStatus(id, currentStatus) {
            try {
                const res = await fetch(`${API_URL}/admin/surveys/${id}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${adminToken}`
                    },
                    body: JSON.stringify({ isActive: !currentStatus })
                });
                if (res.ok) loadSurveys();
                else {
                    const data = await res.json();
                    alert('Error: ' + (data.error || 'No se pudo cambiar el estado'));
                }
            } catch (e) { alert('Falla de red'); }
        }

        async function deleteSurvey(id) {
            if (!confirm('¬øADVERTENCIA CR√çTICA: Seguro que desea eliminar esta encuesta y TODOS sus votos? Esta acci√≥n es irreversible.')) return;
            try {
                const res = await fetch(`${API_URL}/admin/surveys/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${adminToken}` }
                });
                if (res.ok) {
                    loadSurveys();
                    loadStats();
                } else {
                    const data = await res.json();
                    alert('Error: ' + (data.error || 'No se pudo eliminar'));
                }
            } catch (e) { alert('Falla de red'); }
        }

        function exportCSV(id) {
            // El backend permite token por query string para descargas directas
            window.open(`${API_URL}/admin/surveys/${id}/export?token=${adminToken}`, '_blank');
        }

        async function loadIncidents() {
            try {
                const res = await fetch(`${API_URL}/incidents`, {
                    headers: { 'Authorization': `Bearer ${adminToken}` }
                });
                const data = await res.json();
                const container = document.getElementById('incidents-container');
                container.innerHTML = (data.incidents || []).map(i => `
                    <div class="glass-card p-8 rounded-[2rem] flex justify-between items-center border-white/5 group hover:border-red-500/30 transition">
                        <div class="flex gap-6 items-center">
                            <div class="w-14 h-14 bg-red-600/10 rounded-2xl flex items-center justify-center text-red-500 font-black">!</div>
                            <div>
                                <h4 class="font-black uppercase tracking-tighter italic text-red-500">${i.type}</h4>
                                <p class="text-xs text-slate-500 font-medium truncate w-96">${i.description}</p>
                                <div class="flex gap-4 mt-2">
                                    <span class="text-[8px] font-black uppercase tracking-widest text-slate-600">Municipio: ${i.municipalityName}</span>
                                    <span class="text-[8px] font-black uppercase tracking-widest text-slate-600">Hace ${timeAgo(i.createdAt)}</span>
                                </div>
                            </div>
                        </div>
                        <div class="flex gap-3">
                            <button onclick="updateIncidentStatus(${i.id}, 'verified')" class="text-[9px] font-black uppercase tracking-widest border border-white/10 px-4 py-2 rounded-lg hover:bg-emerald-600 hover:text-slate-950 transition">Verificar</button>
                            <button onclick="updateIncidentStatus(${i.id}, 'rejected')" class="text-[9px] font-black uppercase tracking-widest border border-white/10 px-4 py-2 rounded-lg hover:bg-red-600 hover:text-slate-950 transition">Descartar</button>
                        </div>
                    </div>
                `).join('') || container.innerHTML;
            } catch (e) { }
        }

        function timeAgo(date) {
            const seconds = Math.floor((new Date() - new Date(date)) / 1000);
            if (seconds < 60) return seconds + 's';
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return minutes + 'm';
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return hours + 'h';
            return Math.floor(hours / 24) + 'd';
        }

        // --- ACTIONS ---
        function addOptionField() {
            const list = document.getElementById('options-list');
            const div = document.createElement('div');
            div.className = 'flex gap-3 animate-in fade-in zoom-in-95 duration-200';
            div.innerHTML = `
                <input type="text" placeholder="Nombre Candidato" class="flex-[2] bg-slate-900 border border-white/10 p-3 rounded-xl text-xs font-bold outline-none focus:border-amber-600">
                <input type="text" placeholder="URL Foto (opcional)" class="flex-[2] bg-slate-900 border border-white/10 p-3 rounded-xl text-[10px] font-medium outline-none focus:border-amber-600">
                <button onclick="this.parentElement.remove()" class="flex-none w-10 h-10 bg-red-600/10 text-red-500 rounded-xl hover:bg-red-600 hover:text-white transition">√ó</button>
            `;
            list.appendChild(div);
        }
        // --- TOGGLE MUNICIPIO SELECTOR ---
function toggleMunicipalitySelector() {
    const level = document.getElementById('s-level').value;
    const municipalityDiv = document.getElementById('municipality-selector');
    
    if (level === 'Municipio') {
        municipalityDiv.classList.remove('hidden');
        loadMunicipalities(); // Cargar municipios si a√∫n no se han cargado
    } else {
        municipalityDiv.classList.add('hidden');
        document.getElementById('s-municipality').value = ''; // Limpiar selecci√≥n
    }
}

// --- CARGAR MUNICIPIOS EN SELECTOR ---
async function loadMunicipalities() {
    const select = document.getElementById('s-municipality');
    
    // Si ya tiene opciones (m√°s de 1), no recargar
    if (select.options.length > 1) return;
    
    try {
        const res = await fetch(`${API_URL}/data/municipalities`);
        const data = await res.json();
        
        const validData = data.filter(m => m.name && m.name.trim().length > 0);
        
        select.innerHTML = '<option value="">SELECCIONA MUNICIPIO</option>' + 
            validData.map(m => {
                const cleanName = m.name.replace(/^[0-9\s\-]+/, '').toUpperCase();
                if (!cleanName.trim()) return '';
                return `<option value="${m.id}">${cleanName}</option>`;
            }).join('');
            
    } catch (e) {
        console.error('Error cargando municipios:', e);
        select.innerHTML = '<option value="">ERROR CARGANDO MUNICIPIOS</option>';
    }
}

        async function createSurvey() {
            const title = document.getElementById('s-title').value;
            if (!title) return alert('Operaci√≥n requiere nombre descriptivo');

            const optionFields = document.getElementById('options-list').children;
            const options = Array.from(optionFields).map(f => ({
                label: f.children[0].value,
                value: f.children[0].value,
                photo: f.children[1].value || null
            })).filter(o => o.label);

                const payload = {
                    title: title,
                    description: document.getElementById('s-desc').value,
                    level: document.getElementById('s-level').value,
                    electionType: document.getElementById('s-type').value,
                    municipalityId: document.getElementById('s-municipality').value || null,
                    questions: [
                    {
                        text: '¬øQui√©n crees que ganar√°?',
                        type: 'single_choice',
                        options: options
                    },
                    {
                        text: 'Nivel de Confianza',
                        type: 'confidence_scale',
                        isRequired: true
                    }
                ]
            };

            try {
                const res = await fetch(`${API_URL}/admin/surveys`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${adminToken}` },
                    body: JSON.stringify(payload)
                });

                if (res.ok) {
                    closeCreateModal();
                    loadSurveys();
                    loadStats();
                } else {
                    const data = await res.json();
                    alert('Error en protocolo: ' + (data.error || 'Desconocido'));
                }
            } catch (e) { alert('Falla en la red'); }
        }

        async function loadUsers() {
            try {
                const res = await fetch(`${API_URL}/admin/users`, {
                    headers: { 'Authorization': `Bearer ${adminToken}` }
                });
                const users = await res.json();
                const tbody = document.getElementById('users-table-body');
                tbody.innerHTML = (users || []).map(u => `
                    <tr class="hover:bg-emerald-600/[0.03] transition-all">
                        <td class="px-10 py-8 font-black text-slate-500">**** ${u.phone_last4 || '????'}</td>
                        <td class="px-10 py-8 font-black uppercase tracking-tight text-white">${u.name || 'AN√ìNIMO'}</td>
                        <td class="px-10 py-8 text-center font-black text-amber-500">${u.points || 0}</td>
                        <td class="px-10 py-8 font-bold text-[10px] uppercase opacity-40">${u.level || 'OBSERVADOR'}</td>
                        <td class="px-10 py-8 text-right font-black text-[10px] uppercase tracking-widest text-emerald-500">${u.total_votes || 0} Votos</td>
                    </tr>
                `).join('') || '<tr><td colspan="5" class="p-20 text-center opacity-20">SIN REGISTROS</td></tr>';
            } catch (e) { }
        }

        async function updateIncidentStatus(id, status) {
            try {
                const res = await fetch(`${API_URL}/incidents/${id}/status`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${adminToken}` },
                    body: JSON.stringify({ status })
                });
                if (res.ok) loadIncidents();
            } catch (e) { }
        }

        // --- VIEW ---
        function switchView(viewId) {
            // Hide all views
            document.querySelectorAll('.admin-view').forEach(v => v.classList.add('hidden'));
            // Show target view
            document.getElementById('view-' + viewId).classList.remove('hidden');

            // Update sidebar buttons
            document.querySelectorAll('.nav-item').forEach(btn => {
                btn.classList.remove('active', 'bg-amber-600', 'text-slate-950', 'opacity-100');
                btn.classList.add('opacity-40');
            });
            const activeBtn = document.querySelector(`[onclick="switchView('${viewId}')"]`);
            activeBtn.classList.add('active', 'bg-amber-600', 'text-slate-950', 'opacity-100');
            activeBtn.classList.remove('opacity-40');

            if (viewId === 'dashboard') loadStats();
            if (viewId === 'surveys') loadSurveys();
            if (viewId === 'incidents') loadIncidents();
            if (viewId === 'users') loadUsers();
        }

        function openCreateModal() {
            document.getElementById('create-modal').classList.remove('hidden');
            document.getElementById('options-list').innerHTML = '';
            // Add some default options
            addOptionField();
            addOptionField();
        }
        function closeCreateModal() { document.getElementById('create-modal').classList.add('hidden'); }
        function adminLogout() { localStorage.removeItem('guardianAdminToken'); location.reload(); }

        if (adminToken) showPortal();
// ============================================
// OPTIMIZACI√ìN: Cach√© y Lazy Loading
// ============================================

// Cach√© en memoria para stats (evita m√∫ltiples llamadas)
let statsCache = null;
let statsCacheTime = 0;
const CACHE_DURATION = 5000; // 5 segundos

async function loadStats() {
  const now = Date.now();
  
  // Usar cach√© si es reciente
  if (statsCache && (now - statsCacheTime) < CACHE_DURATION) {
    console.log('üì¶ Usando stats desde cach√©');
    renderStats(statsCache);
    return;
  }
  
  try {
    const res = await fetch(`${API_URL}/admin/stats`, {
      headers: { 'Authorization': `Bearer ${adminToken}` }
    });
    
    const data = await res.json();
    
    // Guardar en cach√©
    statsCache = data;
    statsCacheTime = now;

    </script>
</body>

</html>