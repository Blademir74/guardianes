<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Centro de Mando - Guardianes Guerrero 2027</title>
    
    <!-- Bootstrap 5 CSS para profesionalismo y rapidez de desarrollo -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Chart.js para visualizaciones de datos en el dashboard -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            --primary: #2c5aa0;
            --primary-light: #3a6fb8;
            --secondary: #6c757d;
            --success: #27ae60;
            --danger: #e74c3c;
            --warning: #f39c12;
            --info: #17a2b8;
            --background: #f8f9fa;
            --card-bg: #ffffff;
            --text: #343a40;
            --text-light: #6c757d;
            --border: #dee2e6;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--background);
            color: var(--text);
        }

        /* Login Styles */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
        }

        .login-card {
            width: 100%;
            max-width: 400px;
            padding: 2rem;
            background: var(--card-bg);
            border-radius: 10px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .login-card h2 {
            color: var(--primary);
            margin-bottom: 1.5rem;
            text-align: center;
        }

        /* Dashboard Styles */
        .dashboard-header {
            background: var(--card-bg);
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
            margin-bottom: 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .dashboard-title {
            color: var(--primary);
            font-weight: 700;
            margin: 0;
        }

        .nav-tabs .nav-link {
            color: var(--text-light);
            font-weight: 600;
            border: none;
            border-bottom: 3px solid transparent;
            padding: 1rem 1.5rem;
        }

        .nav-tabs .nav-link:hover {
            border-bottom-color: var(--primary-light);
            color: var(--primary);
        }

        .nav-tabs .nav-link.active {
            color: var(--primary);
            background: none;
            border-bottom-color: var(--primary);
        }

        .tab-content {
            background: var(--card-bg);
            padding: 2rem;
            border-radius: 0 0 0.375rem 0.375rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .stat-card {
            background: var(--card-bg);
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            border-left: 4px solid var(--primary);
            transition: transform 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-3px);
        }

        .stat-card .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
        }

        .stat-card .stat-label {
            color: var(--text-light);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .survey-actions .btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
            margin-right: 0.25rem;
        }

        .modal-header {
            background-color: var(--primary);
            color: white;
        }

        .question-card {
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            background-color: #f8f9fa;
        }

        .option-item {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1050;
        }

        .data-sync-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--info);
            color: white;
            padding: 10px 15px;
            border-radius: 30px;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transform: translateY(100px);
            transition: transform 0.3s ease;
            z-index: 1000;
        }

        .data-sync-indicator.show {
            transform: translateY(0);
        }

        .health-check {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .health-check .status {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .health-check .status.healthy {
            background-color: var(--success);
        }

        .health-check .status.unhealthy {
            background-color: var(--danger);
        }
    </style>
</head>
<body>
    <!-- LOGIN SECTION -->
    <div id="login-section" class="login-container">
        <div class="login-card">
            <h2><i class="fas fa-shield-alt"></i> Centro de Mando</h2>
            <p class="text-center text-muted mb-4">Guardianes Guerrero 2027</p>
            
            <form id="login-form">
                <div class="mb-3">
                    <label for="username" class="form-label">Usuario</label>
                    <input type="text" class="form-control" id="username" value="admin" required>
                </div>
                
                <div class="mb-3">
                    <label for="password" class="form-label">Contrase帽a</label>
                    <input type="password" class="form-control" id="password" required>
                </div>
                
                <button type="submit" class="btn btn-primary w-100">
                    <i class="fas fa-sign-in-alt"></i> Ingresar al Panel
                </button>
                
                <div id="login-message" class="alert mt-3" role="alert" style="display: none;"></div>
            </form>
        </div>
    </div>

    <!-- DASHBOARD SECTION -->
    <div id="dashboard-section" class="container-fluid" style="display: none;">
        <div class="dashboard-header">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h1 class="dashboard-title"><i class="fas fa-chart-line"></i> Centro de Mando Estrat茅gico</h1>
                </div>
                <div class="col-md-6 text-end">
                    <span id="admin-welcome" class="me-3"></span>
                    <button id="btn-logout" class="btn btn-outline-danger">
                        <i class="fas fa-sign-out-alt"></i> Cerrar Sesi贸n
                    </button>
                </div>
            </div>
        </div>

        <!-- TABS NAVIGATION -->
        <ul class="nav nav-tabs" id="dashboard-tabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" data-bs-target="#dashboard" type="button" role="tab">
                    <i class="fas fa-tachometer-alt"></i> Dashboard
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="surveys-tab" data-bs-toggle="tab" data-bs-target="#surveys" type="button" role="tab">
                    <i class="fas fa-poll"></i> Encuestas
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="system-tab" data-bs-toggle="tab" data-bs-target="#system" type="button" role="tab">
                    <i class="fas fa-cogs"></i> Sistema
                </button>
            </li>
        </ul>

        <!-- TABS CONTENT -->
        <div class="tab-content" id="dashboard-tabs-content">
            <!-- DASHBOARD TAB -->
            <div class="tab-pane fade show active" id="dashboard" role="tabpanel">
                <div class="row mb-4">
                    <div class="col-md-3 mb-3">
                        <div class="stat-card">
                            <div class="stat-number" id="stat-total-users">-</div>
                            <div class="stat-label">Usuarios Registrados</div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="stat-card">
                            <div class="stat-number" id="stat-active-surveys">-</div>
                            <div class="stat-label">Encuestas Activas</div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="stat-card">
                            <div class="stat-number" id="stat-total-responses">-</div>
                            <div class="stat-label">Respuestas Totales</div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="stat-card">
                            <div class="stat-number" id="stat-recent-incidents">-</div>
                            <div class="stat-label">Incidentes Recientes</div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">Actividad de Respuestas (ltimos 7 d铆as)</h5>
                            </div>
                            <div class="card-body">
                                <canvas id="activity-chart" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">Incidentes por Tipo</h5>
                            </div>
                            <div class="card-body">
                                <canvas id="incidents-chart" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SURVEYS TAB -->
            <div class="tab-pane fade" id="surveys" role="tabpanel">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3>Gesti贸n de Encuestas</h3>
                    <button class="btn btn-success" onclick="showCreateSurveyModal()">
                        <i class="fas fa-plus"></i> Nueva Encuesta
                    </button>
                </div>
                
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>T铆tulo</th>
                                <th>Tipo</th>
                                <th>Estado</th>
                                <th>Respuestas</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="surveys-table-body">
                            <tr>
                                <td colspan="6" class="text-center">
                                    <div class="spinner-border spinner-border-sm" role="status"></div>
                                    <span class="ms-2">Cargando encuestas...</span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- SYSTEM TAB -->
            <div class="tab-pane fade" id="system" role="tabpanel">
                <h3>Estado del Sistema</h3>
                
                <div class="row mt-4">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">Conexiones Cr铆ticas</h5>
                            </div>
                            <div class="card-body">
                                <div class="health-check mb-3">
                                    <div class="status" id="api-status"></div>
                                    <span>API Principal</span>
                                </div>
                                <div class="health-check mb-3">
                                    <div class="status" id="db-status"></div>
                                    <span>Base de Datos</span>
                                </div>
                                <div class="health-check">
                                    <div class="status" id="sms-status"></div>
                                    <span>Servicio SMS (Twilio)</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">Informaci贸n del Sistema</h5>
                            </div>
                            <div class="card-body">
                                <p><strong>Versi贸n:</strong> <span id="system-version">-</span></p>
                                <p><strong>Entorno:</strong> <span id="system-env">-</span></p>
                                <p><strong>Uptime:</strong> <span id="system-uptime">-</span></p>
                                <p><strong>Memoria:</strong> <span id="system-memory">-</span></p>
                                <p><strong>ltima Actualizaci贸n:</strong> <span id="last-update">-</span></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- CREATE/EDIT SURVEY MODAL -->
    <div class="modal fade" id="survey-modal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="survey-modal-title">Nueva Encuesta</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="survey-form">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="survey-title" class="form-label">T铆tulo *</label>
                                <input type="text" class="form-control" id="survey-title" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="survey-election-type" class="form-label">Tipo de Elecci贸n</label>
                                <select class="form-select" id="survey-election-type">
                                    <option value="gubernatura">Gubernatura</option>
                                    <option value="ayuntamiento">Ayuntamiento</option>
                                    <option value="diputacion_local">Diputaci贸n Local</option>
                                    <option value="diputacion_federal">Diputaci贸n Federal</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="survey-description" class="form-label">Descripci贸n</label>
                            <textarea class="form-control" id="survey-description" rows="3"></textarea>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="survey-start-date" class="form-label">Fecha Inicio</label>
                                <input type="datetime-local" class="form-control" id="survey-start-date">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="survey-end-date" class="form-label">Fecha Fin (Opcional)</label>
                                <input type="datetime-local" class="form-control" id="survey-end-date">
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="survey-is-public" checked>
                                    <label class="form-check-label" for="survey-is-public">
                                        Encuesta P煤blica
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="survey-allow-anonymous" checked>
                                    <label class="form-check-label" for="survey-allow-anonymous">
                                        Permitir An贸nimos
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="survey-max-responses" class="form-label">Respuestas por Usuario</label>
                                <input type="number" class="form-control" id="survey-max-responses" value="1" min="1">
                            </div>
                        </div>
                        
                        <hr>
                        
                        <h5>Preguntas</h5>
                        <div id="questions-container"></div>
                        
                        <button type="button" onclick="addQuestion()" class="btn btn-outline-primary mt-3">
                            <i class="fas fa-plus"></i> Agregar Pregunta
                        </button>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" onclick="saveSurvey()" class="btn btn-success">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- VIEW RESULTS MODAL -->
    <div class="modal fade" id="results-modal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Resultados de Encuesta</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="survey-results-content">
                        <div class="text-center p-4">
                            <div class="spinner-border" role="status"></div>
                            <p class="mt-2">Cargando resultados...</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="exportSurveyResults()">
                        <i class="fas fa-download"></i> Exportar CSV
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- DATA SYNC INDICATOR -->
    <div id="data-sync-indicator" class="data-sync-indicator">
        <i class="fas fa-sync-alt fa-spin"></i>
        <span>Sincronizando datos...</span>
    </div>

    <!-- Bootstrap 5 JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // ========================================
        // CONFIGURACIN GLOBAL Y ESTADO
        // ========================================
        const API_BASE = window.location.hostname === 'localhost'
            ? 'http://localhost:3000/api'
            : `${window.location.protocol}//${window.location.host}/api`;

        let adminToken = localStorage.getItem('adminToken');
        let currentAdmin = null;
        let questionCounter = 0;
        let editingSurveyId = null;
        let currentSurveyId = null;
        let activityChart = null;
        let incidentsChart = null;
        let syncInterval = null;

        console.log(' Centro de Mando iniciado, API_BASE:', API_BASE);

        // ========================================
        // INICIALIZACIN
        // ========================================
        document.addEventListener('DOMContentLoaded', function() {
            // Verificar si ya hay una sesi贸n activa
            if (adminToken) {
                showDashboard();
            }

            // Registrar event listeners
            setupEventListeners();
        });

        function setupEventListeners() {
            // Login form
            document.getElementById('login-form').addEventListener('submit', handleLogin);
            
            // Logout button
            document.getElementById('btn-logout').addEventListener('click', handleLogout);
            
            // Survey form
            document.getElementById('survey-form').addEventListener('submit', function(e) {
                e.preventDefault();
                saveSurvey();
            });
        }

        // ========================================
        // AUTENTICACIN
        // ========================================
        async function handleLogin(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            if (!username || !password) {
                showMessage('login-message', 'Por favor completa todos los campos', 'danger');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/admin/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    adminToken = data.token;
                    currentAdmin = data.admin;
                    localStorage.setItem('adminToken', adminToken);
                    
                    showMessage('login-message', 'Acceso concedido', 'success');
                    
                    setTimeout(() => {
                        showDashboard();
                    }, 1000);
                } else {
                    showMessage('login-message', data.error || 'Credenciales incorrectas', 'danger');
                }
            } catch (error) {
                console.error('Error de login:', error);
                showMessage('login-message', 'Error de conexi贸n', 'danger');
            }
        }

        function handleLogout() {
            if (confirm('驴Est谩s seguro de que deseas cerrar sesi贸n?')) {
                localStorage.removeItem('adminToken');
                adminToken = null;
                currentAdmin = null;
                
                // Limpiar intervalo de sincronizaci贸n
                if (syncInterval) {
                    clearInterval(syncInterval);
                    syncInterval = null;
                }
                
                document.getElementById('dashboard-section').style.display = 'none';
                document.getElementById('login-section').style.display = 'flex';
                document.getElementById('password').value = '';
            }
        }

        function showDashboard() {
            document.getElementById('login-section').style.display = 'none';
            document.getElementById('dashboard-section').style.display = 'block';
            
            if (currentAdmin) {
                document.getElementById('admin-welcome').textContent = `Bienvenido, ${currentAdmin.username}`;
            }
            
            // Cargar datos iniciales
            loadDashboardData();
            loadSurveys();
            checkSystemHealth();
            
            // Configurar actualizaci贸n autom谩tica cada 30 segundos
            syncInterval = setInterval(() => {
                loadDashboardData();
                loadSurveys();
            }, 30000);
        }

        // ========================================
        // FUNCIONES DE API
        // ========================================
        async function apiRequest(url, options = {}) {
            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${adminToken}`
                }
            };
            
            const finalOptions = { ...defaultOptions, ...options };
            
            try {
                const response = await fetch(`${API_BASE}${url}`, finalOptions);
                
                if (response.status === 401) {
                    handleLogout();
                    return { error: 'Sesi贸n expirada' };
                }
                
                return await response.json();
            } catch (error) {
                console.error('Error en API:', error);
                return { error: error.message };
            }
        }

        function showSyncIndicator() {
            document.getElementById('data-sync-indicator').classList.add('show');
        }

        function hideSyncIndicator() {
            document.getElementById('data-sync-indicator').classList.remove('show');
        }

        // ========================================
        // DASHBOARD
        // ========================================
        async function loadDashboardData() {
            showSyncIndicator();
            
            try {
                // Cargar estad铆sticas
                const stats = await apiRequest('/admin/stats');
                if (stats.success) {
                    document.getElementById('stat-total-users').textContent = stats.data.totalUsers || 0;
                    document.getElementById('stat-active-surveys').textContent = stats.data.activeSurveys || 0;
                    document.getElementById('stat-total-responses').textContent = stats.data.totalResponses || 0;
                    document.getElementById('stat-recent-incidents').textContent = stats.data.recentIncidents || 0;
                    
                    // Actualizar 煤ltima fecha de actualizaci贸n
                    document.getElementById('last-update').textContent = new Date().toLocaleString();
                }
                
                // Cargar datos para gr谩ficos
                await loadActivityChart();
                await loadIncidentsChart();
                
            } catch (error) {
                console.error('Error cargando datos del dashboard:', error);
            } finally {
                hideSyncIndicator();
            }
        }

        async function loadActivityChart() {
            try {
                const data = await apiRequest('/admin/activity-chart');
                
                if (data.success && data.labels && data.values) {
                    const ctx = document.getElementById('activity-chart').getContext('2d');
                    
                    if (activityChart) {
                        activityChart.destroy();
                    }
                    
                    activityChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: data.labels,
                            datasets: [{
                                label: 'Respuestas',
                                data: data.values,
                                backgroundColor: 'rgba(44, 90, 160, 0.2)',
                                borderColor: 'rgba(44, 90, 160, 1)',
                                borderWidth: 2,
                                tension: 0.4,
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('Error cargando gr谩fico de actividad:', error);
            }
        }

        async function loadIncidentsChart() {
            try {
                const data = await apiRequest('/admin/incidents-chart');
                
                if (data.success && data.labels && data.values) {
                    const ctx = document.getElementById('incidents-chart').getContext('2d');
                    
                    if (incidentsChart) {
                        incidentsChart.destroy();
                    }
                    
                    incidentsChart = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: data.labels,
                            datasets: [{
                                data: data.values,
                                backgroundColor: [
                                    '#FF6384',
                                    '#36A2EB',
                                    '#FFCE56',
                                    '#4BC0C0',
                                    '#9966FF'
                                ]
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false
                        }
                    });
                }
            } catch (error) {
                console.error('Error cargando gr谩fico de incidentes:', error);
            }
        }

        // ========================================
        // ENCUESTAS
        // ========================================
        async function loadSurveys() {
            try {
                const data = await apiRequest('/surveys/admin');
                
                if (data.success) {
                    renderSurveysTable(data.surveys);
                } else {
                    console.error('Error cargando encuestas:', data.error);
                }
            } catch (error) {
                console.error('Error cargando encuestas:', error);
            }
        }

        function renderSurveysTable(surveys) {
            const tbody = document.getElementById('surveys-table-body');
            
            if (!surveys || surveys.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center">No hay encuestas disponibles</td></tr>';
                return;
            }
            
            let html = '';
            surveys.forEach(survey => {
                const statusBadge = survey.is_active 
                    ? '<span class="badge bg-success">Activa</span>'
                    : '<span class="badge bg-secondary">Inactiva</span>';
                
                html += `
                    <tr>
                        <td>${survey.id}</td>
                        <td><strong>${survey.title}</strong></td>
                        <td>${survey.election_type || 'N/A'}</td>
                        <td>${statusBadge}</td>
                        <td>${survey.total_responses || 0}</td>
                        <td class="survey-actions">
                            <button class="btn btn-sm btn-info" onclick="viewSurveyResults(${survey.id})" title="Ver Resultados">
                                <i class="fas fa-chart-bar"></i>
                            </button>
                            <button class="btn btn-sm btn-warning" onclick="toggleSurvey(${survey.id})" title="Activar/Desactivar">
                                <i class="fas fa-${survey.is_active ? 'pause' : 'play'}"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteSurvey(${survey.id}, '${survey.title.replace(/'/g, "\\'")}')" title="Eliminar">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }

        function showCreateSurveyModal() {
            editingSurveyId = null;
            questionCounter = 0;
            
            document.getElementById('survey-form').reset();
            document.getElementById('survey-modal-title').textContent = 'Nueva Encuesta';
            document.getElementById('questions-container').innerHTML = '';
            
            // Establecer fecha de inicio por defecto
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            document.getElementById('survey-start-date').value = now.toISOString().slice(0, 16);
            
            // Agregar una pregunta por defecto
            addQuestion();
            
            const modal = new bootstrap.Modal(document.getElementById('survey-modal'));
            modal.show();
        }

        function addQuestion() {
            questionCounter++;
            const container = document.getElementById('questions-container');
            
            const questionDiv = document.createElement('div');
            questionDiv.className = 'question-card';
            questionDiv.dataset.questionId = questionCounter;
            
            questionDiv.innerHTML = `
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5>Pregunta #${questionCounter}</h5>
                    <button type="button" class="btn btn-sm btn-danger" onclick="removeQuestion(${questionCounter})">
                        <i class="fas fa-trash"></i> Eliminar
                    </button>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Texto de la Pregunta *</label>
                    <input type="text" class="form-control question-text" required placeholder="驴Qui茅n crees que ganar谩?">
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Tipo de Pregunta</label>
                    <select class="form-select question-type" onchange="updateQuestionType(${questionCounter})">
                        <option value="single_choice">Opci贸n nica</option>
                        <option value="multiple_choice">Opci贸n M煤ltiple</option>
                        <option value="text">Texto Libre</option>
                    </select>
                </div>
                
                <div class="question-options-container">
                    <label class="form-label">Opciones</label>
                    <div class="options-list">
                        <div class="option-item">
                            <input type="text" class="form-control option-value" placeholder="Opci贸n 1">
                            <button type="button" class="btn btn-sm btn-danger mt-1" onclick="removeOption(this)">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-primary mt-2" onclick="addOption(${questionCounter})">
                        <i class="fas fa-plus"></i> Agregar Opci贸n
                    </button>
                </div>
                
                <div class="form-check mt-3">
                    <input class="form-check-input question-required" type="checkbox" id="required-${questionCounter}" checked>
                    <label class="form-check-label" for="required-${questionCounter}">
                        Pregunta Obligatoria
                    </label>
                </div>
            `;
            
            container.appendChild(questionDiv);
        }

        function removeQuestion(questionId) {
            if (confirm('驴Eliminar esta pregunta?')) {
                const questionDiv = document.querySelector(`[data-question-id="${questionId}"]`);
                if (questionDiv) {
                    questionDiv.remove();
                }
            }
        }

        function updateQuestionType(questionId) {
            const questionDiv = document.querySelector(`[data-question-id="${questionId}"]`);
            const type = questionDiv.querySelector('.question-type').value;
            const optionsContainer = questionDiv.querySelector('.question-options-container');
            
            optionsContainer.style.display = (type === 'single_choice' || type === 'multiple_choice') ? 'block' : 'none';
        }

        function addOption(questionId) {
            const questionDiv = document.querySelector(`[data-question-id="${questionId}"]`);
            const optionsList = questionDiv.querySelector('.options-list');
            const currentOptions = optionsList.children.length;
            
            const optionDiv = document.createElement('div');
            optionDiv.className = 'option-item';
            optionDiv.innerHTML = `
                <input type="text" class="form-control option-value" placeholder="Opci贸n ${currentOptions + 1}">
                <button type="button" class="btn btn-sm btn-danger mt-1" onclick="removeOption(this)">
                    <i class="fas fa-trash"></i>
                </button>
            `;
            
            optionsList.appendChild(optionDiv);
        }

        function removeOption(button) {
            if (confirm('驴Eliminar esta opci贸n?')) {
                button.parentElement.remove();
            }
        }

        async function saveSurvey() {
            const surveyData = {
                title: document.getElementById('survey-title').value,
                description: document.getElementById('survey-description').value || null,
                electionType: document.getElementById('survey-election-type').value,
                startDate: document.getElementById('survey-start-date').value,
                endDate: document.getElementById('survey-end-date').value || null,
                isPublic: document.getElementById('survey-is-public').checked,
                allowAnonymous: document.getElementById('survey-allow-anonymous').checked,
                maxResponsesPerUser: parseInt(document.getElementById('survey-max-responses').value) || 1,
                questions: []
            };
            
            // Recopilar preguntas
            document.querySelectorAll('.question-card').forEach((qDiv, index) => {
                const questionText = qDiv.querySelector('.question-text').value.trim();
                if (!questionText) return;
                
                const questionType = qDiv.querySelector('.question-type').value;
                const isRequired = qDiv.querySelector('.question-required').checked;
                
                const question = {
                    questionText,
                    questionType,
                    isRequired,
                    options: null
                };
                
                if (questionType === 'single_choice' || questionType === 'multiple_choice') {
                    const optionInputs = qDiv.querySelectorAll('.option-value');
                    question.options = Array.from(optionInputs)
                        .map(input => input.value.trim())
                        .filter(val => val.length > 0);
                }
                
                surveyData.questions.push(question);
            });
            
            if (surveyData.questions.length === 0) {
                alert('Debes agregar al menos una pregunta v谩lida');
                return;
            }
            
            try {
                const url = editingSurveyId 
                    ? `/surveys/admin/${editingSurveyId}`
                    : '/surveys/admin';
                
                const method = editingSurveyId ? 'PUT' : 'POST';
                
                const data = await apiRequest(url, {
                    method,
                    body: JSON.stringify(surveyData)
                });
                
                if (data.success) {
                    alert('Encuesta guardada exitosamente');
                    bootstrap.Modal.getInstance(document.getElementById('survey-modal')).hide();
                    loadSurveys();
                } else {
                    alert('Error: ' + (data.error || 'Error desconocido'));
                }
            } catch (error) {
                console.error('Error guardando encuesta:', error);
                alert('Error de conexi贸n: ' + error.message);
            }
        }

        async function toggleSurvey(id) {
            try {
                const data = await apiRequest(`/surveys/admin/${id}/toggle`, {
                    method: 'PATCH'
                });
                
                if (data.success) {
                    alert(data.message);
                    loadSurveys();
                } else {
                    alert('Error: ' + (data.error || 'Error desconocido'));
                }
            } catch (error) {
                console.error('Error cambiando estado de encuesta:', error);
                alert('Error de conexi贸n');
            }
        }

        async function deleteSurvey(id, title) {
            if (!confirm(`驴Eliminar encuesta "${title}"?\n\nEsto eliminar谩 tambi茅n todas las respuestas.`)) {
                return;
            }
            
            try {
                const data = await apiRequest(`/surveys/admin/${id}`, {
                    method: 'DELETE'
                });
                
                if (data.success) {
                    alert(data.message);
                    loadSurveys();
                } else {
                    alert('Error: ' + (data.error || 'Error desconocido'));
                }
            } catch (error) {
                console.error('Error eliminando encuesta:', error);
                alert('Error de conexi贸n');
            }
        }

        async function viewSurveyResults(id) {
            currentSurveyId = id;
            
            const modal = new bootstrap.Modal(document.getElementById('results-modal'));
            modal.show();
            
            try {
                const data = await apiRequest(`/surveys/${id}/results`);
                
                if (data.success) {
                    renderSurveyResults(data);
                } else {
                    document.getElementById('survey-results-content').innerHTML = 
                        `<div class="alert alert-danger">Error: ${data.error}</div>`;
                }
            } catch (error) {
                console.error('Error cargando resultados:', error);
                document.getElementById('survey-results-content').innerHTML = 
                    `<div class="alert alert-danger">Error de conexi贸n: ${error.message}</div>`;
            }
        }

        function renderSurveyResults(data) {
            let html = `<h4>${data.surveyTitle}</h4>`;
            
            if (!data.results || data.results.length === 0) {
                html += '<p>No hay resultados disponibles para esta encuesta.</p>';
            } else {
                data.results.forEach(result => {
                    html += `<div class="mb-4"><h5>${result.questionText}</h5>`;
                    
                    if (result.responses && result.responses.length > 0) {
                        const total = result.responses.reduce((sum, r) => sum + r.count, 0);
                        
                        result.responses.forEach(r => {
                            const pct = total > 0 ? ((r.count / total) * 100).toFixed(1) : 0;
                            html += `
                                <div class="mb-2">
                                    <div class="d-flex justify-content-between">
                                        <span>${r.value}</span>
                                        <span>${pct}% (${r.count})</span>
                                    </div>
                                    <div class="progress" style="height: 8px;">
                                        <div class="progress-bar" role="progressbar" style="width: ${pct}%" aria-valuenow="${pct}" aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>
                                </div>
                            `;
                        });
                    }
                    
                    html += '</div>';
                });
            }
            
            document.getElementById('survey-results-content').innerHTML = html;
        }

        async function exportSurveyResults() {
            if (!currentSurveyId) return;
            
            try {
                const response = await fetch(`${API_BASE}/surveys/admin/${currentSurveyId}/export`, {
                    headers: { 'Authorization': `Bearer ${adminToken}` }
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `encuesta_${currentSurveyId}_${Date.now()}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } else {
                    const data = await response.json();
                    alert('Error: ' + (data.error || 'Error desconocido'));
                }
            } catch (error) {
                console.error('Error exportando resultados:', error);
                alert('Error de conexi贸n: ' + error.message);
            }
        }

        // ========================================
        // SISTEMA
        // ========================================
        async function checkSystemHealth() {
            try {
                const data = await apiRequest('/health');
                
                if (data.success) {
                    document.getElementById('api-status').className = 'status healthy';
                    document.getElementById('db-status').className = 'status healthy';
                    document.getElementById('sms-status').className = 'status healthy';
                    
                    document.getElementById('system-version').textContent = data.version || 'N/A';
                    document.getElementById('system-env').textContent = data.environment || 'N/A';
                    document.getElementById('system-uptime').textContent = data.uptime ? `${Math.floor(data.uptime / 60)} min` : 'N/A';
                    document.getElementById('system-memory').textContent = data.memory || 'N/A';
                } else {
                    document.getElementById('api-status').className = 'status unhealthy';
                    document.getElementById('db-status').className = 'status unhealthy';
                    document.getElementById('sms-status').className = 'status unhealthy';
                }
            } catch (error) {
                console.error('Error verificando salud del sistema:', error);
                document.getElementById('api-status').className = 'status unhealthy';
                document.getElementById('db-status').className = 'status unhealthy';
                document.getElementById('sms-status').className = 'status unhealthy';
            }
        }

        // ========================================
        // UTILIDADES
        // ========================================
        function showMessage(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `alert alert-${type}`;
            element.style.display = 'block';
            
            setTimeout(() => {
                element.style.display = 'none';
            }, 5000);
        }
    </script>
</body>
</html>