<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Portal Ciudadano | Guerrero Guardianes</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body {
            font-family: 'Outfit', sans-serif;
        }

        .glass {
            background: white;
            backdrop-filter: blur(10px);
        }

        .nav-item.active {
            background-color: #EEF2FF;
            color: #4F46E5;
            border-right: 3px solid #4F46E5;
        }
    </style>
</head>

<body class="bg-slate-50 text-slate-900 flex h-screen overflow-hidden">

    <!-- Sidebar -->
    <aside class="w-64 bg-white border-r border-slate-200 hidden md:flex flex-col">
        <div class="p-6 border-b border-slate-100">
            <div class="flex items-center space-x-3">
                <div class="w-8 h-8 bg-indigo-600 rounded flex items-center justify-center text-white font-bold">G</div>
                <span class="font-bold text-lg">Guardianes</span>
            </div>
        </div>

        <nav class="flex-1 overflow-y-auto py-4">
            <a href="#" class="nav-item active flex items-center px-6 py-3 text-slate-600 hover:bg-slate-50 transition"
                onclick="showSection('dashboard', this)">
                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z">
                    </path>
                </svg>
                Dashboard
            </a>
            <a href="#" class="nav-item flex items-center px-6 py-3 text-slate-600 hover:bg-slate-50 transition"
                onclick="showSection('surveys', this)">
                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2">
                    </path>
                </svg>
                Encuestas
            </a>
            <a href="#" class="nav-item flex items-center px-6 py-3 text-slate-600 hover:bg-slate-50 transition"
                onclick="showSection('leaderboard', this)">
                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                </svg>
                Ranking
            </a>
            <a href="#" class="nav-item flex items-center px-6 py-3 text-slate-600 hover:bg-slate-50 transition"
                onclick="showSection('historical', this)">
                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z">
                    </path>
                </svg>
                Hist√≥rico 2018-24
            </a>
            <a href="#" class="nav-item flex items-center px-6 py-3 text-slate-600 hover:bg-slate-50 transition"
                onclick="showSection('incidents', this)">
                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z">
                    </path>
                </svg>
                Reportar Incidente
            </a>
            <a href="#" class="nav-item flex items-center px-6 py-3 text-slate-600 hover:bg-slate-50 transition"
                onclick="showSection('profile', this)">
                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                </svg>
                Mi Perfil
            </a>
        </nav>

        <div class="p-6 border-t border-slate-200">
            <button onclick="logout()"
                class="flex items-center text-slate-500 hover:text-red-600 transition text-sm font-medium">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1">
                    </path>
                </svg>
                Cerrar Sesi√≥n
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto bg-slate-50 relative">
        <!-- Topbar Mobile -->
        <header
            class="bg-white border-b border-slate-200 p-4 md:hidden flex justify-between items-center sticky top-0 z-20">
            <div class="font-bold text-lg text-indigo-600">Guardianes</div>
            <button onclick="document.querySelector('aside').classList.toggle('hidden');" class="text-slate-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16">
                    </path>
                </svg>
            </button>
        </header>

        <div class="max-w-5xl mx-auto p-8 space-y-8" id="contentArea">
            <!-- Header Welcome -->
            <div class="flex justify-between items-end">
                <div>
                    <h1 class="text-3xl font-bold text-slate-900">Hola, <span id="userPhone"
                            class="text-indigo-600">Ciudadano</span></h1>
                    <p class="text-slate-500 mt-1">Gracias por ser parte de la vigilancia democr√°tica.</p>
                </div>
                <div
                    class="bg-white px-6 py-3 rounded-2xl shadow-sm border border-slate-100 flex items-center space-x-4">
                    <div class="text-right">
                        <div class="text-xs text-slate-400 font-bold uppercase tracking-wider">Tus Puntos</div>
                        <div class="text-2xl font-bold text-indigo-600" id="userPoints">0</div>
                    </div>
                    <div class="w-10 h-10 bg-indigo-100 rounded-full flex items-center justify-center text-xl">üèÜ</div>
                </div>
            </div>

            <!-- Dashboard Section -->
            <section id="dashboard" class="space-y-8 animate-fade-in">
                <!-- Stats Grid -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-gradient-to-br from-indigo-500 to-purple-600 rounded-2xl p-6 text-white shadow-lg">
                        <div class="text-indigo-100 text-sm font-medium mb-1">Nivel Actual</div>
                        <div class="text-3xl font-bold mb-4" id="userLevel">Vigilante Novato</div>
                        <div class="w-full bg-white/20 rounded-full h-2">
                            <div class="bg-white h-2 rounded-full" style="width: 45%"></div>
                        </div>
                        <div class="mt-2 text-xs text-indigo-100 text-right">450 / 1000 XP</div>
                    </div>

                    <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-100">
                        <div class="text-slate-500 text-sm font-medium mb-1">Encuestas Completadas</div>
                        <div class="text-3xl font-bold text-slate-800" id="surveysCount">0</div>
                        <button onclick="showSection('surveys')"
                            class="mt-4 text-sm text-indigo-600 font-bold hover:underline">Ver Disponibles ‚Üí</button>
                    </div>

                    <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-100">
                        <div class="text-slate-500 text-sm font-medium mb-1">Tu Ranking Global</div>
                        <div class="text-3xl font-bold text-slate-800">#<span id="userRank">--</span></div>
                        <p class="text-xs text-green-600 mt-2 font-medium">Top 20% mejores vigilantes</p>
                    </div>
                </div>

                <!-- Active Surveys Preview -->
                <div>
                    <h3 class="text-xl font-bold text-slate-800 mb-4">Encuestas Prioritarias</h3>
                    <div class="grid md:grid-cols-2 gap-6" id="activeSurveysPreview">
                        <div class="animate-pulse bg-slate-200 h-40 rounded-2xl"></div>
                        <div class="animate-pulse bg-slate-200 h-40 rounded-2xl"></div>
                    </div>
                </div>
            </section>

            <!-- Surveys Section (Hidden by default) -->
            <section id="surveys" class="hidden space-y-6">
                <h2 class="text-2xl font-bold text-slate-900">Encuestas Disponibles</h2>
                <div id="allSurveysContainer" class="grid gap-6">
                    <!-- Surveys loaded here -->
                </div>
            </section>

            <!-- Leaderboard Section (Hidden) -->
            <section id="leaderboard" class="hidden space-y-6">
                <h2 class="text-2xl font-bold text-slate-900">Tabla de L√≠deres</h2>
                <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                    <table class="w-full">
                        <thead class="bg-slate-50 text-slate-500 text-xs font-bold uppercase tracking-wider text-left">
                            <tr>
                                <th class="px-6 py-4">Posici√≥n</th>
                                <th class="px-6 py-4">Usuario (An√≥nimo)</th>
                                <th class="px-6 py-4">Nivel</th>
                                <th class="px-6 py-4 text-right">Puntos</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100" id="leaderboardTable">
                            <!-- Rows loaded via JS -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- SECTION: HISTORICAL (New) -->
            <section id="historical" class="hidden animate-fade-in space-y-6">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-slate-800">Resultados Hist√≥ricos (2018-2024)</h2>
                        <select id="hist-municipio-select" onchange="loadHistoricalStats()"
                            class="px-4 py-2 border border-slate-300 rounded-lg outline-none focus:ring-2 focus:ring-indigo-500">
                            <option value="">Selecciona un Municipio</option>
                            <!-- Populated by JS -->
                        </select>
                    </div>

                    <div id="hist-content" class="hidden">
                        <!-- Comparison Table -->
                        <div class="overflow-x-auto mb-8">
                            <h3 class="text-lg font-bold text-slate-700 mb-4">Comparativa de Participaci√≥n</h3>
                            <table class="w-full text-left border-collapse">
                                <thead class="bg-indigo-50 text-indigo-900">
                                    <tr>
                                        <th class="p-3 rounded-l-lg">Elecci√≥n</th>
                                        <th class="p-3">2024</th>
                                        <th class="p-3">2021</th>
                                        <th class="p-3 rounded-r-lg">2018</th>
                                    </tr>
                                </thead>
                                <tbody id="hist-table-body" class="text-slate-600">
                                    <!-- Dynamic rows -->
                                </tbody>
                            </table>
                        </div>

                        <!-- Charts -->
                        <div class="grid md:grid-cols-2 gap-8">
                            <div>
                                <h3 class="text-lg font-bold text-slate-700 mb-4">Tendencia de Participaci√≥n</h3>
                                <canvas id="histParticipationChart"></canvas>
                            </div>
                            <div>
                                <h3 class="text-lg font-bold text-slate-700 mb-4">Distribuci√≥n Hist√≥rica</h3>
                                <canvas id="histDistributionChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div id="hist-empty" class="text-center py-12 text-slate-400">
                        <p>Selecciona un municipio para ver los datos hist√≥ricos.</p>
                    </div>
                </div>
            </section>

            <!-- SECTION: INCIDENTS (New) -->
            <section id="incidents" class="hidden animate-fade-in space-y-6">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 max-w-2xl mx-auto">
                    <div class="text-center mb-8">
                        <div
                            class="w-16 h-16 bg-red-100 text-red-600 rounded-full flex items-center justify-center text-3xl mx-auto mb-4">
                            üö®</div>
                        <h2 class="text-2xl font-bold text-slate-800">Reportar Incidente Electoral</h2>
                        <p class="text-slate-500">Tu reporte es an√≥nimo y seguro. Ay√∫danos a proteger la democracia.</p>
                    </div>

                    <form onsubmit="submitIncident(event)" class="space-y-6">
                        <div>
                            <label class="block font-bold text-slate-700 mb-2">Municipio *</label>
                            <select id="inc-municipio" required
                                class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-red-500 outline-none">
                                <option value="">Selecciona donde ocurri√≥</option>
                            </select>
                        </div>

                        <div>
                            <label class="block font-bold text-slate-700 mb-2">Tipo de Incidente *</label>
                            <select id="inc-type" required
                                class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-red-500 outline-none">
                                <option value="compra_voto">üí∞ Compra de Voto</option>
                                <option value="intimidacion">‚ö†Ô∏è Intimidaci√≥n / Amenazas</option>
                                <option value="casilla_irregular">üó≥Ô∏è Casilla Irregular</option>
                                <option value="propaganda_ilegal">üö´ Propaganda en Veda</option>
                                <option value="violencia">üî¥ Violencia en Casilla</option>
                                <option value="acarreo">üöå Acarreo de Votantes</option>
                                <option value="otro">‚ùì Otro</option>
                            </select>
                        </div>

                        <div>
                            <label class="block font-bold text-slate-700 mb-2">Descripci√≥n *</label>
                            <textarea id="inc-desc" rows="4" required
                                class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-red-500 outline-none"
                                placeholder="Describe detalladamente qu√© sucedi√≥, d√≥nde y qui√©nes estuvieron involucrados..."></textarea>
                        </div>

                        <div>
                            <label class="block font-bold text-slate-700 mb-2">Evidencia Fotogr√°fica (Opcional)</label>
                            <div
                                class="border-2 border-dashed border-slate-300 rounded-xl p-8 text-center bg-slate-50 hover:bg-slate-100 cursor-pointer transition">
                                <input type="file" id="inc-photo" accept="image/*" class="hidden"
                                    onchange="previewImage(this)">
                                <label for="inc-photo" class="cursor-pointer">
                                    <span class="text-3xl block mb-2">üì∑</span>
                                    <span class="text-slate-500 font-medium">Click para subir foto</span>
                                </label>
                                <img id="inc-preview" class="hidden mt-4 mx-auto max-h-40 rounded-lg shadow-sm">
                            </div>
                        </div>

                        <div>
                            <label
                                class="flex items-center space-x-3 p-4 bg-slate-50 rounded-xl border border-slate-200 cursor-pointer">
                                <input type="checkbox" id="inc-geo"
                                    class="w-5 h-5 text-red-600 rounded focus:ring-red-500" checked>
                                <span class="text-slate-700 font-medium">Incluir ubicaci√≥n GPS (Recomendado para
                                    validaci√≥n)</span>
                            </label>
                        </div>

                        <button type="submit"
                            class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-4 rounded-xl shadow-lg hover:shadow-xl transition transform hover:-translate-y-1">
                            üì¢ Enviar Reporte (+50 Puntos)
                        </button>
                    </form>
                </div>
            </section>

            <!-- Profile Section (Simple) -->
            <section id="profile" class="hidden space-y-6">
                <h2 class="text-2xl font-bold text-slate-900">Mi Perfil</h2>
                <div class="bg-white p-8 rounded-2xl shadow-sm border border-slate-100 max-w-lg">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-600">ID de Usuario</label>
                            <div class="font-mono text-slate-900 bg-slate-50 p-3 rounded-lg border border-slate-200 mt-1 truncate"
                                id="profileId">...</div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-600">Hash de Tel√©fono</label>
                            <div class="text-xs font-mono text-slate-500 bg-slate-50 p-3 rounded-lg border border-slate-200 mt-1 break-all"
                                id="profilePhoneHash">...</div>
                            <p class="text-xs text-slate-400 mt-1">Este hash es irreversible y protege tu identidad.</p>
                        </div>
                    </div>
                </div>
            </section>

        </div>
    </main>

    <!-- Survey Modal -->
    <div id="surveyModal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-slate-900/80 backdrop-blur-sm" onclick="closeSurveyModal()"></div>
        <div class="absolute inset-0 flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col">
                <div class="p-6 border-b border-slate-100 flex justify-between items-center">
                    <h3 class="text-xl font-bold text-slate-800">Participaci√≥n Ciudadana</h3>
                    <button onclick="closeSurveyModal()" class="text-slate-400 hover:text-slate-600">‚úï</button>
                </div>
                <div class="p-8 overflow-y-auto flex-1" id="modalQuestionsContainer">
                    <!-- Questions injected here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = '';
        let currentUser = null;

        // Check Auth
        async function checkAuth() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/';
                return;
            }

            try {
                const res = await fetch('/api/auth/me', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!res.ok) throw new Error('Unauthorized');
                currentUser = await res.json();
                renderUserInfo();
                loadDashboardData();
            } catch (err) {
                localStorage.removeItem('token');
                window.location.href = '/';
            }
        }

        function renderUserInfo() {
            // Display formatted/truncated phone or ID
            document.getElementById('userPhone').innerText = 'Ciudadano'; // Keep anon in UI too?
            document.getElementById('userPoints').innerText = currentUser.points;

            // Calculate Level Mockup
            const level = Math.floor(currentUser.points / 500) + 1;
            const titles = ['Observador', 'Vigilante', 'Guardi√°n', 'Defensor', 'Maestro'];
            document.getElementById('userLevel').innerText = titles[Math.min(level - 1, 4)] + ' (Nvl ' + level + ')';

            document.getElementById('profileId').innerText = currentUser.id;
            document.getElementById('profilePhoneHash').innerText = currentUser.phone_hash;
            document.getElementById('surveysCount').innerText = currentUser.surveys_completed || 0;
        }

        async function loadDashboardData() {
            // Load Surveys
            try {
                const res = await fetch('/api/surveys/active');
                const data = await res.json();
                renderSurveys(data.surveys); // Assuming { surveys: [] }
            } catch (e) {
                console.error(e);
            }

            // Load Leaderboard
            try {
                const res = await fetch('/api/leaderboard');
                const data = await res.json();
                renderLeaderboard(data.leaderboard);
            } catch (e) {
                console.error(e);
            }
        }

        function renderSurveys(surveys) {
            const containerPreview = document.getElementById('activeSurveysPreview');
            const containerAll = document.getElementById('allSurveysContainer');

            const html = surveys.map(s => `
                <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-100 hover:shadow-md transition group">
                    <div class="flex justify-between items-start mb-4">
                        <div class="bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full text-xs font-bold uppercase">Encuesta</div>
                        <span class="text-slate-400 text-xs">Termina en 2 d√≠as</span>
                    </div>
                    <h3 class="font-bold text-lg text-slate-900 mb-2 group-hover:text-indigo-600 transition">${s.title}</h3>
                    <p class="text-slate-500 text-sm mb-6 line-clamp-2">${s.description || 'Participa y haz valer tu opini√≥n.'}</p>
                    <button onclick="takeSurvey(${s.id})" class="w-full py-3 rounded-xl border border-indigo-600 text-indigo-600 font-bold hover:bg-indigo-600 hover:text-white transition">Participar (+50 pts)</button>
                </div>
            `).join('');

            containerPreview.innerHTML = html || '<div class="text-slate-500">No hay encuestas activas.</div>';
            containerAll.innerHTML = html || '<div class="text-slate-500">No hay encuestas activas.</div>';
        }

        function renderLeaderboard(users) {
            const tbody = document.getElementById('leaderboardTable');
            const html = users.slice(0, 10).map((u, i) => `
                <tr class="hover:bg-slate-50 transition">
                    <td class="px-6 py-4 font-bold text-slate-400">#${i + 1}</td>
                    <td class="px-6 py-4 font-mono text-sm text-slate-600">${u.phone_hash.substring(0, 8)}...</td>
                    <td class="px-6 py-4">
                        <span class="bg-indigo-100 text-indigo-700 px-2 py-1 rounded text-xs font-bold">Nvl ${Math.floor(u.points / 500) + 1}</span>
                    </td>
                    <td class="px-6 py-4 text-right font-bold text-slate-900">${u.points} pts</td>
                </tr>
            `).join('');
            tbody.innerHTML = html;

            // Find my rank
            const myRank = users.findIndex(u => u.id === currentUser.id);
            if (myRank !== -1) document.getElementById('userRank').innerText = myRank + 1;
        }

        // ... previous code ...

        // Survey Modal Logic
        let currentSurveyId = null;

        async function takeSurvey(id) {
            currentSurveyId = id;
            const modal = document.getElementById('surveyModal');
            const container = document.getElementById('modalQuestionsContainer');

            modal.classList.remove('hidden');
            container.innerHTML = '<div class="text-center py-8"><div class="animate-spin rounded-full h-10 w-10 border-b-2 border-indigo-600 mx-auto"></div></div>';

            try {
                const res = await fetch(`/api/surveys/${id}/questions`);
                const data = await res.json();
                renderModalQuestions(data.questions);
            } catch (e) {
                container.innerHTML = '<p class="text-red-500 text-center">Error cargando preguntas.</p>';
            }
        }

        function closeSurveyModal() {
            document.getElementById('surveyModal').classList.add('hidden');
            currentSurveyId = null;
        }

        function renderModalQuestions(questions) {
            const container = document.getElementById('modalQuestionsContainer');

            if (!questions || questions.length === 0) {
                container.innerHTML = '<p class="text-slate-500 text-center">Esta encuesta no tiene preguntas disponibles.</p>';
                return;
            }

            container.innerHTML = questions.map((q, idx) => `
                <div class="mb-8 p-4 bg-slate-50 rounded-xl border border-slate-200">
                    <h4 class="font-bold text-lg text-slate-800 mb-4">${idx + 1}. ${q.question_text || q.questionText}</h4>
                    
                    ${renderQuestionInput(q, idx)}
                </div>
            `).join('') + `
                <button onclick="submitSurveyResponse()" class="w-full bg-indigo-600 text-white font-bold py-4 rounded-xl shadow-lg hover:bg-indigo-700 transition">
                    Enviar Respuestas y Ganar Puntos üöÄ
                </button>
            `;
        }

        function renderQuestionInput(q, idx) {
            const type = q.question_type || q.questionType;
            if (type === 'confidence_scale' || type === 'scale') {
                return `
                    <div class="px-4">
                        <input type="range" min="0" max="100" value="50" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-indigo-600 survey-input" data-qid="${q.id}" data-type="scale" oninput="this.nextElementSibling.innerText = this.value + '%'">
                        <div class="text-center font-bold text-indigo-600 mt-2">50%</div>
                    </div>
                `;
            } else if (type === 'single_choice') {
                // Mock options if not provided in DB schema appropriately yet, or assuming 'options' JSONB
                const options = q.options?.choices || q.options || ['Opci√≥n A', 'Opci√≥n B'];
                // Adjust based on actual API response structure for options
                // For MVP candidates, let's assume we fetch candidates if it's that type, but for now generic:
                return `
                    <div class="space-y-2">
                        ${Array.isArray(options) ? options.map(opt => `
                            <label class="flex items-center space-x-3 p-3 bg-white rounded-lg border border-slate-200 cursor-pointer hover:border-indigo-300">
                                <input type="radio" name="q_${q.id}" value="${opt}" class="form-radio text-indigo-600 survey-input" data-qid="${q.id}" data-type="radio">
                                <span class="text-slate-700">${opt}</span>
                            </label>
                        `).join('') : '<p class="text-xs text-red-400">Sin opciones configuradas</p>'}
                    </div>
                `;
            }
            return '<p class="text-xs text-gray-500">Tipo de pregunta no soportado visualmente.</p>';
        }

        async function submitSurveyResponse() {
            // Collect answers
            const inputs = document.querySelectorAll('.survey-input');
            const responses = [];
            const processedQids = new Set();

            inputs.forEach(input => {
                if (processedQids.has(input.dataset.qid)) return;

                if (input.dataset.type === 'scale') {
                    responses.push({
                        questionId: input.dataset.qid,
                        answer: 'SCALE_VALUE', // The API might expect a string answer? Or value?
                        value: input.value, // Custom field? The backend expects 'value' for scale?
                        // Checking backed: survey.js expects { questionId, answer, confidence }
                        // For scale, usually answer is the value?
                        // Let's send answer = input.value
                    });
                    // Backend logic for scale: responseValue = body.answer or body.value?
                    // Let's modify payload to be safe
                } else if (input.dataset.type === 'radio') {
                    const selected = document.querySelector(`input[name="q_${input.dataset.qid}"]:checked`);
                    if (selected) {
                        responses.push({
                            questionId: input.dataset.qid,
                            answer: selected.value
                        });
                    }
                }
                processedQids.add(input.dataset.qid);
            });

            // Adjust payload for Scale questions to match what backend likely expects 
            // (Looking at backend code: const responseValue = response.answer || response.response;)
            const finalResponses = [];
            document.querySelectorAll('.survey-input').forEach(input => {
                if (input.dataset.type === 'scale') {
                    finalResponses.push({ questionId: input.dataset.qid, answer: input.value });
                } else if (input.dataset.type === 'radio' && input.checked) {
                    finalResponses.push({ questionId: input.dataset.qid, answer: input.value });
                }
            });

            // Remove duplicates (radios have multiple inputs)
            const uniqueResponses = Array.from(new Map(finalResponses.map(item => [item.questionId, item])).values());

            try {
                const token = localStorage.getItem('token');
                const res = await fetch(`/api/surveys/${currentSurveyId}/response`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ responses: uniqueResponses })
                });

                const data = await res.json();

                if (data.success) {
                    Swal.fire('¬°Excelente!', `Has ganado ${data.pointsEarned || 50} puntos.`, 'success');
                    closeSurveyModal();
                    checkAuth(); // Refresh points/stats
                } else {
                    Swal.fire('Error', data.error || 'No se pudo enviar', 'error');
                }
            } catch (e) {
                Swal.fire('Error', 'Error de conexi√≥n', 'error');
            }
        }



        function showSection(id, navItem) {
            ['dashboard', 'surveys', 'leaderboard', 'profile', 'historical', 'incidents'].forEach(s => {
                const el = document.getElementById(s);
                if (el) el.classList.add('hidden');
            });
            document.getElementById(id).classList.remove('hidden');

            // Update active nav
            if (navItem) {
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                navItem.classList.add('active');
            }

            if (id === 'historical') {
                loadMunicipios();
            }
            if (id === 'incidents') {
                loadMunicipios(); // Ensure select is populated
            }
        }

        // --- HISTORICAL DATA LOGIC ---
        let munisLoaded = false;
        async function loadMunicipios() {
            if (munisLoaded) return;
            try {
                const res = await fetch('/api/data/municipios');
                const munis = await res.json();

                // Populate Historical Select
                const histSelect = document.getElementById('hist-municipio-select');
                const incSelect = document.getElementById('inc-municipio');

                const options = munis.map(m => `<option value="${m.id}">${m.name}</option>`).join('');

                if (histSelect) histSelect.insertAdjacentHTML('beforeend', options);
                if (incSelect) incSelect.insertAdjacentHTML('beforeend', options);

                munisLoaded = true;
            } catch (e) {
                console.error("Error loading municipios", e);
            }
        }

        let histParticipStatsChart = null;

        async function loadHistoricalStats() {
            const muniId = document.getElementById('hist-municipio-select').value;
            if (!muniId) {
                document.getElementById('hist-content').classList.add('hidden');
                document.getElementById('hist-empty').classList.remove('hidden');
                return;
            }

            document.getElementById('hist-content').classList.remove('hidden');
            document.getElementById('hist-empty').classList.add('hidden');

            try {
                // Fetch Comparison Data
                const res = await fetch(`/api/data/comparacion/${muniId}`);
                const data = await res.json();

                const tbody = document.getElementById('hist-table-body');
                tbody.innerHTML = data.map(row => `
                    <tr class="border-b border-indigo-50 hover:bg-indigo-50/50 transition">
                        <td class="p-3 font-medium text-slate-800">${row.tipo_eleccion}</td>
                        <td class="p-3 font-bold text-indigo-600">${row['2024']}%</td>
                        <td class="p-3 text-slate-500">${row['2021']}%</td>
                        <td class="p-3 text-slate-400">${row['2018']}%</td>
                    </tr>
                `).join('');

                // Render Charts
                renderHistoricalCharts(data); // Simplified, can use detailed endpoint if needed
            } catch (e) {
                Swal.fire('Error', 'No se pudieron cargar los datos hist√≥ricos.', 'error');
            }
        }

        function renderHistoricalCharts(data) {
            const ctx = document.getElementById('histParticipationChart').getContext('2d');

            // Extract data for chart (e.g., Average participation per year)
            // This is a simplified viz, real one would need more detailed data
            const years = ['2018', '2021', '2024'];
            const avgPart = years.map(y => {
                const sum = data.reduce((acc, curr) => acc + parseFloat(curr[y] || 0), 0);
                return (sum / data.length).toFixed(1);
            });

            if (histParticipStatsChart) histParticipStatsChart.destroy();

            histParticipStatsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: years,
                    datasets: [{
                        label: 'Participaci√≥n Promedio %',
                        data: avgPart,
                        borderColor: '#4f46e5',
                        backgroundColor: 'rgba(79, 70, 229, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: { responsive: true }
            });
        }

        // --- INCIDENT REPORTING LOGIC ---
        function previewImage(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const img = document.getElementById('inc-preview');
                    img.src = e.target.result;
                    img.classList.remove('hidden');
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        async function submitIncident(e) {
            e.preventDefault();

            const btn = e.target.querySelector('button[type="submit"]');
            const originalText = btn.innerText;
            btn.disabled = true;
            btn.innerText = 'Enviando...';

            const payload = {
                municipalityId: document.getElementById('inc-municipio').value,
                type: document.getElementById('inc-type').value,
                description: document.getElementById('inc-desc').value,
                latitude: null,
                longitude: null,
                photoUrl: null // Handle upload separately or base64 if small
            };

            // Geo
            if (document.getElementById('inc-geo').checked && navigator.geolocation) {
                try {
                    const pos = await new Promise((resolve, reject) => {
                        navigator.geolocation.getCurrentPosition(resolve, reject);
                    });
                    payload.latitude = pos.coords.latitude;
                    payload.longitude = pos.coords.longitude;
                } catch (err) {
                    console.warn("Geo access denied or failed");
                }
            }

            try {
                const token = localStorage.getItem('token');
                const res = await fetch('/api/incidents', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(payload)
                });

                const data = await res.json();

                if (data.success) {
                    Swal.fire({
                        title: '¬°Reporte Enviado!',
                        text: `Gracias por colaborar. Has ganado ${data.pointsEarned} puntos.`,
                        icon: 'success'
                    });
                    e.target.reset();
                    document.getElementById('inc-preview').classList.add('hidden');
                    checkAuth(); // Update points
                } else {
                    Swal.fire('Error', data.error || 'No se pudo enviar el reporte', 'error');
                }
            } catch (error) {
                Swal.fire('Error', 'Fallo de conexi√≥n', 'error');
            } finally {
                btn.disabled = false;
                btn.innerText = originalText;
            }
        }

        // ... Survey Modal Logic (previous)


        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = '/';
        }

        // Init
        checkAuth();
    </script>
</body>

</html>