<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Guardianes de Guerrero | Caja Negra Democr√°tica</title>
    
    <!-- Scripts y Estilos -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Poppins:wght@700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <link href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" rel="stylesheet">
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.10.0/dist/sweetalert2.all.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11.10.0/dist/sweetalert2.min.css" rel="stylesheet">

    <style>
        :root {
            --color-primary: #FF8C00; /* Naranja */
            --color-secondary: #E63946; /* Rojo */
            --color-background: #1a2630; /* Charcoal */
            --color-surface: #284869; /* Gris-azul tenue */
            --color-text-primary: #FFFFFF; /* Blanco */
            --color-text-secondary: #B0B0B0; /* Gris claro */
            --color-accent: #FFD60A; /* Alertas - Amarillo Ocre */
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--color-background);
            color: var(--color-text-primary);
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        h1, h2, h3, h4, .font-black {
            font-family: 'Poppins', sans-serif;
            font-weight: 700;
        }

        .glass-card {
            background: rgba(30, 41, 59, 0.5);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        /* ... (Resto de tus estilos originales) ... */
        
        /* 
           üöë PARCHE M√ìVIL DE EMERGENCIA - GUARDIANES 2027 
           Soluci√≥n para textos cortados y layout apretado en celulares
        */
        @media (max-width: 640px) {
            /* T√≠tulos del modal ajustados */
            #modal-title h2, 
            .modal-header h2,
            h2.text-3xl {
                font-size: 1.5rem !important;
                line-height: 1.2 !important;
                white-space: normal !important;
                word-wrap: break-word !important;
                overflow-wrap: break-word !important;
            }

            /* Contenedor del t√≠tulo */
            #modal-title {
                padding: 0 10px !important;
                width: 100% !important;
            }

            /* Preguntas */
            .question-text, h4.text-3xl {
                font-size: 1.2rem !important;
                margin-bottom: 0.5rem !important;
            }

            /* Slider de confianza */
            #confidence-display {
                font-size: 3.5rem !important;
            }
            
            .slider-labels span {
                font-size: 0.6rem !important;
            }

            /* Grilla de candidatos en m√≥vil */
            .grid-cols-2 {
                gap: 0.5rem !important;
            }

            .candidate-card {
                padding: 0.75rem !important;
            }

            .candidate-card .w-28 { 
                width: 4.5rem !important;
                height: 4.5rem !important;
                margin-bottom: 0.25rem !important;
            }
            
            .candidate-card h5 {
                font-size: 0.65rem !important;
                line-height: 1.1 !important;
                white-space: normal !important; /* Permite 2 l√≠neas */
                height: 2.2em; /* Altura fija para alineaci√≥n */
                display: -webkit-box;
                -webkit-line-clamp: 2;
                -webkit-box-orient: vertical;
                overflow: hidden;
            }

            /* Botones del men√∫ principal */
            .tab-btn {
                padding: 0.75rem 1rem !important;
                font-size: 0.8rem !important;
            }

            /* Modal contenido */
            #modal-content {
                padding-left: 1rem !important;
                padding-right: 1rem !important;
                padding-bottom: 6rem !important; /* Espacio para bot√≥n flotante */
            }
            
            /* Inputs gigantes en m√≥vil */
            .auth-input, #user-phone {
                font-size: 1.2rem !important;
                padding: 1rem !important;
            }
        }
    </style>
</head>
<body class="min-h-screen pb-20">

<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guardianes de Guerrero | Caja Negra Democr√°tica</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Poppins:wght@700&display=swap"
        rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.10.0/dist/sweetalert2.all.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11.10.0/dist/sweetalert2.min.css" rel="stylesheet">
    <style>
        :root {
            --color-primary: #FF8C00;
            /* Naranja */
            --color-secondary: #E63946;
            /* Rojo */
            --color-background: #1a2630;
            /* Charcoal */
            --color-surface: #284869;
            /* Gris-azul tenue */
            --color-text-primary: #FFFFFF;
            /* Blanco */
            --color-text-secondary: #B0B0B0;
            /* Gris claro */
            --color-accent: #FFD60A;
            /* Alertas - Amarillo Ocre */
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--color-background);
            color: var(--color-text-primary);
            overflow-x: hidden;
        }

        h1,
        h2,
        h3,
        h4,
        .font-black {
            font-family: 'Poppins', sans-serif;
            font-weight: 700;
        }

        .glass-card {
            background: rgba(30, 41, 59, 0.5);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .nav-active {
            border-bottom: 2px solid var(--accent);
            color: var(--accent);
        }

        .candidate-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid transparent;
        }

        .candidate-card:hover {
            transform: translateY(-8px) scale(1.02);
            border-color: rgba(202, 138, 4, 0.4);
        }

        .candidate-card.selected {
            border-color: var(--accent);
            background: rgba(202, 138, 4, 0.1);
            box-shadow: 0 0 30px rgba(202, 138, 4, 0.3);
        }

        input[type="range"] {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background: rgba(255, 255, 255, 0.1);
            height: 8px;
            border-radius: 5px;
            color: var(--accent);
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: var(--accent);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        }

        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            padding: 1rem 2rem;
            border-radius: 1rem;
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
            font-weight: 800;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.1em;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Botones Quir√∫rgicos */
        button.bg-amber-600,
        button.bg-emerald-600,
        button.bg-red-600,
        button[onclick="submitSurvey()"] {
            background-color: var(--color-primary) !important;
            transition: all 200ms ease-out !important;
            border-radius: 1.5rem !important;
        }

        button.bg-amber-600:hover,
        button.bg-emerald-600:hover,
        button.bg-red-600:hover,
        button[onclick="submitSurvey()"]:hover {
            background-color: var(--color-secondary) !important;
            transform: translateY(-1px);
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
         /* Estilos para el modal de login */
    .auth-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.7);
        z-index: 10000;
        justify-content: center;
        align-items: center;
    }
    .auth-modal.show {
        display: flex;
    }
    .auth-content {
        background: white;
        padding: 30px;
        border-radius: 15px;
        max-width: 400px;
        width: 90%;
        box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    }
    .auth-step {
        display: none;
    }
    .auth-step.active {
        display: block;
    }
    .auth-input {
        width: 100%;
        padding: 12px;
        margin: 10px 0;
        border: 2px solid #ddd;
        border-radius: 8px;
        font-size: 16px;
    }
    .auth-button {
        width: 100%;
        padding: 12px;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        cursor: pointer;
        margin-top: 10px;
    }
    .auth-button:hover {
        background: #0056b3;
    }
    .auth-timer {
        text-align: center;
        color: #666;
        margin: 10px 0;
    }
    </style>
</head>

<body class="min-h-screen">
<script>
// ============================================
// SISTEMA DE AUTENTICACI√ìN GUARDIANES v4.0
// DOBLE CANDADO - SESI√ìN PERSISTENTE
// ============================================
    /* 
    // TODO el c√≥digo viejo, incluidas las funciones:
      // requestInitialOTP, showInitialAuthModal, verifyInitialCode,
      // refreshAccessToken, authenticatedFetch, etc.
      
class GuardianesAuthSystem {
    constructor() {
        // Tokens y sesi√≥n
        this.accessToken = localStorage.getItem('grd_access_token');
        this.refreshToken = localStorage.getItem('grd_refresh_token');
        this.sessionId = localStorage.getItem('grd_session_id');
        this.user = JSON.parse(localStorage.getItem('grd_user') || 'null');
        
        // Control de estado
        this.isInitialAuth = false;
        this.lastVerification = localStorage.getItem('grd_last_verification');
        this.pendingAction = null;
        
        // Configuraci√≥n
        this.SESSION_DURATION = 30 * 24 * 60 * 60 * 1000; // 30 d√≠as
        this.VERIFICATION_CACHE = 60 * 60 * 1000; // 1 hora sin re-verificar
    }
    
    // ========================================
    // VERIFICACIONES DE ESTADO
    // ========================================
    
    hasValidSession() {
        // Verifica si hay una sesi√≥n v√°lida (no necesariamente activa)
        return this.sessionId && this.user;
    }
    
    isFullyAuthenticated() {
        // Verifica autenticaci√≥n completa con token v√°lido
        return this.accessToken && this.user && this.sessionId;
    }
    
    needsVerification() {
        // Determina si necesita verificaci√≥n para acciones sensibles
        if (!this.lastVerification) return true;
        
        const lastVerifyTime = new Date(this.lastVerification).getTime();
        const now = Date.now();
        
        return (now - lastVerifyTime) > this.VERIFICATION_CACHE;
    }
    
    // ========================================
    // FLUJO DE AUTENTICACI√ìN INICIAL
    // ========================================
    
    async checkInitialAccess() {
        // Verificar si el usuario necesita autenticaci√≥n inicial
        if (!this.hasValidSession()) {
            console.log('üîí Sin sesi√≥n v√°lida, requiere autenticaci√≥n inicial');
            this.showInitialAuthModal();
            return false;
        }
        
        // Verificar si el token sigue v√°lido
        if (this.accessToken) {
            try {
                const response = await fetch('/api/auth/me', {
                    headers: { 'Authorization': `Bearer ${this.accessToken}` }
                });
                
                if (response.ok) {
                    const userData = await response.json();
                    this.updateUserInfo(userData);
                    console.log('‚úÖ Sesi√≥n v√°lida para:', userData.name);
                    return true;
                }
            } catch (error) {
                console.error('Error verificando sesi√≥n:', error);
            }
        }
        
        // Intentar refresh si hay refresh token
        if (this.refreshToken) {
            const refreshed = await this.refreshAccessToken();
            if (refreshed) {
                console.log('‚úÖ Token renovado exitosamente');
                return true;
            }
        }
        
        // Si llegamos aqu√≠, necesita re-autenticaci√≥n
        console.log('‚ö†Ô∏è Sesi√≥n expirada, requiere nueva verificaci√≥n');
        this.showInitialAuthModal();
        return false;
    }
    
    // ========================================
    // MODAL DE AUTENTICACI√ìN INICIAL
    // ========================================
    
    showInitialAuthModal() {
        this.isInitialAuth = true;
        
        Swal.fire({
            title: 'üõ°Ô∏è Bienvenido a Guardianes Guerrero',
            html: `
                <div style="text-align: left;">
                    <p style="margin-bottom: 20px;">Para acceder al sistema y participar en las predicciones electorales, verifica tu n√∫mero de tel√©fono.</p>
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">
                        üì± N√∫mero de tel√©fono (10 d√≠gitos):
                    </label>
                    <input type="tel" 
                           id="swal-phone" 
                           class="swal2-input" 
                           placeholder="7471234567"
                           maxlength="10"
                           style="margin: 0;">
                    <div style="margin-top: 15px; padding: 10px; background: #f0f8ff; border-radius: 5px;">
                        <small>
                            ‚úÖ Tu n√∫mero ser√° verificado v√≠a WhatsApp<br>
                            ‚úÖ Sesi√≥n v√°lida por 30 d√≠as<br>
                            ‚úÖ Ganar√°s puntos por cada predicci√≥n
                        </small>
                    </div>
                </div>
            `,
            confirmButtonText: 'üì≤ Enviar C√≥digo',
            confirmButtonColor: '#25D366',
            showCancelButton: false,
            allowOutsideClick: false,
            allowEscapeKey: false,
            preConfirm: () => {
                const phone = document.getElementById('swal-phone').value;
                if (!/^\d{10}$/.test(phone)) {
                    Swal.showValidationMessage('Ingresa 10 d√≠gitos sin espacios');
                    return false;
                }
                return phone;
            }
        }).then(async (result) => {
            if (result.isConfirmed) {
                await this.requestInitialOTP(result.value);
            }
        });
    }
    
    async requestInitialOTP(phone) {
        try {
            Swal.fire({
                title: 'Enviando c√≥digo...',
                text: 'Por favor espera',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            
            const response = await fetch('/api/auth/request-code', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ phone })
            });
            
            const data = await response.json();
            
            if (!response.ok) {
                throw new Error(data.error || 'Error al enviar c√≥digo');
            }
            
            // Guardar n√∫mero temporalmente
            this.tempPhone = phone;
            
            // Mostrar modal de verificaci√≥n
            this.showVerificationModal(data.phoneLast4, data.debug_otp);
            
        } catch (error) {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: error.message,
                confirmButtonText: 'Reintentar',
                confirmButtonColor: '#dc3545'
            }).then(() => {
                this.showInitialAuthModal();
            });
        }
    }
    
    showVerificationModal(phoneLast4, debugCode = null) {
        let timerInterval;
        let timeLeft = 600; // 10 minutos
        
        Swal.fire({
            title: 'üîê Verificaci√≥n de C√≥digo',
            html: `
                <div style="text-align: center;">
                    <p>C√≥digo enviado a: ***${phoneLast4}</p>
                    <input type="text" 
                           id="swal-code" 
                           class="swal2-input" 
                           placeholder="123456"
                           maxlength="6"
                           style="font-size: 24px; letter-spacing: 5px; text-align: center;">
                    <div id="timer" style="margin-top: 10px; color: #666;">
                        C√≥digo v√°lido por: <span id="time">10:00</span>
                    </div>
                    ${debugCode ? `<div style="margin-top: 10px; padding: 10px; background: #fff3cd; border-radius: 5px;">
                        <small>üîë C√≥digo de prueba: <strong>${debugCode}</strong></small>
                    </div>` : ''}
                </div>
            `,
            confirmButtonText: '‚úÖ Verificar',
            confirmButtonColor: '#28a745',
            showCancelButton: true,
            cancelButtonText: '‚Üê Cambiar N√∫mero',
            allowOutsideClick: false,
            didOpen: () => {
                timerInterval = setInterval(() => {
                    timeLeft--;
                    const minutes = Math.floor(timeLeft / 60);
                    const seconds = timeLeft % 60;
                    document.getElementById('time').textContent = 
                        `${minutes}:${seconds.toString().padStart(2, '0')}`;
                    
                    if (timeLeft <= 0) {
                        clearInterval(timerInterval);
                        Swal.close();
                        Swal.fire({
                            icon: 'warning',
                            title: 'C√≥digo Expirado',
                            text: 'El c√≥digo ha expirado. Solicita uno nuevo.',
                            confirmButtonText: 'Solicitar Nuevo C√≥digo'
                        }).then(() => {
                            this.showInitialAuthModal();
                        });
                    }
                }, 1000);
            },
            willClose: () => {
                clearInterval(timerInterval);
            },
            preConfirm: () => {
                const code = document.getElementById('swal-code').value;
                if (!/^\d{6}$/.test(code)) {
                    Swal.showValidationMessage('Ingresa el c√≥digo de 6 d√≠gitos');
                    return false;
                }
                return code;
            }
        }).then(async (result) => {
            if (result.isConfirmed) {
                await this.verifyInitialCode(result.value);
            } else if (result.dismiss === Swal.DismissReason.cancel) {
                this.showInitialAuthModal();
            }
        });
    }
    
    async verifyInitialCode(code) {
        try {
            Swal.fire({
                title: 'Verificando...',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            
            const response = await fetch('/api/auth/verify-code', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    phone: this.tempPhone, 
                    code 
                })
            });
            
            const data = await response.json();
            
            if (!response.ok) {
                throw new Error(data.error || 'C√≥digo incorrecto');
            }
            
            // Guardar sesi√≥n
            this.saveSession(data);
            
            // Mostrar bienvenida
            Swal.fire({
                icon: 'success',
                title: '¬°Bienvenido a Guardianes!',
                html: `
                    <div style="text-align: center;">
                        <h4>${data.user.name}</h4>
                        <p>Tu sesi√≥n est√° activa por 30 d√≠as</p>
                        <hr>
                        <p>Ahora puedes:</p>
                        <ul style="text-align: left; display: inline-block;">
                            <li>üìä Realizar predicciones electorales</li>
                            <li>üìà Ver estad√≠sticas en tiempo real</li>
                            <li>üèÜ Ganar puntos y subir en el ranking</li>
                            <li>üì± Reportar incidentes electorales</li>
                        </ul>
                    </div>
                `,
                confirmButtonText: '¬°Comenzar!',
                confirmButtonColor: '#28a745'
            }).then(() => {
                // Recargar para actualizar UI
                this.updateUIAfterLogin();
                
                // Si hay acci√≥n pendiente, ejecutarla
                if (this.pendingAction) {
                    this.executePendingAction();
                }
            });
            
        } catch (error) {
            Swal.fire({
                icon: 'error',
                title: 'Error de Verificaci√≥n',
                text: error.message,
                confirmButtonText: 'Reintentar',
                showCancelButton: true,
                cancelButtonText: 'Cambiar N√∫mero'
            }).then((result) => {
                if (result.isConfirmed) {
                    this.showVerificationModal(this.tempPhone.slice(-4));
                } else {
                    this.showInitialAuthModal();
                }
            });
        }
    }
    
    // ========================================
    // VERIFICACI√ìN PARA PREDICCIONES
    // ========================================
    
    async requireAuthForPrediction(prediction) {
        // Guardar predicci√≥n pendiente
        this.pendingAction = {
            type: 'prediction',
            data: prediction
        };
        
        // Si no tiene sesi√≥n, mostrar auth inicial
        if (!this.hasValidSession()) {
            this.showInitialAuthModal();
            return false;
        }
        
        // Si tiene sesi√≥n pero el token expir√≥, renovar
        if (!this.isFullyAuthenticated()) {
            const renewed = await this.refreshAccessToken();
            if (!renewed) {
                // No se pudo renovar, re-autenticar
                this.showQuickVerification();
                return false;
            }
        }
        
        // Si necesita re-verificaci√≥n (m√°s de 1 hora)
        if (this.needsVerification()) {
            this.showQuickVerification();
            return false;
        }
        
        // Todo OK, puede proceder
        return true;
    }
    
    showQuickVerification() {
        Swal.fire({
            title: 'üîê Verificaci√≥n R√°pida',
            html: `
                <div style="text-align: center;">
                    <p>Por seguridad, confirma tu identidad</p>
                    <p style="font-size: 18px; margin: 20px 0;">
                        Tu n√∫mero termina en: <strong>***${this.user?.phoneLast4 || '????'}</strong>
                    </p>
                    <button onclick="authSystem.sendQuickCode()" class="swal2-confirm swal2-styled" style="background-color: #25D366;">
                        üì≤ Enviar C√≥digo R√°pido
                    </button>
                </div>
            `,
            showConfirmButton: false,
            showCancelButton: true,
            cancelButtonText: 'Cancelar',
            allowOutsideClick: false
        });
    }
    
    async sendQuickCode() {
        // Usar el tel√©fono almacenado en sesi√≥n
        if (!this.user || !this.user.phoneLast4) {
            this.showInitialAuthModal();
            return;
        }
        
        // Aqu√≠ implementar√≠as la l√≥gica de c√≥digo r√°pido
        // Por ahora, continuar con la acci√≥n
        Swal.close();
        this.updateVerificationTime();
        this.executePendingAction();
    }
    
    // ========================================
    // GESTI√ìN DE SESI√ìN
    // ========================================
    
    saveSession(authData) {
        this.accessToken = authData.accessToken;
        this.refreshToken = authData.refreshToken;
        this.user = authData.user;
        this.sessionId = this.generateSessionId();
        
        localStorage.setItem('grd_access_token', this.accessToken);
        localStorage.setItem('grd_refresh_token', this.refreshToken);
        localStorage.setItem('grd_user', JSON.stringify(this.user));
        localStorage.setItem('grd_session_id', this.sessionId);
        localStorage.setItem('grd_last_verification', new Date().toISOString());
        
        this.updateVerificationTime();
    }
    
    updateVerificationTime() {
        this.lastVerification = new Date().toISOString();
        localStorage.setItem('grd_last_verification', this.lastVerification);
    }
    
    async refreshAccessToken() {
        if (!this.refreshToken) return false;
        
        try {
            const response = await fetch('/api/auth/refresh', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ refreshToken: this.refreshToken })
            });
            
            if (!response.ok) return false;
            
            const data = await response.json();
            this.accessToken = data.accessToken;
            localStorage.setItem('grd_access_token', this.accessToken);
            
            return true;
            
        } catch (error) {
            console.error('Error renovando token:', error);
            return false;
        }
    }
    
    generateSessionId() {
        return 'grd_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }
    
    // ========================================
    // EJECUCI√ìN DE ACCIONES
    // ========================================
    
    executePendingAction() {
        if (!this.pendingAction) return;
        
        const action = this.pendingAction;
        this.pendingAction = null;
        
        switch (action.type) {
            case 'prediction':
                submitAuthenticatedPrediction(action.data);
                break;
            case 'survey':
                submitSurvey(action.data);
                break;
            default:
                console.log('Acci√≥n pendiente desconocida:', action);
        }
    }
    
    // ========================================
    // UTILIDADES
    // ========================================
    
    getAuthHeaders() {
        const headers = {
            'Content-Type': 'application/json'
        };
        
        if (this.accessToken) {
            headers['Authorization'] = `Bearer ${this.accessToken}`;
        }
        
        return headers;
    }
    
    async authenticatedFetch(url, options = {}) {
        options.headers = {
            ...options.headers,
            ...this.getAuthHeaders()
        };
        
        return fetch(url, options);
    }
    
    updateUserInfo(userData) {
        this.user = { ...this.user, ...userData };
        localStorage.setItem('grd_user', JSON.stringify(this.user));
    }
    
    updateUIAfterLogin() {
        // Actualizar nombre de usuario en la UI
        const userElements = document.querySelectorAll('.user-name');
        userElements.forEach(el => {
            el.textContent = this.user.name || `Usuario ${this.user.phoneLast4}`;
        });
        
        // Actualizar puntos
        const pointsElements = document.querySelectorAll('.user-points');
        pointsElements.forEach(el => {
            el.textContent = this.user.points || 0;
        });
        
        // Mostrar elementos para usuarios autenticados
        document.querySelectorAll('.auth-only').forEach(el => {
            el.style.display = 'block';
        });
        
        // Ocultar elementos de login
        document.querySelectorAll('.guest-only').forEach(el => {
            el.style.display = 'none';
        });
    }
    
    logout() {
        // Limpiar toda la sesi√≥n
        localStorage.removeItem('grd_access_token');
        localStorage.removeItem('grd_refresh_token');
        localStorage.removeItem('grd_user');
        localStorage.removeItem('grd_session_id');
        localStorage.removeItem('grd_last_verification');
        
        this.accessToken = null;
        this.refreshToken = null;
        this.user = null;
        this.sessionId = null;
        this.lastVerification = null;
        
        // Recargar p√°gina
        window.location.reload();
    }
}


const authSystem = new GuardianesAuthSystem();


// ============================================
// INICIALIZACI√ìN AL CARGAR LA P√ÅGINA
// ============================================

document.addEventListener('DOMContentLoaded', async function() {
    console.log('üöÄ Inicializando Sistema Guardianes v4.0');
    */

    // Verificar acceso inicial
    const hasAccess = await authSystem.checkInitialAccess();
    
    if (hasAccess) {
        console.log('‚úÖ Usuario con sesi√≥n activa');
        authSystem.updateUIAfterLogin();
        
        // Mostrar mensaje de bienvenida
        const Toast = Swal.mixin({
            toast: true,
            position: 'top-end',
            showConfirmButton: false,
            timer: 3000,
            timerProgressBar: true
        });
        
        Toast.fire({
            icon: 'success',
            title: `Bienvenido ${authSystem.user.name}`
        });
    } else {
        console.log('üîí Usuario sin sesi√≥n, mostrando autenticaci√≥n');
    }
    
    // Agregar bot√≥n de logout si est√° autenticado
    if (authSystem.isFullyAuthenticated()) {
        const logoutBtn = document.createElement('button');
        logoutBtn.innerHTML = 'üö™ Cerrar Sesi√≥n';
        logoutBtn.className = 'btn-logout';
        logoutBtn.style.cssText = 'position: fixed; top: 10px; right: 10px; z-index: 9999; padding: 10px 20px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer;';
        logoutBtn.onclick = () => {
            Swal.fire({
                title: '¬øCerrar Sesi√≥n?',
                text: 'Tendr√°s que verificar tu n√∫mero nuevamente para acceder',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'S√≠, cerrar sesi√≥n',
                cancelButtonText: 'Cancelar',
                confirmButtonColor: '#dc3545'
            }).then((result) => {
                if (result.isConfirmed) {
                    authSystem.logout();
                }
            });
        };
        document.body.appendChild(logoutBtn);
    }

// ============================================
// FUNCIONES AUXILIARES
// ============================================

function updateUserPoints() {
    if (!authSystem.isFullyAuthenticated()) return;
    
    authSystem.authenticatedFetch('/api/auth/me')
        .then(res => res.json())
        .then(data => {
            authSystem.updateUserInfo(data);
            
            // Actualizar UI
            document.querySelectorAll('.user-points').forEach(el => {
                el.textContent = data.points || 0;
            });
            
            // Actualizar nivel si existe
            document.querySelectorAll('.user-level').forEach(el => {
                el.textContent = data.level || 'Observador';
            });
        })
        .catch(console.error);
}

function updatePredictionStats(municipalityId) {
    fetch(`/api/predictions/stats/${municipalityId}`)
        .then(res => res.json())
        .then(data => {
            console.log('üìä Estad√≠sticas actualizadas:', data);
            
            // Actualizar gr√°ficas si existen
            if (typeof updateCharts === 'function') {
                updateCharts(data);
            }
            
            // Actualizar contadores
            if (document.getElementById('total-predictions')) {
                document.getElementById('total-predictions').textContent = 
                    data.totalVoters || 0;
            }
        })
        .catch(console.error);
}

// ============================================
// TEST FUNCTIONS (Remover en producci√≥n)
// ============================================

window.testPrediction = function() {
    savePrediction(18, 'candidato_21', 75);
};

window.testAuth = function() {
    authSystem.showInitialAuthModal();
};

console.log('‚úÖ Sistema de autenticaci√≥n cargado. Funciones de test disponibles:');
console.log('   - testPrediction(): Probar predicci√≥n');
console.log('   - testAuth(): Probar autenticaci√≥n');
</script>
    <!-- NAVBAR -->
    <nav class="fixed top-0 w-full z-50 glass-card bg-slate-950/80 border-b border-white/5 px-6 py-4">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div
                    class="w-10 h-10 bg-amber-600 rounded-lg flex items-center justify-center font-black text-2xl shadow-lg shadow-amber-900/40">
                    G</div>
                <h1 class="text-xl font-extrabold tracking-tighter uppercase">Guardianes Guerrero <span
                        class="text-amber-500">2027</span></h1>
            </div>
            <div id="user-info" class="hidden flex items-center gap-6">
                <div class="text-right">
                    <div class="text-[14px] font-black text-slate-500 uppercase tracking-widest">Nivel Relevancia</div>
                    <span id="user-points" class="text-amber-500 font-black text-xs uppercase italic tracking-tighter">0
                        PTS de Influencia</span>
                </div>
                <button onclick="logout()"
                    class="text-[14px] bg-white/5 hover:bg-white/10 px-4 py-2 rounded-lg font-black uppercase transition">Cerrar</button>
            </div>
        </div>
    </nav>

    <!-- CONTENT -->
    <main class="pt-28 pb-20 px-4 max-w-7xl mx-auto">


<section id="auth-section" class="max-w-md mx-auto mt-12 animate-in slide-in-from-bottom-8 duration-700">
    <div class="glass-card p-12 rounded-[2.5rem] text-center border-white/10 shadow-2xl">
        <h2 class="text-3xl font-black mb-2 italic tracking-tighter uppercase whitespace-nowrap">
            Portal <span class="text-amber-500">Ciudadano</span>
        </h2>
        <p class="text-xs font-bold text-slate-500 mb-10 uppercase tracking-[0.2em]">
            Acceso Directo ‚Ä¢ Sin C√≥digos
        </p>

        <div id="phone-step" class="space-y-4">
            <input 
                type="tel" 
                id="user-phone" 
                placeholder="744 123 4567"
                maxlength="10"
                class="w-full bg-slate-900 border border-white/10 p-5 rounded-2xl text-center text-2xl font-black focus:border-amber-500 outline-none transition shadow-inner"
                onkeypress="if(event.key === 'Enter') quickLogin()"
            >
            
            <button 
                onclick="quickLogin()"
                class="w-full bg-amber-600 hover:bg-amber-700 p-5 rounded-2xl font-black text-lg transition shadow-xl shadow-amber-900/20 uppercase tracking-tighter"
            >
                üöÄ Entrar Ahora
            </button>
            
            <p class="text-[10px] text-slate-600 mt-4">
                Solo n√∫meros de Guerrero (744, 747, 733, 758, 767, 741, 742)
            </p>
        </div>

        <div class="mt-8 flex items-center justify-center gap-2 opacity-30">
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd"
                    d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z"
                    clip-rule="evenodd"></path>
            </svg>
            <span class="text-[10px] font-bold uppercase tracking-widest leading-none">
                100% An√≥nimo
            </span>
        </div>
    </div>
</section>       

        <!-- PORTAL MAIN -->
        <section id="portal-section" class="hidden space-y-10 animate-in fade-in zoom-in-95 duration-500">
            <!-- TABS -->
            <div
                class="flex overflow-x-auto gap-4 p-2 glass-card rounded-2xl sticky top-24 z-40 bg-slate-950/40 border-white/5 scrollbar-hide">
                <button onclick="switchTab('encuestas')" data-tab="encuestas"
                    class="tab-btn flex-1 py-4 px-8 rounded-xl font-black text-[18px] uppercase tracking-[0.2em] transition whitespace-nowrap nav-active">üìã
                    Encuestas</button>
                <button onclick="switchTab('incidentes')" data-tab="incidentes"
                    class="tab-btn flex-1 py-4 px-8 rounded-xl font-black text-[18px] uppercase tracking-[0.2em] transition whitespace-nowrap">üö®
                    Incidentes</button>
                <button onclick="switchTab('historico')" data-tab="historico"
                    class="tab-btn flex-1 py-4 px-8 rounded-xl font-black text-[18px] uppercase tracking-[0.2em] transition whitespace-nowrap">üìä
                    Hist√≥rico</button>
                <button onclick="switchTab('predicciones')" data-tab="predicciones"
                    class="tab-btn flex-1 py-4 px-8 rounded-xl font-black text-[18px] uppercase tracking-[0.2em] transition whitespace-nowrap">üîÆ
                    Predicciones</button>
            </div>

            <!-- TAB CONTENT -->
            <div id="tab-encuestas" class="tab-content active transition-all">
                <!-- BANNER EN VIVO -->
                <div
                    class="mb-12 p-6 rounded-3xl bg-gradient-to-r from-[#1A1A2E] to-[#2D3748] border-l-4 border-[#FF8C00] overflow-hidden relative">
                    <div class="absolute inset-0 opacity-30">
                        <div class="absolute top-0 right-0 w-40 h-40 bg-[#FF8C00] blur-3xl animate-pulse"></div>
                    </div>
                    <div class="relative z-10 flex items-center justify-between">
                        <div class="flex items-center gap-4">
                            <div class="flex items-center gap-2">
                                <span class="w-3 h-3 bg-[#E63946] rounded-full animate-pulse"></span>
                                <span class="text-[10px] font-black uppercase tracking-[0.2em] text-[#FFD60A]">EN
                                    VIVO</span>
                            </div>
                            <h3 class="text-2xl font-black text-white uppercase italic">üìä Encuestas <span
                                    class="text-[#FF8C00]">Activas</span></h3>
                        </div>
                        <p class="text-sm font-bold text-[#B0B0B0]">Participaci√≥n en tiempo real</p>
                    </div>
                </div>
                <div id="surveys-grid" class="grid md:grid-cols-2 lg:grid-cols-3 gap-8">
                    <!-- Surveys Injected -->
                </div>
            </div>

            <div id="tab-incidentes" class="tab-content transition-all">
                <div class="grid lg:grid-cols-2 gap-10 max-w-6xl mx-auto">
                    <div class="glass-card p-10 rounded-[2.5rem] shadow-2xl border-red-900/10">
                        <span class="text-[10px] font-black text-red-500 uppercase tracking-widest block mb-1">Centro de
                            Monitoreo</span>
                        <h3 class="text-3xl font-black mb-8 italic uppercase tracking-tighter">Reportar <span
                                class="text-red-600">Anomal√≠a</span></h3>

                        <div class="space-y-6">
                            <div>
                                <label
                                    class="text-[10px] font-black text-slate-500 uppercase tracking-widest block mb-2">Clasificaci√≥n</label>
                                <select id="incident-type"
                                    class="w-full bg-slate-900 border border-white/10 p-5 rounded-2xl font-black outline-none focus:border-red-600 transition tracking-tighter">
                                    <option value="otro">OTRO / GENERAL</option>
                                    <option value="compra_voto">COMPRA DE VOTO</option>
                                    <option value="intimidacion">INTIMIDACI√ìN / VIOLENCIA</option>
                                    <option value="casilla_irregular">ANOMAL√çA EN CASILLA</option>
                                    <option value="propaganda_ilegal">PROPAGANDA PROHIBIDA</option>
                                </select>
                            </div>
                            <div>
                                <label
                                    class="text-[10px] font-black text-slate-500 uppercase tracking-widest block mb-2">Municipio
                                    del Incidente</label>
                                <select id="incident-muni-selector"
                                    class="w-full bg-slate-900 border border-white/10 p-5 rounded-2xl font-black outline-none focus:border-red-600 transition tracking-tighter">
                                    <option value="">SELECCIONA MUNICIPIO</option>
                                    <option value="1">ACAPULCO DE JU√ÅREZ</option>
                                    <option value="2">ACATEPEC</option>
                                    <option value="3">AHUACUOTZINGO</option>
                                    <option value="4">AJUCHITLAN DEL PROGRESO</option>
                                    <option value="5">ALCOZAUCA DE GUERRERO</option>
                                    <option value="6">ALPOYECA</option>
                                    <option value="7">APAXTLA</option>
                                    <option value="8">ARCELIA</option>
                                    <option value="9">ATENANGO DEL R√çO</option>
                                    <option value="10">ATLAMAJALCINGO DEL MONTE</option>
                                    <option value="11">ATLIXTAC</option>
                                    <option value="12">ATOYAC DE √ÅLVAREZ</option>
                                    <option value="13">AYUTLA DE LOS LIBRES</option>
                                    <option value="14">AZOYU</option>
                                    <option value="15">BENITO JU√ÅREZ</option>
                                    <option value="16">BUENAVISTA DE CU√âLLAR</option>
                                    <option value="17">CHILAPA DE √ÅLVAREZ</option>
                                    <option value="18">CHILPANCINGO DE LOS BRAVO</option>
                                    <option value="19">COAHUAYUTLA DE JOS√â MAR√çA IZAZAGA</option>
                                    <option value="20">COCHOAPA EL GRANDE</option>
                                    <option value="21">COCULA</option>
                                    <option value="22">COPALA</option>
                                    <option value="23">COPALILLO</option>
                                    <option value="24">COPANATOYAC</option>
                                    <option value="25">COYUCA DE BEN√çTEZ</option>
                                    <option value="26">COYUCA DE CATAL√ÅN</option>
                                    <option value="27">CUAJINICUILAPA</option>
                                    <option value="28">CUALAC</option>
                                    <option value="29">CUAUTEPEC</option>
                                    <option value="30">CUETZALA DEL PROGRESO</option>
                                    <option value="31">CUTZAMALA DE PINZ√ìN</option>
                                    <option value="32">EDUARDO NERI</option>
                                    <option value="33">FLORENCIO VILLARREAL</option>
                                    <option value="34">GENERAL CANUTO A. NERI</option>
                                    <option value="35">GENERAL HELIODORO CASTILLO</option>
                                    <option value="36">HUAMUXTITL√ÅN</option>
                                    <option value="37">HUITZUCO DE LOS FIGUEROA</option>
                                    <option value="38">IGUALA DE LA INDEPENDENCIA</option>
                                    <option value="39">IGUALAPA</option>
                                    <option value="40">ILIATENCO</option>
                                    <option value="41">IXCATEOPAN DE CUAUHT√âMOC</option>
                                    <option value="42">JOS√â JOAQU√çN DE HERRERA</option>
                                    <option value="43">JUAN R. ESCUDERO</option>
                                    <option value="44">JUCHIT√ÅN</option>
                                    <option value="45">LA UNI√ìN DE ISIDORO MONTES DE OCA</option>
                                    <option value="46">LAS VIGAS</option>
                                    <option value="47">LEONARDO BRAVO</option>
                                    <option value="48">MALINALTEPEC</option>
                                    <option value="49">MARQUELIA</option>
                                    <option value="50">M√ÅRTIR DE CUILAPAN</option>
                                    <option value="51">METLATONOC</option>
                                    <option value="52">MOCHITL√ÅN</option>
                                    <option value="53">NUU SAVI</option>
                                    <option value="54">OLINALA</option>
                                    <option value="55">OMETEPEC</option>
                                    <option value="56">PEDRO ASCENCIO ALQUISIRAS</option>
                                    <option value="57">PETATL√ÅN</option>
                                    <option value="58">PILCAYA</option>
                                    <option value="59">PUNGARABATO</option>
                                    <option value="60">QUECHULTENANGO</option>
                                    <option value="61">SAN LUIS ACATL√ÅN</option>
                                    <option value="62">SAN MARCOS</option>
                                    <option value="63">SAN MIGUEL TOTOLAPAN</option>
                                    <option value="64">SAN NICOL√ÅS</option>
                                    <option value="65">SANTA CRUZ DEL RINC√ìN</option>
                                    <option value="66">TAXCO DE ALARC√ìN</option>
                                    <option value="67">TECOANAPA</option>
                                    <option value="68">TECPAN DE GALEANA</option>
                                    <option value="69">TELOLOAPAN</option>
                                    <option value="70">TEPECOACUILCO DE TRUJANO</option>
                                    <option value="71">TETIPAC</option>
                                    <option value="72">TIXTLA DE GUERRERO</option>
                                    <option value="73">TLACOACHISTLAHUACA</option>
                                    <option value="74">TLACOAPA</option>
                                    <option value="75">TLALCHAPA</option>
                                    <option value="76">TLALIXTAQUILLA DE MALDONADO</option>
                                    <option value="77">TLAPA DE COMONFORT</option>
                                    <option value="78">TLAPEHUALA</option>
                                    <option value="79">XALPATLAHUAC</option>
                                    <option value="80">XOCHIHUEHUETL√ÅN</option>
                                    <option value="81">XOCHISTLAHUACA</option>
                                    <option value="82">ZAPOTITL√ÅN TABLAS</option>
                                    <option value="83">ZIHUATANEJO DE AZUETA</option>
                                    <option value="84">ZIRANDARO</option>
                                    <option value="85">ZITLALA</option>
                                </select>
                            </div>
                            <div>
                                <label
                                    class="text-[10px] font-black text-slate-500 uppercase tracking-widest block mb-2">Descripci√≥n
                                    de los Hechos</label>
                                <textarea id="incident-desc" placeholder="Especifica lugar y detalles presenciados..."
                                    class="w-full bg-slate-900 border border-white/10 p-5 rounded-2xl h-44 font-medium outline-none focus:border-red-600 transition"></textarea>
                            </div>
                            <button id="report-btn" onclick="reportIncident()"
                                class="w-full bg-red-600 hover:bg-red-700 p-6 rounded-2xl font-black text-lg shadow-2xl shadow-red-900/20 uppercase tracking-tight transition">Enviar
                                Alerta con Geolocalizaci√≥n</button>
                            <p id="location-status"
                                class="text-[8px] font-black opacity-30 text-center uppercase tracking-widest">
                                Sincronizaci√≥n GPS requerida para validez judicial</p>
                        </div>
                    </div>
                    <div class="space-y-8 flex flex-col">
                        <div
                            class="glass-card flex-1 rounded-[2.5rem] p-10 flex flex-col items-center justify-center text-center opacity-40">
                            <svg class="w-16 h-16 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1"
                                    d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7">
                                </path>
                            </svg>
                            <div class="font-black text-xs uppercase tracking-widest">Mapa de Calor <br> En Desarrollo
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="tab-historico" class="tab-content transition-all">
                <div class="glass-card p-10 rounded-[3rem]">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-6 mb-10">
                        <div>
                            <span class="text-[10px] font-black text-amber-500 uppercase tracking-widest">Archivo
                                Electoral del INE</span>
                            <h3 class="text-3xl font-black italic uppercase tracking-tighter">Memoria <span
                                    class="text-amber-500">Hist√≥rica</span></h3>
                        </div>
                        <select id="muni-selector" onchange="loadHistorical(this.value)"
                            class="bg-slate-900 border border-white/10 p-4 rounded-xl font-black outline-none w-full md:w-80 shadow-xl focus:border-amber-600">
                            <option value="">ESTADO DE GUERRERO (TODO)</option>
                            <option value="1">ACAPULCO DE JU√ÅREZ</option>
                            <option value="2">ACATEPEC</option>
                            <option value="3">AHUACUOTZINGO</option>
                            <option value="4">AJUCHITLAN DEL PROGRESO</option>
                            <option value="5">ALCOZAUCA DE GUERRERO</option>
                            <option value="6">ALPOYECA</option>
                            <option value="7">APAXTLA</option>
                            <option value="8">ARCELIA</option>
                            <option value="9">ATENANGO DEL R√çO</option>
                            <option value="10">ATLAMAJALCINGO DEL MONTE</option>
                            <option value="11">ATLIXTAC</option>
                            <option value="12">ATOYAC DE √ÅLVAREZ</option>
                            <option value="13">AYUTLA DE LOS LIBRES</option>
                            <option value="14">AZOYU</option>
                            <option value="15">BENITO JU√ÅREZ</option>
                            <option value="16">BUENAVISTA DE CU√âLLAR</option>
                            <option value="17">CHILAPA DE √ÅLVAREZ</option>
                            <option value="18">CHILPANCINGO DE LOS BRAVO</option>
                            <option value="19">COAHUAYUTLA DE JOS√â MAR√çA IZAZAGA</option>
                            <option value="20">COCHOAPA EL GRANDE</option>
                            <option value="21">COCULA</option>
                            <option value="22">COPALA</option>
                            <option value="23">COPALILLO</option>
                            <option value="24">COPANATOYAC</option>
                            <option value="25">COYUCA DE BEN√çTEZ</option>
                            <option value="26">COYUCA DE CATAL√ÅN</option>
                            <option value="27">CUAJINICUILAPA</option>
                            <option value="28">CUALAC</option>
                            <option value="29">CUAUTEPEC</option>
                            <option value="30">CUETZALA DEL PROGRESO</option>
                            <option value="31">CUTZAMALA DE PINZ√ìN</option>
                            <option value="32">EDUARDO NERI</option>
                            <option value="33">FLORENCIO VILLARREAL</option>
                            <option value="34">GENERAL CANUTO A. NERI</option>
                            <option value="35">GENERAL HELIODORO CASTILLO</option>
                            <option value="36">HUAMUXTITL√ÅN</option>
                            <option value="37">HUITZUCO DE LOS FIGUEROA</option>
                            <option value="38">IGUALA DE LA INDEPENDENCIA</option>
                            <option value="39">IGUALAPA</option>
                            <option value="40">ILIATENCO</option>
                            <option value="41">IXCATEOPAN DE CUAUHT√âMOC</option>
                            <option value="42">JOS√â JOAQU√çN DE HERRERA</option>
                            <option value="43">JUAN R. ESCUDERO</option>
                            <option value="44">JUCHIT√ÅN</option>
                            <option value="45">LA UNI√ìN DE ISIDORO MONTES DE OCA</option>
                            <option value="46">LAS VIGAS</option>
                            <option value="47">LEONARDO BRAVO</option>
                            <option value="48">MALINALTEPEC</option>
                            <option value="49">MARQUELIA</option>
                            <option value="50">M√ÅRTIR DE CUILAPAN</option>
                            <option value="51">METLATONOC</option>
                            <option value="52">MOCHITL√ÅN</option>
                            <option value="53">NUU SAVI</option>
                            <option value="54">OLINALA</option>
                            <option value="55">OMETEPEC</option>
                            <option value="56">PEDRO ASCENCIO ALQUISIRAS</option>
                            <option value="57">PETATL√ÅN</option>
                            <option value="58">PILCAYA</option>
                            <option value="59">PUNGARABATO</option>
                            <option value="60">QUECHULTENANGO</option>
                            <option value="61">SAN LUIS ACATL√ÅN</option>
                            <option value="62">SAN MARCOS</option>
                            <option value="63">SAN MIGUEL TOTOLAPAN</option>
                            <option value="64">SAN NICOL√ÅS</option>
                            <option value="65">SANTA CRUZ DEL RINC√ìN</option>
                            <option value="66">TAXCO DE ALARC√ìN</option>
                            <option value="67">TECOANAPA</option>
                            <option value="68">TECPAN DE GALEANA</option>
                            <option value="69">TELOLOAPAN</option>
                            <option value="70">TEPECOACUILCO DE TRUJANO</option>
                            <option value="71">TETIPAC</option>
                            <option value="72">TIXTLA DE GUERRERO</option>
                            <option value="73">TLACOACHISTLAHUACA</option>
                            <option value="74">TLACOAPA</option>
                            <option value="75">TLALCHAPA</option>
                            <option value="76">TLALIXTAQUILLA DE MALDONADO</option>
                            <option value="77">TLAPA DE COMONFORT</option>
                            <option value="78">TLAPEHUALA</option>
                            <option value="79">XALPATLAHUAC</option>
                            <option value="80">XOCHIHUEHUETL√ÅN</option>
                            <option value="81">XOCHISTLAHUACA</option>
                            <option value="82">ZAPOTITL√ÅN TABLAS</option>
                            <option value="83">ZIHUATANEJO DE AZUETA</option>
                            <option value="84">ZIRANDARO</option>
                            <option value="85">ZITLALA</option>
                        </select>
                    </div>
                    <div class="grid lg:grid-cols-2 gap-10">
                        <div class="bg-white/5 p-8 rounded-[2rem] border border-white/5 shadow-inner">
                            <h4
                                class="text-[10px] font-black text-slate-500 uppercase mb-6 tracking-[0.2em] text-center">
                                Nivel de Participaci√≥n Hist√≥rica</h4>
                            <div class="h-80"><canvas id="participation-chart"></canvas></div>
                        </div>
                        <div class="bg-white/5 p-8 rounded-[2rem] border border-white/5 shadow-inner">
                            <h4
                                class="text-[10px] font-black text-slate-500 uppercase mb-6 tracking-[0.2em] text-center">
                                Distribuci√≥n de Fuerzas PoliÃÅticas</h4>
                            <div class="h-80"><canvas id="results-chart"></canvas></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="tab-predicciones" class="tab-content transition-all">
                <div class="glass-card p-10 rounded-[3rem]">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-6 mb-10">
                        <div>
                            <span class="text-[10px] font-black text-amber-500 uppercase tracking-widest">Inteligencia
                                Predictiva</span>
                            <h3 class="text-3xl font-black italic uppercase tracking-tighter">Predicciones <span
                                    class="text-amber-500">2027</span></h3>
                        </div>
                        <select id="pred-muni-selector" onchange="loadPredictionsForMunicipality(this.value)"
                            class="bg-slate-900 border border-white/10 p-4 rounded-xl font-black outline-none w-full md:w-80 shadow-xl focus:border-amber-600">
                            <option value="">SELECCIONA MUNICIPIO</option>
                            <option value="1">ACAPULCO DE JU√ÅREZ</option>
                            <option value="2">ACATEPEC</option>
                            <option value="3">AHUACUOTZINGO</option>
                            <option value="4">AJUCHITLAN DEL PROGRESO</option>
                            <option value="5">ALCOZAUCA DE GUERRERO</option>
                            <option value="6">ALPOYECA</option>
                            <option value="7">APAXTLA</option>
                            <option value="8">ARCELIA</option>
                            <option value="9">ATENANGO DEL R√çO</option>
                            <option value="10">ATLAMAJALCINGO DEL MONTE</option>
                            <option value="11">ATLIXTAC</option>
                            <option value="12">ATOYAC DE √ÅLVAREZ</option>
                            <option value="13">AYUTLA DE LOS LIBRES</option>
                            <option value="14">AZOYU</option>
                            <option value="15">BENITO JU√ÅREZ</option>
                            <option value="16">BUENAVISTA DE CU√âLLAR</option>
                            <option value="17">CHILAPA DE √ÅLVAREZ</option>
                            <option value="18">CHILPANCINGO DE LOS BRAVO</option>
                            <option value="19">COAHUAYUTLA DE JOS√â MAR√çA IZAZAGA</option>
                            <option value="20">COCHOAPA EL GRANDE</option>
                            <option value="21">COCULA</option>
                            <option value="22">COPALA</option>
                            <option value="23">COPALILLO</option>
                            <option value="24">COPANATOYAC</option>
                            <option value="25">COYUCA DE BEN√çTEZ</option>
                            <option value="26">COYUCA DE CATAL√ÅN</option>
                            <option value="27">CUAJINICUILAPA</option>
                            <option value="28">CUALAC</option>
                            <option value="29">CUAUTEPEC</option>
                            <option value="30">CUETZALA DEL PROGRESO</option>
                            <option value="31">CUTZAMALA DE PINZ√ìN</option>
                            <option value="32">EDUARDO NERI</option>
                            <option value="33">FLORENCIO VILLARREAL</option>
                            <option value="34">GENERAL CANUTO A. NERI</option>
                            <option value="35">GENERAL HELIODORO CASTILLO</option>
                            <option value="36">HUAMUXTITL√ÅN</option>
                            <option value="37">HUITZUCO DE LOS FIGUEROA</option>
                            <option value="38">IGUALA DE LA INDEPENDENCIA</option>
                            <option value="39">IGUALAPA</option>
                            <option value="40">ILIATENCO</option>
                            <option value="41">IXCATEOPAN DE CUAUHT√âMOC</option>
                            <option value="42">JOS√â JOAQU√çN DE HERRERA</option>
                            <option value="43">JUAN R. ESCUDERO</option>
                            <option value="44">JUCHIT√ÅN</option>
                            <option value="45">LA UNI√ìN DE ISIDORO MONTES DE OCA</option>
                            <option value="46">LAS VIGAS</option>
                            <option value="47">LEONARDO BRAVO</option>
                            <option value="48">MALINALTEPEC</option>
                            <option value="49">MARQUELIA</option>
                            <option value="50">M√ÅRTIR DE CUILAPAN</option>
                            <option value="51">METLATONOC</option>
                            <option value="52">MOCHITL√ÅN</option>
                            <option value="53">NUU SAVI</option>
                            <option value="54">OLINALA</option>
                            <option value="55">OMETEPEC</option>
                            <option value="56">PEDRO ASCENCIO ALQUISIRAS</option>
                            <option value="57">PETATL√ÅN</option>
                            <option value="58">PILCAYA</option>
                            <option value="59">PUNGARABATO</option>
                            <option value="60">QUECHULTENANGO</option>
                            <option value="61">SAN LUIS ACATL√ÅN</option>
                            <option value="62">SAN MARCOS</option>
                            <option value="63">SAN MIGUEL TOTOLAPAN</option>
                            <option value="64">SAN NICOL√ÅS</option>
                            <option value="65">SANTA CRUZ DEL RINC√ìN</option>
                            <option value="66">TAXCO DE ALARC√ìN</option>
                            <option value="67">TECOANAPA</option>
                            <option value="68">TECPAN DE GALEANA</option>
                            <option value="69">TELOLOAPAN</option>
                            <option value="70">TEPECOACUILCO DE TRUJANO</option>
                            <option value="71">TETIPAC</option>
                            <option value="72">TIXTLA DE GUERRERO</option>
                            <option value="73">TLACOACHISTLAHUACA</option>
                            <option value="74">TLACOAPA</option>
                            <option value="75">TLALCHAPA</option>
                            <option value="76">TLALIXTAQUILLA DE MALDONADO</option>
                            <option value="77">TLAPA DE COMONFORT</option>
                            <option value="78">TLAPEHUALA</option>
                            <option value="79">XALPATLAHUAC</option>
                            <option value="80">XOCHIHUEHUETL√ÅN</option>
                            <option value="81">XOCHISTLAHUACA</option>
                            <option value="82">ZAPOTITL√ÅN TABLAS</option>
                            <option value="83">ZIHUATANEJO DE AZUETA</option>
                            <option value="84">ZIRANDARO</option>
                            <option value="85">ZITLALA</option>
                        </select>
                    </div>

                    <div id="predictions-content">
                        <!-- Contenedor para candidatos -->
                        <div id="candidates-grid"
                            class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-12 hidden">
                            <!-- Candidates loaded here -->
                        </div>

                        <!-- Contenedor para resultados -->
                        <div id="predictions-results" class="hidden">
                            <h4 class="text-xl font-black italic uppercase tracking-tighter mb-8 text-center">Ranking de
                                Tendencias</h4>
                            <div id="results-grid" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <!-- Results loaded here -->
                            </div>
                        </div>

                        <!-- Estado inicial -->
                        <div id="predictions-placeholder"
                            class="col-span-full py-20 text-center opacity-20 uppercase font-black italic tracking-widest">
                            Selecciona un municipio para ver candidatos municipales
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- SURVEY MODAL -->
    <div id="survey-modal"
        class="fixed inset-0 z-[100] hidden bg-black/95 backdrop-blur-3xl flex items-center justify-center p-4">
        <div
            class="w-full max-w-5xl glass-card rounded-[3.5rem] border-white/5 max-h-[95vh] overflow-y-auto relative shadow-[0_0_100px_rgba(0,0,0,0.8)] animate-in zoom-in-95 duration-300">
            <button onclick="closeSurvey()"
                class="absolute top-10 right-10 w-12 h-12 flex items-center justify-center rounded-2xl bg-white/5 hover:bg-white/10 text-3xl font-thin transition">&times;</button>
            <div class="p-16">
                <header class="mb-16 border-l-4 border-amber-600 pl-8">
                    <span id="modal-level"
                        class="text-amber-500 font-black uppercase tracking-[0.4em] text-[10px]">C√ÅMARA DE VOTO</span>
                    <h2 id="modal-title"
                        class="text-5xl font-black mt-4 leading-none tracking-tighter uppercase italic">Cruce de <span
                            class="text-amber-500">Tendencias</span></h2>
                </header>

                <div id="modal-content" class="space-y-20">
                    <!-- Dynamic Questions -->
                </div>

                <!-- PANEL RESULTADOS EN VIVO -->
                <div id="live-results-panel" class="mt-12 pt-12 border-t border-white/10 hidden">
                    <div class="flex items-center justify-between mb-8">
                        <h3 class="text-xl font-black uppercase italic text-white">Resultados <span
                                class="text-[#FF8C00]">Preliminares</span></h3>
                        <div class="flex items-center gap-2">
                            <span class="w-2 h-2 bg-[#E63946] rounded-full animate-pulse"></span>
                            <span class="text-[9px] font-bold text-[#B0B0B0] uppercase tracking-widest">Actualizando
                                cada 5s</span>
                        </div>
                    </div>
                    <div class="bg-[#1A2633] p-6 rounded-3xl border border-white/5">
                        <canvas id="resultsChart" style="max-height: 300px;"></canvas>
                    </div>
                    <div class="grid grid-cols-3 gap-4 mt-6">
                        <div class="bg-[#1A2633] p-4 rounded-2xl text-center">
                            <div id="total-votes-live" class="text-2xl font-black text-[#FF8C00]">0</div>
                            <div class="text-[9px] font-bold text-[#B0B0B0] uppercase mt-2">Votos Totales</div>
                        </div>
                        <div class="bg-[#1A2633] p-4 rounded-2xl text-center">
                            <div id="avg-confidence-live" class="text-2xl font-black text-[#FF8C00]">--</div>
                            <div class="text-[9px] font-bold text-[#B0B0B0] uppercase mt-2">Confianza Promedio</div>
                        </div>
                        <div class="bg-[#1A2633] p-4 rounded-2xl text-center">
                            <div id="last-update-live" class="text-xs font-bold text-[#FF8C00]">--:--</div>
                            <div class="text-[9px] font-bold text-[#B0B0B0] uppercase mt-2">√öltima Actualizaci√≥n</div>
                        </div>
                    </div>
                </div>

                <div class="mt-24">
                    <button onclick="submitSurvey()"
                        class="w-full bg-amber-600 p-8 rounded-[2rem] font-black text-2xl shadow-3xl shadow-amber-900/40 hover:bg-amber-700 transition transform hover:scale-[1.02] uppercase tracking-tighter italic">Sellar
                        Predicci√≥n Democr√°tica</button>
                    <p class="text-center text-[8px] font-bold text-slate-500 uppercase tracking-widest mt-6">Este acto
                        es irreversible y queda grabado en la caja negra del sistema</p>
                </div>
            </div>
        </div>
    </div>

    <!-- LOGIC -->
    <script>
        const API_URL = window.location.hostname === 'localhost' 
    ? 'http://localhost:3000/api' 
    : 'https://pulsoguerrero.vercel.app/api';

    let auth_token = localStorage.getItem('guardianToken');
    let userPhone = null;

        const MUNICIPIOS_GUERRERO = [
            { id: 1, name: "Acapulco de Ju√°rez" }, { id: 2, name: "Acatepec" }, { id: 3, name: "Ahuacuotzingo" },
            { id: 4, name: "Ajuchitlan del Progreso" }, { id: 5, name: "Alcozauca de Guerrero" }, { id: 6, name: "Alpoyeca" },
            { id: 7, name: "Apaxtla" }, { id: 8, name: "Arcelia" }, { id: 9, name: "Atenango del R√≠o" },
            { id: 10, name: "Atlamajalcingo del Monte" }, { id: 11, name: "Atlixtac" }, { id: 12, name: "Atoyac de √Ålvarez" },
            { id: 13, name: "Ayutla de los Libres" }, { id: 14, name: "Azoyu" }, { id: 15, name: "Benito Ju√°rez" },
            { id: 16, name: "Buenavista de Cu√©llar" }, { id: 17, name: "Chilapa de √Ålvarez" }, { id: 18, name: "Chilpancingo de los Bravo" },
            { id: 19, name: "Coahuayutla de Jos√© Mar√≠a Izazaga" }, { id: 20, name: "Cochoapa el Grande" }, { id: 21, name: "Cocula" },
            { id: 22, name: "Copala" }, { id: 23, name: "Copalillo" }, { id: 24, name: "Copanatoyac" },
            { id: 25, name: "Coyuca de Ben√≠tez" }, { id: 26, name: "Coyuca de Catal√°n" }, { id: 27, name: "Cuajinicuilapa" },
            { id: 28, name: "Cualac" }, { id: 29, name: "Cuautepec" }, { id: 30, name: "Cuetzala del Progreso" },
            { id: 31, name: "Cutzamala de Pinz√≥n" }, { id: 32, name: "Eduardo Neri" }, { id: 33, name: "Florencio Villarreal" },
            { id: 34, name: "General Canuto A. Neri" }, { id: 35, name: "General Heliodoro Castillo" }, { id: 36, name: "Huamuxtitl√°n" },
            { id: 37, name: "Huitzuco de los Figueroa" }, { id: 38, name: "Iguala de la Independencia" }, { id: 39, name: "Igualapa" },
            { id: 40, name: "Iliatenco" }, { id: 41, name: "Ixcateopan de Cuauht√©moc" }, { id: 42, name: "Jos√© Joaqu√≠n de Herrera" },
            { id: 43, name: "Juan R. Escudero" }, { id: 44, name: "Juchit√°n" }, { id: 45, name: "La Uni√≥n de Isidoro Montes de Oca" },
            { id: 46, name: "Las Vigas" }, { id: 47, name: "Leonardo Bravo" }, { id: 48, name: "Malinaltepec" },
            { id: 49, name: "Marquelia" }, { id: 50, name: "M√°rtir de Cuilapan" }, { id: 51, name: "Metlatonoc" },
            { id: 52, name: "Mochitl√°n" }, { id: 53, name: "Nuu Savi" }, { id: 54, name: "Olinala" },
            { id: 55, name: "Ometepec" }, { id: 56, name: "Pedro Ascencio Alquisiras" }, { id: 57, name: "Petatl√°n" },
            { id: 58, name: "Pilcaya" }, { id: 59, name: "Pungarabato" }, { id: 60, name: "Quechultenango" },
            { id: 61, name: "San Luis Acatl√°n" }, { id: 62, name: "San Marcos" }, { id: 63, name: "San Miguel Totolapan" },
            { id: 64, name: "San Nicol√°s" }, { id: 65, name: "Santa Cruz del Rinc√≥n" }, { id: 66, name: "Taxco de Alarc√≥n" },
            { id: 67, name: "Tecoanapa" }, { id: 68, name: "Tecpan de Galeana" }, { id: 69, name: "Teloloapan" },
            { id: 70, name: "Tepecoacuilco de Trujano" }, { id: 71, name: "Tetipac" }, { id: 72, name: "Tixtla de Guerrero" },
            { id: 73, name: "Tlacoachistlahuaca" }, { id: 74, name: "Tlacoapa" }, { id: 75, name: "Tlalchapa" },
            { id: 76, name: "Tlalixtaquilla de Maldonado" }, { id: 77, name: "Tlapa de Comonfort" }, { id: 78, name: "Tlapehuala" },
            { id: 79, name: "Xalpatlahuac" }, { id: 80, name: "Xochihuehuetl√°n" }, { id: 81, name: "Xochistlahuaca" },
            { id: 82, name: "Zapotitl√°n Tablas" }, { id: 83, name: "Zihuatanejo de Azueta" }, { id: 84, name: "Zirandaro" },
            { id: 85, name: "Zitlala" }
        ];

        const ASPIRANTES = [
            { id: "felix_salgado", name: "F√©lix Salgado", party: "Morena", img: "/img/felix_salgado.jpg" },
            { id: "esthela_damian", name: "Esthela Damian Peralta", party: "Morena", img: "/img/esthela_damian.jpg" },
            { id: "beatriz_mojica", name: "Beatriz Mojica", party: "Morena", img: "/img/beatriz_mojica.jpg" },
            { id: "abelina_lopez", name: "Abelina Lopez Rodriguez", party: "Morena", img: "/img/abelina_lopez.jpg" },
            { id: "victoriano_wences", name: "Victoriano Wences Real", party: "PT", img: "/img/victoriano_wences.jpg" },
            { id: "ruben_cayetano", name: "Ruben Cayetano Garcia", party: "Morena", img: "/img/ruben_cayetano.jpg" },
            { id: "pablo_sandoval", name: "Pablo Amilcar Sandoval", party: "Morena", img: "/img/pablo_sandoval.jpg" },
            { id: "jacinto_gonzalez", name: "Jacinto Gonzalez Varona", party: "Morena", img: "/img/jacinto_gonzalez.jpg" },
            { id: "karen_castrejon", name: "Karen Castrej√≥n Trujillo", party: "PVEM", img: "/img/karen_castrejon.jpg" },
            { id: "gabriela_bernal", name: "Gabriela Bernal Resendiz", party: "MC", img: "/img/gabriela_bernal.jpg" },
            { id: "manuel_anorve", name: "Manuel A√±orve Ba√±os", party: "PRI", img: "/img/manuel_anorve.jpg" },
            { id: "pedro_segura", name: "Pedro Segura Valladares", party: "Independiente", img: "/img/pedro_segura.jpg" },
            { id: "aun_no_decido", name: "A√∫n no decido", party: "Indeciso", img: "null" }
        ];

      

        async function showPortal() {
            document.getElementById('auth-section').classList.add('hidden');
            document.getElementById('portal-section').classList.remove('hidden');
            document.getElementById('user-info').classList.remove('hidden');

            // Cargar datos reales si ya tenemos token pero no pasamos por verifyCode (ej: reload)
            if (!document.getElementById('user-points').textContent.includes('PTS')) {
                try {
                    const res = await fetch(`${API_URL}/auth/me`, {
                        headers: { 'Authorization': `Bearer ${auth_token}` }
                    });
                    if (res.ok) {
                        const user = await res.json();
                        document.getElementById('user-points').textContent = `${user.points || 0} PTS de Influencia`;
                    } else {
                        return logout(); // Token expirado
                    }
                } catch (e) { }
            }

            loadSurveys();
            populateMunicipios();
        }

        // --- DASHBOARD ---
        async function loadSurveys() {
            try {
                console.log('üîÑ Cargando encuestas activas...');
                const res = await fetch(`${API_URL}/surveys/active`);
                const data = await res.json();

                console.log('üìä Respuesta de /api/surveys/active:', data);

                const grid = document.getElementById('surveys-grid');

                if (!data.surveys || data.surveys.length === 0) {
                    grid.innerHTML = '<div class="col-span-full border-2 border-dashed border-white/5 rounded-[3rem] p-20 text-center uppercase font-black opacity-10 tracking-[0.5em] italic">Sin Encuestas Activas</div>';
                    return;
                }

                grid.innerHTML = data.surveys.map(s => {
                    const typeLabel = s.electionType === 'gubernatura' ? 'ESTATAL' : 'MUNICIPAL';
                    const typeColor = s.electionType === 'gubernatura' ? 'amber' : 'emerald';

                    return `
                        <div onclick="openSurvey(${s.id})" class="glass-card p-10 rounded-[2.5rem] cursor-pointer hover:bg-slate-900 border-white/5 transition-all group relative overflow-hidden">
                          <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-100 transition">
                            <svg class="w-20 h-20 text-${typeColor}-500" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 01-3-3h6a3 3 0 01-3 3z"></path></svg>
                          </div>
                          <span class="bg-${typeColor}-600/10 text-${typeColor}-500 font-extrabold text-[9px] px-3 py-1 rounded-full uppercase tracking-widest border border-${typeColor}-600/20">${typeLabel}</span>
                          <h3 class="text-3xl font-black mt-6 tracking-tight group-hover:text-${typeColor}-500 transition-colors uppercase italic">${s.title}</h3>
                          <p class="mt-4 text-slate-500 text-sm font-medium line-clamp-2">${s.description || 'Consulta ciudadana para la planeaci√≥n democr√°tica de Guerrero 2027.'}</p>
                          <div class="mt-10 flex justify-between items-end">
                            <div>
                              <div class="text-[8px] font-black text-slate-600 uppercase tracking-[0.2em] mb-1">Impacto</div>
                              <span class="text-${typeColor}-500 font-black text-xl italic">${s.totalRespondents || 0} <span class="text-xs uppercase not-italic tracking-widest opacity-40 ml-1">Votos</span></span>
                            </div>
                            <span class="w-12 h-12 rounded-2xl bg-${typeColor}-600 flex items-center justify-center group-hover:translate-x-2 transition-transform shadow-lg shadow-${typeColor}-900/40">
                              <svg class="w-6 h-6 text-slate-950" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
                            </span>
                          </div>
                        </div>
                    `;
                }).join('');

            } catch (e) {
                console.error('‚ùå Error cargando encuestas:', e);
                showToast('Falla de Red al cargar encuestas', 'error');
            }
        }

        async function openSurvey(id) {
            try {
                currentSurveyId = id;
                document.getElementById('survey-modal').classList.remove('hidden');
                document.body.style.overflow = 'hidden';

                const content = document.getElementById('modal-content');
                content.innerHTML = '<div class="text-center py-20 opacity-40 font-black uppercase tracking-widest">Cargando encuesta...</div>';

                const res = await fetch(`${API_URL}/surveys/${id}/questions`);
                const data = await res.json();

                if (!res.ok) throw new Error(data.error);
                if (!data.survey) throw new Error('Estructura de datos incorrecta');

                document.getElementById('modal-title').innerHTML = `${data.survey.title.split(' ')[0]} <span class="text-amber-500">${data.survey.title.split(' ').slice(1).join(' ')}</span>`;
                document.getElementById('modal-level').textContent = data.survey.electionType === 'gubernatura' ? 'NIVEL ESTATAL' : 'NIVEL MUNICIPAL';

                // ‚úÖ CARGAR CANDIDATOS DIN√ÅMICAMENTE DESDE LA BD
                let candidates = [];
                let candidateGridRendered = false;

                if (data.survey.electionType === 'gubernatura') {
                    // Cargar candidatos de gubernatura
                    try {
                        const candidatesRes = await fetch(`${API_URL}/data/candidates/gubernatura`);
                        if (candidatesRes.ok) {
                            const candidatesData = await candidatesRes.json();
                            console.log('‚úÖ Candidatos gubernatura:', candidatesData);
                            candidates = candidatesData.map(c => {
                                // Si la BD no tiene foto, buscar en ASPIRANTES por nombre
                                let imgPath = c.photo_url || c.img || null;
                                if (!imgPath) {
                                    const match = ASPIRANTES.find(a =>
                                        a.name.toLowerCase().includes(c.name.toLowerCase().split(' ')[0]) ||
                                        c.name.toLowerCase().includes(a.name.toLowerCase().split(' ')[0])
                                    );
                                    if (match && match.img) imgPath = match.img;
                                }
                                return { id: c.id, name: c.name, party: c.party, img: imgPath };
                            });
                        } else {
                            console.error('‚ùå Error fetch gubernatura:', candidatesRes.status);
                        }
                    } catch (e) {
                        console.error('‚ùå Error cargando candidatos gubernatura:', e);
                    }
                } else {
                    // Cargar candidatos municipales
                    const munId = data.survey.municipalityId || data.survey.municipality_id;

                    if (!munId) {
                        console.error('‚ùå No hay municipalityId para encuesta municipal');
                        candidates = [];
                    } else {
                        try {
                            const candidatesRes = await fetch(`${API_URL}/data/candidates/${munId}`);
                            if (candidatesRes.ok) {
                                const candidatesData = await candidatesRes.json();
                                console.log('‚úÖ Candidatos municipales:', candidatesData);
                                candidates = candidatesData.map(c => ({
                                    id: c.id,
                                    name: c.name,
                                    party: c.party,
                                    img: c.photo_url || c.img || null
                                }));
                            } else {
                                console.error('‚ùå Error fetch candidatos:', candidatesRes.status);
                                candidates = [];
                            }
                        } catch (e) {
                            console.error('‚ùå Error cargando candidatos municipales:', e);
                            candidates = [];
                        }
                    }
                }


                // Verificar que hay candidatos
                if (candidates.length === 0) {
                    console.warn('‚ö†Ô∏è No se encontraron candidatos para renderizar');
                    if (data.survey.electionType === 'gubernatura') {
                        candidates = ASPIRANTES; // Fallback
                        console.log('üìå Usando ASPIRANTES fallback');
                    }
                }

                console.log('üìä Total candidatos a renderizar:', candidates.length);
                console.log('üìã Candidatos:', candidates);

                content.innerHTML = data.questions.map((q, qIdx) => {
                    // Manejo de preguntas de opci√≥n √∫nica/m√∫ltiple
                    if (q.questionType === 'choice' || q.questionType === 'single_choice' || q.questionType === 'candidate_selection') {

                        // ‚úÖ VERIFICAR SI LA PREGUNTA TIENE OPCIONES PROPIAS
                        let customOptions = [];
                        try {
                            if (q.options) {
                                customOptions = typeof q.options === 'string' ? JSON.parse(q.options) : q.options;
                            }
                        } catch (e) {
                            console.warn('Error parseando opciones de pregunta:', q.id, e);
                        }

                        // ‚úÖ CASO 1: Pregunta con candidatos (tiene photo)
                        if (customOptions && customOptions.length > 0 && customOptions[0].photo) {
                            console.log(`‚úÖ [ADMIN] Candidatos en options: ${customOptions.length}`);

                            return `
                                <div class="space-y-10 animate-in slide-in-from-bottom-4 duration-500" style="animation-delay: ${qIdx * 0.1}s">
                                    <div class="flex items-center gap-4">
                                        <div class="w-12 h-12 rounded-2xl bg-amber-600 flex items-center justify-center font-black text-slate-950 text-xl shadow-lg shadow-amber-900/40">${qIdx + 1}</div>
                                        <h4 class="text-3xl font-black uppercase tracking-tighter italic">${q.questionText}</h4>
                                    </div>
                                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-6">
                                        ${customOptions.map(opt => {
                                const label = opt.label || opt.name || opt.value || 'Sin nombre';
                                const photo = opt.photo || opt.photo_url || opt.img || null;
                                const value = opt.value || opt.label || label;

                                return `
                                                <div onclick="selectOption(${q.id}, '${value.replace(/'/g, "\\'")}', this)" 
                                                     data-question="${q.id}" 
                                                     class="option-card candidate-card glass-card p-6 rounded-3xl text-center group transition-all cursor-pointer hover:scale-[1.03] active:scale-95 border border-white/5 relative overflow-hidden">
                                                    <div class="absolute inset-0 bg-gradient-to-b from-transparent to-amber-900/10 opacity-0 group-hover:opacity-100 transition"></div>
                                                    <div class="relative w-28 h-28 mx-auto mb-6 rounded-full p-1 border-2 border-white/10 group-hover:border-amber-500 transition-colors shadow-2xl">
                                                        <div class="w-full h-full rounded-full overflow-hidden bg-slate-900">
                                                            ${photo ?
                                        `<img src="${photo}" class="w-full h-full object-cover" onerror="this.parentElement.innerHTML='<div class=&quot;w-full h-full flex items-center justify-center text-4xl font-black text-slate-700 bg-slate-800&quot;>${label.charAt(0)}</div>'">` :
                                        `<div class="w-full h-full flex items-center justify-center text-4xl font-black text-slate-700 bg-slate-800">${label.charAt(0)}</div>`
                                    }
                                                        </div>
                                                    </div>
                                                    <h5 class="text-sm font-black uppercase tracking-tight text-white mb-2 line-clamp-2">${label}</h5>
                                                    <input type="radio" name="q-${q.id}" value="${value.replace(/'/g, "\\'")}" class="hidden">
                                                </div>
                                            `;
                            }).join('')}
                                    </div>
                                </div>
                            `;
                        }

                        // ‚úÖ CASO 2: Pregunta con opciones simples (sin photo)
                        if (customOptions && customOptions.length > 0 && !customOptions[0].photo) {
                            return `
                                <div class="space-y-8 animate-in slide-in-from-bottom-4 duration-500" style="animation-delay: ${qIdx * 0.1}s">
                                    <div class="flex items-center gap-4">
                                        <div class="w-10 h-10 rounded-full bg-amber-600 flex items-center justify-center font-black text-slate-950">${qIdx + 1}</div>
                                        <h4 class="text-2xl font-black uppercase tracking-tighter">${q.questionText}</h4>
                                    </div>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        ${customOptions.map(opt => {
                                const label = typeof opt === 'object' ? (opt.text || opt.label || opt.name || JSON.stringify(opt)) : opt;
                                const val = typeof opt === 'object' ? (opt.id || opt.value || label) : opt;
                                return `
                                                <div onclick="selectOption(${q.id}, '${val}', this)" 
                                                     data-question="${q.id}" 
                                                     class="option-card glass-card p-6 rounded-2xl flex items-center gap-4 cursor-pointer hover:bg-amber-600/10 transition-all border border-white/5">
                                                    <div class="w-6 h-6 rounded-full border-2 border-amber-600/30 flex items-center justify-center">
                                                        <div class="w-3 h-3 rounded-full bg-amber-600 opacity-0 transition"></div>
                                                    </div>
                                                    <span class="font-bold text-lg uppercase italic">${label}</span>
                                                    <input type="radio" name="q-${q.id}" value="${val}" class="hidden">
                                                </div>
                                            `;
                            }).join('')}
                                    </div>
                                </div>
                            `;
                        }

                        // ‚úÖ CASO 3: Pregunta sin opciones - Usar candidatos de BD
                        const isReasonQuestion = q.questionText.toLowerCase().includes('raz√≥n') ||
                            q.questionText.toLowerCase().includes('motivo') ||
                            q.questionText.toLowerCase().includes('reason');

                        if (candidateGridRendered) {
                            if (isReasonQuestion) {
                                return `
                                    <div class="space-y-6">
                                        <div class="flex items-center gap-4">
                                            <div class="w-10 h-10 rounded-full bg-slate-800 flex items-center justify-center font-black text-slate-500">${qIdx + 1}</div>
                                            <h4 class="text-xl font-bold text-slate-400 italic">${q.questionText}</h4>
                                        </div>
                                        <textarea class="survey-input w-full p-6 bg-slate-900/50 rounded-2xl border border-white/10" 
                                                  placeholder="Escribe aqu√≠ tu motivo..."
                                                  data-question-id="${q.id}"
                                                  oninput="surveyResponses[${q.id}] = this.value"></textarea>
                                    </div>
                                `;
                            } else {
                                console.log(`‚ö†Ô∏è [DEBUG] Pregunta duplicada saltada: "${q.questionText}"`);
                                return '';
                            }
                        }

                        candidateGridRendered = true;

                        if (candidates.length === 0) {
                            return `
                                <div class="space-y-8">
                                    <div class="flex items-center gap-4">
                                        <div class="w-10 h-10 rounded-full bg-amber-600 flex items-center justify-center font-black text-slate-950">${qIdx + 1}</div>
                                        <h4 class="text-2xl font-black uppercase tracking-tighter">${q.questionText}</h4>
                                    </div>
                                    <div class="p-10 border-2 border-dashed border-white/5 rounded-3xl text-center opacity-40 uppercase font-bold tracking-widest text-sm text-amber-500/60">
                                        Candidatos no detectados en la BD para este municipio
                                    </div>
                                </div>
                            `;
                        }

                        return `
                            <div class="space-y-10 animate-in slide-in-from-bottom-4 duration-500" style="animation-delay: ${qIdx * 0.1}s">
                                <div class="flex items-center gap-4">
                                    <div class="w-12 h-12 rounded-2xl bg-amber-600 flex items-center justify-center font-black text-slate-950 text-xl shadow-lg shadow-amber-900/40">${qIdx + 1}</div>
                                    <h4 class="text-3xl font-black uppercase tracking-tighter italic">${q.questionText}</h4>
                                </div>
                                <div class="grid grid-cols-2 lg:grid-cols-4 gap-6">
                                    ${candidates.map(c => `
                                        <div onclick="selectOption(${q.id}, '${c.id}', this)" 
                                             data-question="${q.id}" 
                                             class="option-card candidate-card glass-card p-6 rounded-3xl text-center group transition-all cursor-pointer hover:scale-[1.03] active:scale-95 border border-white/5 relative overflow-hidden">
                                            <div class="absolute inset-0 bg-gradient-to-b from-transparent to-amber-900/10 opacity-0 group-hover:opacity-100 transition"></div>
                                            <div class="relative w-28 h-28 mx-auto mb-6 rounded-full p-1 border-2 border-white/10 group-hover:border-amber-500 transition-colors shadow-2xl">
                                                <div class="w-full h-full rounded-full overflow-hidden bg-slate-900">
                                                    ${c.img ?
                                `<img src="${c.img}" class="w-full h-full object-cover" onerror="this.parentElement.innerHTML='<div class=&quot;w-full h-full flex items-center justify-center text-4xl font-black text-slate-700 bg-slate-800&quot;>${c.name.charAt(0)}</div>'">` :
                                `<div class="w-full h-full flex items-center justify-center text-4xl font-black text-slate-700 bg-slate-800">${c.name.charAt(0)}</div>`
                            }
                                                </div>
                                            </div>
                                            <h5 class="text-sm font-black uppercase tracking-tight text-white mb-2 line-clamp-1">${c.name}</h5>
                                            <div class="inline-block px-3 py-1 rounded-full bg-white/5 border border-white/10">
                                                <span class="text-[10px] font-black text-amber-500 uppercase tracking-widest">${c.party}</span>
                                            </div>
                                            <input type="radio" name="q-${q.id}" value="${c.id}" class="hidden">
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    }

                    // Pregunta de Confianza
                    if (q.questionType === 'confidence_scale') {
                        return `
                            <div class="space-y-12 animate-in slide-in-from-bottom-4 duration-500" style="animation-delay: ${qIdx * 0.1}s">
                                <div class="flex items-center gap-4 mb-4">
                                    <div class="w-12 h-12 rounded-2xl bg-amber-600 flex items-center justify-center font-black text-slate-950 text-xl shadow-lg shadow-amber-900/40">${qIdx + 1}</div>
                                    <h4 class="text-3xl font-black uppercase tracking-tighter italic">${q.questionText}</h4>
                                </div>
                                
                                <div class="text-center mb-6">
                                    <p class="text-slate-400 text-sm font-medium">
                                        üéØ Desliza el control para indicar qu√© tan seguro est√°s de tu decisi√≥n
                                    </p>
                                </div>
                                
                                <div class="max-w-2xl mx-auto p-12 glass-card rounded-[3rem] border-white/5 relative">
                                    <div class="flex justify-between items-center mb-12">
                                        <div class="text-center">
                                            <div class="text-[10px] font-black text-slate-500 uppercase tracking-[0.3em] mb-2">Nivel</div>
                                            <div class="text-sm font-bold text-slate-300">DUDOSO</div>
                                        </div>
                                        <div class="text-center">
                                            <div class="text-7xl font-black text-amber-500 italic drop-shadow-[0_0_20px_rgba(217,119,6,0.3)]">
                                                <span id="conf-val-${q.id}">50</span>%
                                            </div>
                                            <div class="text-xs text-slate-500 mt-2 font-bold uppercase tracking-widest" id="conf-label-${q.id}">Moderado</div>
                                        </div>
                                        <div class="text-center">
                                            <div class="text-[10px] font-black text-slate-500 uppercase tracking-[0.3em] mb-2">Nivel</div>
                                            <div class="text-sm font-bold text-amber-500">SEGURO</div>
                                        </div>
                                    </div>
                                    <input type="range" min="0" max="100" value="50" 
                                           class="survey-input w-full h-4 bg-slate-800 rounded-full appearance-none cursor-pointer accent-amber-500" 
                                           data-question-id="${q.id}" 
                                           data-type="confidence"
                                           oninput="
                                               document.getElementById('conf-val-${q.id}').textContent = this.value;
                                               const labels = {
                                                   0: 'Muy Dudoso', 10: 'Muy Dudoso', 20: 'Muy Dudoso',
                                                   30: 'Dudoso', 40: 'Dudoso',
                                                   50: 'Moderado', 60: 'Moderado',
                                                   70: 'Seguro', 80: 'Seguro',
                                                   90: 'Muy Seguro', 100: 'Muy Seguro'
                                               };
                                               const val = Math.round(this.value / 10) * 10;
                                               document.getElementById('conf-label-${q.id}').textContent = labels[val] || 'Moderado';
                                           ">
                                    <div class="flex justify-between mt-4 text-xs text-slate-600 font-bold uppercase tracking-widest">
                                        <span>0%</span>
                                        <span>25%</span>
                                        <span>50%</span>
                                        <span>75%</span>
                                        <span>100%</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    }

                    return '';
                }).join('');

                startLivePolling(id);

            } catch (e) {
                console.error('‚ùå ERROR CR√çTICO en openSurvey:', e);
                showToast('Error al cargar encuesta: ' + e.message, 'error');
                closeSurvey();
            }
        }


        let surveyResponses = {};

        function selectOption(qId, val, el) {
            document.querySelectorAll(`.option-card[data-question="${qId}"]`).forEach(c => {
                c.classList.remove('ring-4', 'ring-amber-500', 'bg-slate-900');
                const radio = c.querySelector('input[type="radio"]');
                if (radio) radio.checked = false;
            });

            el.classList.add('ring-4', 'ring-amber-500', 'bg-slate-900');
            const radio = el.querySelector('input[type="radio"]');
            if (radio) radio.checked = true;

            surveyResponses[qId] = val;
            showToast('Candidato Seleccionado');
        }

        // ====== RESULTADOS EN VIVO ======
        let chartInstance = null;
        let pollInterval = null;

        async function fetchLiveResults(surveyId) {
            try {
                const response = await fetch(`${API_URL}/surveys/${surveyId}/results`);
                if (!response.ok) return null;
                return await response.json();
            } catch (error) {
                console.log('Sin resultados a√∫n:', error);
                return null;
            }
        }

      function updateLiveChart(data) {
    if (!data || !data.candidates) return;

    const ctx = document.getElementById('resultsChart')?.getContext('2d');
    if (!ctx) return;

    // Usar directamente el nombre de los candidatos que viene del backend
    const labels = data.candidates.map(c => {
        // Primer nombre para hacerlo compacto en la gr√°fica
        if (c.name && typeof c.name === 'string') {
            const parts = c.name.trim().split(/\s+/);
            return parts[0]; // EJ: "Gustavo Alarc√≥n Herrera" ‚Üí "Gustavo"
        }
        return `CAND ${c.id}`; // Fallback por si faltara nombre
    });

    const votes = data.candidates.map(c => c.votes || 0);

    // Destruir gr√°fico anterior si existe
    if (chartInstance) chartInstance.destroy();

    // Crear nuevo gr√°fico
    chartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Votos',
                data: votes,
                backgroundColor: labels.map((_, i) =>
                    ['#FF8C00', '#E63946', '#A78BFA', '#4CAF50', '#FFC107'][i % 5]
                ),
                borderRadius: 8,
                borderSkipped: false
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { display: false }
            },
            scales: {
                x: {
                    beginAtZero: true,
                    ticks: { color: '#B0B0B0' },
                    grid: { color: 'rgba(255, 255, 255, 0.05)' }
                },
                y: {
                    ticks: { color: '#B0B0B0' }
                }
            }
        }
    });

    // Actualizar contadores
    const totalVotesEl       = document.getElementById('total-votes-live');
    const avgConfidenceEl    = document.getElementById('avg-confidence-live');
    const lastUpdateEl       = document.getElementById('last-update-live');

    if (totalVotesEl)    totalVotesEl.textContent    = data.totalVotes || 0;
    if (avgConfidenceEl) avgConfidenceEl.textContent = (data.avgConfidence || 0).toFixed(1);
    if (lastUpdateEl)    lastUpdateEl.textContent    = new Date().toLocaleTimeString('es-MX');
}  

        function startLivePolling(surveyId) {
            const panel = document.getElementById('live-results-panel');
            if (!panel) return;

            // Mostrar panel
            panel.classList.remove('hidden');

            // Fetch inicial
            fetchLiveResults(surveyId).then(data => {
                if (data) updateLiveChart(data);
            });

            // Poll cada 5 segundos
            if (pollInterval) clearInterval(pollInterval);
            pollInterval = setInterval(() => {
                fetchLiveResults(surveyId).then(data => {
                    if (data) updateLiveChart(data);
                });
            }, 5000);
        }

        function stopLivePolling() {
            if (pollInterval) clearInterval(pollInterval);
            pollInterval = null;
            const panel = document.getElementById('live-results-panel');
            if (panel) panel.classList.add('hidden');
        }
        // ====== FIN RESULTADOS EN VIVO ======

        async function submitSurvey() {
            const inputs = document.querySelectorAll('.survey-input');
            const responses = [];

            // Recoger respuestas de inputs (texto, sliders de confianza, etc.)
            inputs.forEach(input => {
                const qId = parseInt(input.dataset.questionId);
                const type = input.dataset.type;
                const value = input.value;

                const response = { questionId: qId, answer: value };
                if (type === 'confidence') {
                    response.confidence = parseInt(value);
                }
                responses.push(response);
            });

            // Recoger respuestas de clics (las guardadas en surveyResponses)
            Object.entries(surveyResponses).forEach(([qId, val]) => {
                const qIdInt = parseInt(qId);
                if (!responses.find(r => r.questionId === qIdInt)) {
                    responses.push({
                        questionId: qIdInt,
                        answer: val
                    });
                }
            });

            if (responses.length === 0) return showToast('Error: Responde al menos una pregunta', 'error');

            try {
                const res = await fetch(`${API_URL}/surveys/${currentSurveyId}/response`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${auth_token}` },
                    body: JSON.stringify({ responses })
                });

                const data = await res.json();
                if (res.ok) {
                    showToast('‚úÖ Sello Digital Verificado: +50 PTS', 'success');
                    if (data.pointsEarned) {
                        const ptsEl = document.getElementById('user-points');
                        const current = parseInt(ptsEl.textContent.replace(/[^\d]/g, '')) || 0;
                        ptsEl.textContent = `${current + data.pointsEarned} PTS de Influencia`;
                    }
                    closeSurvey();
                    loadSurveys();
                } else {
                    showToast('‚ùå Error: ' + (data.error || 'Falla en el env√≠o'), 'error');
                }
            } catch (e) { showToast('Fallo de Sincronizaci√≥n', 'error'); }
        }

        function closeSurvey() {
            stopLivePolling();
            document.getElementById('survey-modal').classList.add('hidden');
            document.body.style.overflow = 'auto';
        }

        // --- INCIDENTS ---
        async function reportIncident() {
            const desc = document.getElementById('incident-desc').value.trim();
            const type = document.getElementById('incident-type').value;
            const municipalityId = document.getElementById('incident-muni-selector').value;

            if (!municipalityId) return showToast('Selecciona un municipio para el reporte', 'error');
            if (!desc) return showToast('Escribe una descripci√≥n de los hechos', 'error');

            const btn = document.getElementById('report-btn');
            btn.disabled = true;
            btn.textContent = 'TRIANGULANDO GPS...';

            navigator.geolocation.getCurrentPosition(async (pos) => {
                const { latitude, longitude } = pos.coords;
                try {
                    const res = await fetch(`${API_URL}/incidents`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${auth_token}` },
                        body: JSON.stringify({
                            description: desc,
                            latitude,
                            longitude,
                            type,
                            municipalityId: parseInt(municipalityId)
                        })
                    });
                    const data = await res.json();
                    if (res.ok) {
                        showToast('‚úÖ Alerta Ciudadana Activada: +50 PTS', 'success');
                        document.getElementById('incident-desc').value = '';
                        // Actualizar puntos en UI
                        const ptsEl = document.getElementById('user-points');
                        const current = parseInt(ptsEl.textContent.replace(/[^\d]/g, '')) || 0;
                        ptsEl.textContent = `${current + (data.pointsEarned || 50)} PTS de Influencia`;
                    } else {
                        showToast('Error: ' + (data.error || 'Falla en el reporte'), 'error');
                    }
                } catch (e) { showToast('Error de red', 'error'); }
                btn.disabled = false;
                btn.textContent = 'Enviar Alerta con Geolocalizaci√≥n';
            }, (err) => {
                showToast('Error GPS: Requerido para veracidad', 'error');
                btn.disabled = false;
                btn.textContent = 'Enviar Alerta con Geolocalizaci√≥n';
            }, { enableHighAccuracy: true, timeout: 5000 });
        }

        let charts = {};

        function renderCharts(data) {
            const chartConfig = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { ticks: { color: 'rgba(255,255,255,0.4)', font: { size: 9, weight: 'bold' } }, grid: { display: false } },
                    y: { ticks: { color: 'rgba(255,255,255,0.4)', font: { size: 9 } }, grid: { color: 'rgba(255,255,255,0.05)' } }
                }
            };

            // Part Chart ‚Äî solo si hay datos de participaci√≥n
            if (charts.part) charts.part.destroy();
            if (data.participation && data.participation.length > 0) {
                charts.part = new Chart(document.getElementById('participation-chart'), {
                    type: 'line',
                    data: {
                        labels: data.participation.map(p => p.year),
                        datasets: [{
                            data: data.participation.map(p => parseFloat(p.participacion) || 0),
                            borderColor: '#ca8a04',
                            backgroundColor: 'rgba(202, 138, 4, 0.1)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: chartConfig
                });
            }

            // Results Chart - Distribuci√≥n de Fuerzas Pol√≠ticas
            if (charts.res) charts.res.destroy();
            if (!data.comparison || data.comparison.length === 0) {
                showToast('Visualizaci√≥n hist√≥rica actualizada');
                return;
            }

            // Transformar datos del endpoint a formato esperado
            const comparisonGrouped = {};

            data.comparison.forEach(row => {
                const tipo = row.tipo_eleccion;
                const year = row.election_year.toString();
                const votes = parseFloat(row.votes || 0);

                if (!comparisonGrouped[tipo]) {
                    comparisonGrouped[tipo] = {
                        tipo_eleccion: tipo,
                        '2024': 0,
                        '2021': 0,
                        '2018': 0
                    };
                }

                // Sumar votos por a√±o
                if (comparisonGrouped[tipo][year] !== undefined) {
                    comparisonGrouped[tipo][year] += votes;
                }
            });

            const comparisonArray = Object.values(comparisonGrouped);

            console.log('üìä Comparaci√≥n transformada:', comparisonArray);

            // Crear labels √∫nicos (sin duplicados)
            const labels = comparisonArray.map(p => {
                // Simplificar nombres
                const nombre = p.tipo_eleccion;
                if (nombre.includes('Presidencias')) return 'Ayuntamientos';
                if (nombre.includes('Diputaciones')) return 'Diputaci√≥n Local';
                if (nombre.includes('Gubernatura')) return 'Gubernatura';
                return nombre;
            });

            const years = ['2024', '2021', '2018'];
            const datasets = years.map((year, idx) => ({
                label: year,
                data: comparisonArray.map(p => p[year] || 0),
                backgroundColor: idx === 0 ? '#ca8a04' : (idx === 1 ? '#b8860b' : '#8b4513'),
                borderRadius: 5
            }));

            charts.res = new Chart(document.getElementById('results-chart'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    ...chartConfig,
                    plugins: {
                        legend: {
                            display: true,
                            labels: {
                                color: 'white',
                                font: { size: 10, weight: 'bold' }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: (context) => {
                                    const value = context.parsed.y;
                                    return `${context.dataset.label}: ${value.toLocaleString()} votos`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: 'rgba(255,255,255,0.4)',
                                callback: function (value) {
                                    return value.toLocaleString();
                                }
                            },
                            grid: { color: 'rgba(255,255,255,0.05)' }
                        },
                        x: {
                            ticks: {
                                color: 'rgba(255,255,255,0.4)',
                                font: { size: 10, weight: 'bold' }
                            },
                            grid: { display: false }
                        }
                    }
                }
            });

            showToast('Visualizaci√≥n hist√≥rica actualizada');
        }

        async function loadHistorical(muniId) {
            if (!muniId) return;
            try {
                const [partRes, compRes] = await Promise.all([
                    fetch(`${API_URL}/data/participation/${muniId}`),
                    fetch(`${API_URL}/data/comparison/${muniId}`)
                ]);

                // Verificar que ambos respondieron OK antes de parsear
                const participation = partRes.ok  ? await partRes.json()  : [];
                const comparison   = compRes.ok  ? await compRes.json()  : [];

                // Si ambos est√°n vac√≠os no hay nada que graficar
                if ((!participation || participation.length === 0) &&
                    (!comparison   || comparison.length === 0)) {
                    showToast('Sin datos hist√≥ricos para este municipio', 'error');
                    if (charts.part) { charts.part.destroy(); charts.part = null; }
                    if (charts.res)  { charts.res.destroy();  charts.res  = null; }
                    return;
                }

                renderCharts({
                    participation: Array.isArray(participation) ? participation : [],
                    comparison:    Array.isArray(comparison)    ? comparison    : []
                });
            } catch (e) {
                console.error('Error loading historical data:', e);
                showToast('Error al cargar datos hist√≥ricos', 'error');
            }
        }

        // Esta funci√≥n ya no se usa - reemplazada por loadPredictionsForMunicipality
        async function loadPredictions(muniId) {
            // Legacy function - redirect to new implementation
            loadPredictionsForMunicipality(muniId);
        }

        // --- UTILS ---
        function switchTab(tab) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById('tab-' + tab).classList.add('active');
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('nav-active'));
            document.querySelector(`[data-tab="${tab}"]`).classList.add('nav-active');
        }

        function showToast(msg, type = 'success') {
            const t = document.createElement('div');
            t.className = `toast shadow-2xl border ${type === 'success' ? 'bg-emerald-600/90 border-emerald-500' : 'bg-red-600/90 border-red-500'} backdrop-blur-xl`;
            t.textContent = msg;
            document.body.appendChild(t);
            setTimeout(() => {
                t.style.opacity = '0';
                t.style.transform = 'translateY(20px)';
                setTimeout(() => t.remove(), 500);
            }, 3500);
        }

        function logout() {
            localStorage.removeItem('guardianToken');
            location.reload();
        }

        async function populateMunicipios() {
            try {
                const res = await fetch(`${API_URL}/data/municipalities`);
                const data = await res.json();
                const selectors = [
                    document.getElementById('muni-selector'),
                    document.getElementById('pred-muni-selector'),
                    document.getElementById('incident-muni-selector')
                ];

                selectors.forEach(select => {
                    if (!select) return;
                    const isGlobal = select.id === 'muni-selector';

                    // Filtrar datos inv√°lidos/vac√≠os
                    const validData = data.filter(m => m.name && m.name.trim().length > 0);

                    const optionsHTML = validData.map(m => {
                        // Limpiar nombre: Quitar n√∫meros al inicio si existen
                        const cleanName = m.name.replace(/^[0-9\s\-]+/, '').toUpperCase();
                        if (!cleanName.trim()) return ''; // Doble check por si el replace deja vac√≠o

                        // Marcar Acapulco como seleccionado por defecto si coincide
                        const isAcapulco = cleanName.includes('ACAPULCO');
                        const isSelected = isAcapulco ? 'selected' : '';

                        return `<option value="${m.id}" ${isSelected}>${cleanName}</option>`;
                    }).join('');

                    select.innerHTML = '<option value="">' + (isGlobal ? 'ESTADO DE GUERRERO (TODO)' : 'SELECCIONA MUNICIPIO') + '</option>' + optionsHTML;
                });
            } catch (e) {
                const selectors = [
                    document.getElementById('muni-selector'),
                    document.getElementById('pred-muni-selector'),
                    document.getElementById('incident-muni-selector')
                ];
                selectors.forEach(select => {
                    if (!select) return;
                    const isGlobal = select.id === 'muni-selector';
                    select.innerHTML = '<option value="">' + (isGlobal ? 'ESTADO DE GUERRERO (TODO)' : 'SELECCIONA MUNICIPIO') + '</option>' +
                        MUNICIPIOS_GUERRERO.map(m => {
                            return `<option value="${m.id}">${m.name.toUpperCase()}</option>`;
                        }).join('');
                });
            }
        }
        // --- PREDICTIONS FUNCTIONS ---

        async function loadPredictionsForMunicipality(municipalityId) {
            console.log('üîÑ Cargando predicciones para municipio ID:', municipalityId);

            if (!municipalityId) {
                document.getElementById('candidates-grid').classList.add('hidden');
                document.getElementById('predictions-results').classList.add('hidden');
                document.getElementById('predictions-placeholder').classList.remove('hidden');
                return;
            }

            try {
                const res = await fetch(`${API_URL}/data/candidates/${municipalityId}`);
                if (!res.ok) throw new Error(`Error HTTP: ${res.status}`);

                const rawData = await res.json();
                console.log('üì• Datos crudos predicciones:', rawData);

                // MAPEO EXPL√çCITO PARA PREDICCIONES + fallback foto local
                const candidates = rawData.map(c => {
                    let imgPath = c.photo_url || c.img || null;
                    if (!imgPath) {
                        const match = ASPIRANTES.find(a =>
                            a.name.toLowerCase().includes(c.name.toLowerCase().split(' ')[0]) ||
                            c.name.toLowerCase().includes(a.name.toLowerCase().split(' ')[0])
                        );
                        if (match && match.img) imgPath = match.img;
                    }
                    return {
                        id: String(c.id || ''),
                        name: String(c.name || 'Sin nombre'),
                        party: String(c.party || 'Sin partido'),
                        img: imgPath
                    };
                });

                console.log('‚úÖ Candidatos predicciones procesados:', candidates);

                if (candidates.length === 0) {
                    document.getElementById('candidates-grid').classList.add('hidden');
                    document.getElementById('predictions-results').classList.add('hidden');
                    document.getElementById('predictions-placeholder').classList.remove('hidden');
                    return;
                }

                // Mostrar candidatos
                document.getElementById('predictions-placeholder').classList.add('hidden');
                document.getElementById('candidates-grid').classList.remove('hidden');
                document.getElementById('predictions-results').classList.add('hidden');

                const candidatesGrid = document.getElementById('candidates-grid');
                candidatesGrid.innerHTML = candidates.map(candidate => `
            <div class="candidate-card glass-card p-6 rounded-2xl cursor-pointer hover:scale-105 transition-all border-2 border-transparent" 
                 onclick="selectCandidateForPrediction('${candidate.id}', this)">
                <div class="flex items-center gap-4">
                    <div class="w-16 h-16 rounded-full bg-slate-800 flex items-center justify-center overflow-hidden border-2 border-white/10">
                        ${candidate.img
                        ? `<img src="${candidate.img}" class="w-full h-full object-cover" 
                                 onerror="this.parentElement.innerHTML='<span class=\\'text-2xl font-bold text-slate-500\\'>${candidate.name.charAt(0)}</span>'"
                                 alt="${candidate.name}">`
                        : `<span class="text-2xl font-bold text-slate-500">${candidate.name.charAt(0)}</span>`
                    }
                    </div>
                    <div>
                        <h4 class="font-bold text-white text-sm">${candidate.name}</h4>
                        <span class="text-xs text-amber-500 font-bold">${candidate.party}</span>
                    </div>
                </div>
            </div>
        `).join('');

            } catch (error) {
                console.error('‚ùå Error en loadPredictionsForMunicipality:', error);
                showToast('Error al cargar predicciones: ' + error.message, 'error');
            }
        }

        // Funci√≥n auxiliar para manejar la selecci√≥n de un candidato
        // (definici√≥n real abajo en selectPredictionCard + alias)

        let selectedPredictionCandidate = null;

        // Funci√≥n para seleccionar candidato en predicciones
        function selectPredictionCard(candidateId, municipalityId, element) {
            console.log('üéØ Candidato seleccionado:', candidateId);
            console.log('üéØ Municipio:', municipalityId);

            // Remover selecci√≥n previa
            document.querySelectorAll('#candidates-grid .candidate-card').forEach(card => {
                card.classList.remove('selected', 'border-amber-500', 'bg-amber-500/10');
            });

            // Marcar como seleccionado
            element.classList.add('selected', 'border-amber-500', 'bg-amber-500/10');

            // Mostrar modal de confianza
            showConfidenceSlider(candidateId, municipalityId);
        }

        // Alias para compatibilidad
        function selectCandidateForPrediction(candidateId, element) {
            const municipalityId = element.dataset.municipalityId ||
                document.getElementById('pred-muni-selector')?.value;
            selectPredictionCard(candidateId, municipalityId, element);
        }

        function showConfidenceSlider(candidateId, municipalityId) {
            console.log('üéöÔ∏è Abriendo slider de confianza');
            console.log('   Candidato:', candidateId);
            console.log('   Municipio:', municipalityId);

            // Crear modal
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 z-[200] bg-black/90 backdrop-blur-2xl flex items-center justify-center p-4';
            modal.innerHTML = `
        <div class="glass-card p-10 rounded-[3rem] w-full max-w-md text-center relative">
            <button onclick="this.parentElement.parentElement.remove()" 
                    class="absolute top-6 right-6 text-3xl font-thin hover:text-amber-500 transition">&times;</button>
            
            <h3 class="text-2xl font-black italic uppercase tracking-tighter mb-8">
                Nivel de <span class="text-amber-500">Confianza</span>
            </h3>
            
            <div class="space-y-6">
                <div class="text-center">
                    <div id="confidence-display" class="text-5xl font-black text-amber-500 mb-2">75%</div>
                    <div class="text-xs font-bold text-slate-500 uppercase tracking-widest">Probable</div>
                </div>
                
                <input type="range" 
                       id="confidence-slider" 
                       min="10" 
                       max="100" 
                       step="5" 
                       value="75"
                       class="w-full h-3 bg-slate-700 rounded-lg appearance-none cursor-pointer"
                       oninput="updateConfidenceDisplay(this.value)">
                
                <div class="flex justify-between text-[10px] font-bold text-slate-600 uppercase tracking-widest">
                    <span>Dudoso</span>
                    <span>Seguro</span>
                </div>
                
                <button onclick="savePrediction('${municipalityId}', '${candidateId}', document.getElementById('confidence-slider').value)"
                        class="w-full bg-amber-600 hover:bg-amber-700 p-6 rounded-2xl font-black text-lg shadow-2xl shadow-amber-900/20 uppercase tracking-tight transition">
                    Guardar Predicci√≥n
                </button>
            </div>
        </div>
    `;

            document.body.appendChild(modal);
        }

        function updateConfidenceDisplay(value) {
            const display = document.getElementById('confidence-display');
            const label = display.nextElementSibling;

            display.textContent = value + '%';

            const labels = {
                10: 'Muy Dudoso', 20: 'Muy Dudoso',
                30: 'Dudoso', 40: 'Dudoso',
                50: 'Neutral', 60: 'Neutral',
                70: 'Probable', 80: 'Probable',
                90: 'Muy Seguro', 100: 'Muy Seguro'
            };

            label.textContent = labels[Math.round(value / 10) * 10] || 'Probable';
        }

        // (updateConfidenceDisplay definida arriba ‚Äî versi√≥n √∫nica)

// ============================================
// PREDICCIONES ‚Äî FLUJO UNIFICADO (SIN BLOQUEO POR AUTH)
// ============================================

// Funci√≥n interna que realmente env√≠a la predicci√≥n
async function doSendPrediction(prediction) {
    const { municipalityId, candidateId, confidence } = prediction;

    console.log('üì§ Enviando predicci√≥n (doSendPrediction):', {
        municipalityId,
        candidateId,
        confidence
    });

    if (!municipalityId || !candidateId) {
        showToast('Selecciona un municipio y un candidato', 'error');
        return;
    }

    try {
        const response = await fetch('/api/predictions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
                // NO mandamos Authorization; el backend maneja usuario an√≥nimo si no hay token.
            },
            body: JSON.stringify({
                municipalityId: parseInt(municipalityId, 10),
                candidateId: candidateId, // puede ser "21" o "candidato_21"; el backend lo normaliza
                confidence: parseInt(confidence || 50, 10)
            })
        });

        const result = await response.json();

        if (!response.ok) {
            throw new Error(result.error || 'Error al guardar predicci√≥n');
        }

        // Mostrar mensaje de √©xito
        if (typeof Swal !== 'undefined') {
            Swal.fire({
                icon: 'success',
                title: '¬°Predicci√≥n Registrada!',
                html: result.prediction ? `
                    <div style="text-align: center;">
                        <h4>${result.prediction.candidateName}</h4>
                        <p>Partido: ${result.prediction.candidateParty}</p>
                        <p>Confianza: ${result.prediction.confidence}%</p>
                        ${result.pointsEarned ? `<hr><p style="color:#28a745;">+${result.pointsEarned} puntos</p>` : ''}
                    </div>
                ` : 'Tu predicci√≥n ha sido guardada correctamente.',
                confirmButtonText: 'Aceptar',
                confirmButtonColor: '#28a745'
            });
        } else {
            showToast(result.message || 'Predicci√≥n registrada', 'success');
        }

        // Refrescar estad√≠sticas (si existe)
        if (typeof updatePredictionStats === 'function') {
            updatePredictionStats(municipalityId);
        }

        // Refrescar puntos del usuario (si hay login real)
        if (typeof updateUserPoints === 'function') {
            updateUserPoints();
        }

        return result;

    } catch (error) {
        console.error('‚ùå Error al enviar predicci√≥n:', error);

        if (typeof Swal !== 'undefined') {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: error.message || 'No se pudo guardar tu predicci√≥n',
                confirmButtonText: 'Entendido'
            });
        } else {
            showToast('Error al guardar predicci√≥n: ' + error.message, 'error');
        }

        throw error;
    }
}


// ============================================
// INICIALIZACI√ìN AL CARGAR LA P√ÅGINA
// ============================================

document.addEventListener('DOMContentLoaded', async function() {
    console.log('üöÄ Inicializando sistema de autenticaci√≥n Guardianes');
    
    // Verificar si hay sesi√≥n activa
    if (auth.isAuthenticated()) {
        try {
            const response = await auth.authenticatedFetch('/api/auth/me');
            if (response.ok) {
                const userData = await response.json();
                console.log('‚úÖ Usuario autenticado:', userData.name);
                
                // Actualizar UI con info del usuario
                if (document.getElementById('userInfo')) {
                    document.getElementById('userInfo').innerHTML = `
                        <span>üë§ ${userData.name}</span>
                        <span>üèÜ ${userData.points} puntos</span>
                    `;
                }
            }
        } catch (error) {
            console.log('‚ö†Ô∏è Sesi√≥n no v√°lida, limpiando...');
            auth.logout();
        }
    }
});

// ============================================
// FUNCIONES AUXILIARES
// ============================================

function updateUserPoints() {
    // Actualizar puntos en la UI
    if (auth.isAuthenticated() && auth.user) {
        fetch('/api/auth/me', {
            headers: auth.getAuthHeaders()
        })
        .then(res => res.json())
        .then(data => {
            auth.user.points = data.points;
            localStorage.setItem('user', JSON.stringify(auth.user));
            
            // Actualizar UI
            const pointsElements = document.querySelectorAll('.user-points');
            pointsElements.forEach(el => {
                el.textContent = data.points;
            });
        })
        .catch(console.error);
    }
}

function updatePredictionStats(municipalityId) {
    // Recargar estad√≠sticas de predicci√≥n
    fetch(`/api/predictions/stats/${municipalityId}`)
        .then(res => res.json())
        .then(data => {
            console.log('üìä Estad√≠sticas actualizadas:', data);
            // Actualizar gr√°ficas si existen
            if (typeof updateCharts === 'function') {
                updateCharts(data);
            }
        })
        .catch(console.error);
}

        async function loadPredictionResults(municipalityId) {
            try {
                const res = await fetch(`${API_URL}/predictions/results/${municipalityId}`);
                const data = await res.json();

                const resultsContainer = document.getElementById('predictions-results');
                const resultsGrid = document.getElementById('results-grid');

                if (data.rankings && data.rankings.length > 0) {
                    resultsGrid.innerHTML = data.rankings.slice(0, 6).map((r, idx) => `
                        <div class="glass-card p-6 rounded-[2rem] ${idx === 0 ? 'border-amber-600 bg-amber-600/5' : ''}">
                            <div class="flex items-center gap-4 mb-4">
                                <div class="w-8 h-8 rounded-full bg-amber-600 flex items-center justify-center font-black text-slate-950 text-sm">${idx + 1}</div>
                                <div class="flex-1">
                                    <h5 class="font-black text-sm uppercase tracking-tight text-white">${r.candidate_name}</h5>
                                    <div class="text-[8px] font-bold text-amber-500 uppercase tracking-widest">${r.party || 'INDEPENDIENTE'}</div>
                                </div>
                            </div>
                            <div class="space-y-2">
                                <div class="flex justify-between text-[10px] font-bold uppercase">
                                    <span class="text-slate-500">Predicciones</span>
                                    <span class="text-white">${r.total_predictions || 0}</span>
                                </div>
                                <div class="flex justify-between text-[10px] font-bold uppercase">
                                    <span class="text-slate-500">Confianza Promedio</span>
                                    <span class="text-amber-500">${Math.round(r.avg_confidence || 0)}%</span>
                                </div>
                                <div class="flex justify-between text-[10px] font-bold uppercase">
                                    <span class="text-slate-500">Puntuaci√≥n de Tendencia</span>
                                    <span class="text-emerald-500">${Math.round(r.trend_score || 0)}</span>
                                </div>
                            </div>
                        </div>
                    `).join('');
                    resultsContainer.classList.remove('hidden');
                } else {
                    resultsContainer.classList.add('hidden');
                }
            } catch (e) {
                console.log('Sin resultados de predicciones a√∫n:', e);
            }
        }
        if (auth_token) showPortal();

// ============================================
// FUNCIONES DE UI PARA AUTENTICACI√ìN
// ============================================
class GuardianesAuth {
    constructor() {
        this.accessToken = localStorage.getItem('guardianToken');
        this.user = JSON.parse(localStorage.getItem('user') || 'null');
        this.pendingPrediction = null;
    }
    
    isAuthenticated() {
        return !!this.accessToken;
    }
    
    getAuthHeaders() {
        return {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${this.accessToken}`
        };
    }
    
    async authenticatedFetch(url, options = {}) {
        options.headers = {
            ...options.headers,
            ...this.getAuthHeaders()
        };
        
        const response = await fetch(url, options);
        
        if (response.status === 401) {
            this.logout();
            location.reload();
        }
        
        return response;
    }
    
    logout() {
        localStorage.clear();
        location.reload();
    }
}

const auth = new GuardianesAuth();
function closeAuthModal() {
    document.getElementById('authModal').classList.remove('show');
    if (auth.otpTimer) {
        clearInterval(auth.otpTimer);
    }
}

async function requestOTP() {
    const phone = document.getElementById('phoneInput').value.trim();
    
    if (!/^\d{10}$/.test(phone)) {
        Swal.fire('Error', 'Ingresa 10 d√≠gitos sin espacios ni guiones', 'error');
        return;
    }
    
    try {
        // Mostrar loading
        Swal.fire({
            title: 'Enviando c√≥digo...',
            text: 'Por favor espera',
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });
        
        const response = await fetch('/api/auth/request-code', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ phone })
        });
        
        const data = await response.json();
        
        Swal.close();
        
        if (!response.ok) {
            throw new Error(data.error || 'Error al enviar c√≥digo');
        }
        
        // Guardar n√∫mero y mostrar siguiente paso
        auth.phoneNumber = phone;
        document.getElementById('phoneStep').classList.remove('active');
        document.getElementById('codeStep').classList.add('active');
        document.getElementById('phoneLast4').textContent = data.phoneLast4;
        
        // Iniciar timer
        startOTPTimer();
        
        // En desarrollo, mostrar c√≥digo
        if (data.debug_otp) {
            console.log('üîë C√≥digo de prueba:', data.debug_otp);
            Swal.fire('C√≥digo de Prueba', `Tu c√≥digo es: ${data.debug_otp}`, 'info');
        }
        
    } catch (error) {
        Swal.fire('Error', error.message, 'error');
    }
}

async function verifyCode() {
    const code = document.getElementById('codeInput').value.trim();
    
    if (!/^\d{6}$/.test(code)) {
        Swal.fire('Error', 'Ingresa el c√≥digo de 6 d√≠gitos', 'error');
        return;
    }
    
    try {
        Swal.fire({
            title: 'Verificando...',
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });
        
        const response = await fetch('/api/auth/verify-code', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                phone: auth.phoneNumber, 
                code 
            })
        });
        
        const data = await response.json();
        
        Swal.close();
        
        if (!response.ok) {
            throw new Error(data.error || 'C√≥digo incorrecto');
        }
        
        // Guardar tokens y usuario
        auth.accessToken = data.accessToken;
        auth.refreshToken = data.refreshToken;
        auth.user = data.user;
        
        localStorage.setItem('accessToken', auth.accessToken);
        localStorage.setItem('refreshToken', auth.refreshToken);
        localStorage.setItem('user', JSON.stringify(auth.user));
        
        // Mostrar √©xito
        document.getElementById('codeStep').classList.remove('active');
        document.getElementById('successStep').classList.add('active');
        document.getElementById('welcomeMessage').textContent = 
            `Bienvenido ${auth.user.name}. Ya puedes hacer predicciones y ganar puntos.`;
        
        // Si hay predicci√≥n pendiente, enviarla
        if (auth.pendingPrediction) {
            setTimeout(() => {
                closeAuthModal();
                submitAuthenticatedPrediction(auth.pendingPrediction);
            }, 2000);
        }
        
    } catch (error) {
        Swal.fire('Error', error.message, 'error');
    }
}

function backToPhone() {
    document.getElementById('phoneStep').classList.add('active');
    document.getElementById('codeStep').classList.remove('active');
    document.getElementById('phoneInput').value = '';
    document.getElementById('codeInput').value = '';
    if (auth.otpTimer) {
        clearInterval(auth.otpTimer);
    }
}

function startOTPTimer() {
    let seconds = 600; // 10 minutos
    
    auth.otpTimer = setInterval(() => {
        const minutes = Math.floor(seconds / 60);
        const secs = seconds % 60;
        document.getElementById('timerDisplay').textContent = 
            `C√≥digo v√°lido por: ${minutes}:${secs.toString().padStart(2, '0')}`;
        
        seconds--;
        
        if (seconds < 0) {
            clearInterval(auth.otpTimer);
            document.getElementById('timerDisplay').textContent = 'C√≥digo expirado';
        }
    }, 1000);
}

</script>
<script>
// ============================================
// PREDICCIONES ‚Äî EXPOSICI√ìN GLOBAL (window.*)
// ============================================

(function() {
    // Funci√≥n interna que realmente env√≠a la predicci√≥n
    async function doSendPrediction(prediction) {
        const { municipalityId, candidateId, confidence } = prediction;

        console.log('üì§ Enviando predicci√≥n (doSendPrediction):', {
            municipalityId,
            candidateId,
            confidence
        });

        if (!municipalityId || !candidateId) {
            if (typeof showToast === 'function') {
                showToast('Selecciona un municipio y un candidato', 'error');
            } else {
                alert('Selecciona un municipio y un candidato');
            }
            return;
        }

        try {
            const response = await fetch('/api/predictions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                    // Importante: sin Authorization; backend ya maneja usuario an√≥nimo.
                },
                body: JSON.stringify({
                    municipalityId: parseInt(municipalityId, 10),
                    candidateId: candidateId, // "21" o "candidato_21" ‚Üí backend lo normaliza
                    confidence: parseInt(confidence || 50, 10)
                })
            });

            const result = await response.json();

            if (!response.ok) {
                throw new Error(result.error || 'Error al guardar predicci√≥n');
            }

            // Mensaje de √©xito
            if (typeof Swal !== 'undefined') {
                Swal.fire({
                    icon: 'success',
                    title: '¬°Predicci√≥n Registrada!',
                    html: result.prediction ? `
                        <div style="text-align: center;">
                            <h4>${result.prediction.candidateName}</h4>
                            <p>Partido: ${result.prediction.candidateParty}</p>
                            <p>Confianza: ${result.prediction.confidence}%</p>
                            ${result.pointsEarned ? `<hr><p style="color:#28a745;">+${result.pointsEarned} puntos</p>` : ''}
                        </div>
                    ` : 'Tu predicci√≥n ha sido guardada correctamente.',
                    confirmButtonText: 'Aceptar',
                    confirmButtonColor: '#28a745'
                });
            } else if (typeof showToast === 'function') {
                showToast(result.message || 'Predicci√≥n registrada', 'success');
            } else {
                alert('Predicci√≥n registrada correctamente');
            }

            // Refrescar estad√≠sticas si existe
            if (typeof updatePredictionStats === 'function') {
                updatePredictionStats(municipalityId);
            }

            // Refrescar puntos del usuario si hay auth real
            if (typeof updateUserPoints === 'function') {
                updateUserPoints();
            }

            return result;

        } catch (error) {
            console.error('‚ùå Error al enviar predicci√≥n:', error);

            if (typeof Swal !== 'undefined') {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: error.message || 'No se pudo guardar tu predicci√≥n',
                    confirmButtonText: 'Entendido'
                });
            } else if (typeof showToast === 'function') {
                showToast('Error al guardar predicci√≥n: ' + error.message, 'error');
            } else {
                alert('Error al guardar predicci√≥n: ' + error.message);
            }

            throw error;
        }
    }

    // API global usada por los botones (onclick="savePrediction(...)")
    window.savePrediction = function(municipalityId, candidateId, confidence) {
        return doSendPrediction({ municipalityId, candidateId, confidence });
    };

    // Compatibilidad: si en alg√∫n lugar todav√≠a llaman a submitAuthenticatedPrediction,
    // lo redirigimos al mismo flujo.
    window.submitAuthenticatedPrediction = function(prediction) {
        return doSendPrediction(prediction);
    };

console.log('‚úÖ Funciones de predicci√≥n expuestas en window.savePrediction y window.submitAuthenticatedPrediction');
    
})();


// ============================================
// FUNCI√ìN PRINCIPAL: LOGIN SIMPLIFICADO
// ============================================
async function quickLogin() {
    const phoneInput = document.getElementById('user-phone');
    const phone = phoneInput.value.trim().replace(/\s+/g, '');
    
    // Validar formato
    if (phone.length !== 10) {
        showToast('Ingresa 10 d√≠gitos', 'error');
        phoneInput.focus();
        return;
    }
    
    if (!/^\d{10}$/.test(phone)) {
        showToast('Solo n√∫meros', 'error');
        phoneInput.focus();
        return;
    }
    
    // Validar c√≥digo de √°rea de Guerrero
    const validAreaCodes = ['744', '747', '733', '758', '767', '741', '742'];
    const areaCode = phone.substring(0, 3);
    
    if (!validAreaCodes.includes(areaCode)) {
        showToast('Solo n√∫meros de Guerrero (744, 747, 733, etc.)', 'error');
        phoneInput.focus();
        return;
    }
    
    try {
        console.log('üì± Intentando login con:', phone.substring(0, 3) + '****' + phone.substring(7));
        
        const res = await fetch(`${API_URL}/auth/quick-login`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ phone })
        });
        
        const data = await res.json();
        
        if (data.success) {
            // Guardar token y datos
            localStorage.setItem('guardianToken', data.token);
            localStorage.setItem('accessToken', data.token);
            localStorage.setItem('user', JSON.stringify(data.user));
            auth_token = data.token;
            userPhone = phone;
            
            // Actualizar UI
            document.getElementById('user-points').textContent = 
                `${data.user.points || 0} PTS de Influencia`;
            
            // Mostrar portal
            showPortal();
            
            // Mensaje de bienvenida
            showToast(data.message || '‚úÖ Acceso Autorizado', 'success');
            
            console.log('‚úÖ Login exitoso:', data.user);
        } else {
            showToast(data.error || 'Error de acceso', 'error');
        }
        
    } catch (error) {
        console.error('‚ùå Error en login:', error);
        showToast('Error de conexi√≥n. Intenta de nuevo.', 'error');
    }
}

// ============================================
// FUNCI√ìN: MOSTRAR PORTAL
// ============================================
async function showPortal() {
    document.getElementById('auth-section').classList.add('hidden');
    document.getElementById('portal-section').classList.remove('hidden');
    document.getElementById('user-info').classList.remove('hidden');
    
    // Cargar datos
    loadSurveys();
    populateMunicipios();
}

// ============================================
// FUNCI√ìN: LOGOUT
// ============================================
function logout() {
    localStorage.removeItem('guardianToken');
    localStorage.removeItem('accessToken');
    localStorage.removeItem('user');
    auth_token = null;
    location.reload();
}

// ============================================
// TOAST (NOTIFICACIONES)
// ============================================
function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `fixed bottom-4 right-4 p-4 rounded-xl shadow-2xl z-[9999] animate-in slide-in-from-bottom-4 ${
        type === 'success' ? 'bg-emerald-600' : 
        type === 'error' ? 'bg-red-600' : 
        'bg-amber-600'
    }`;
    toast.innerHTML = `<p class="font-black text-white">${message}</p>`;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.classList.add('animate-out', 'fade-out');
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

// ============================================
// AUTO-LOGIN SI YA HAY TOKEN
// ============================================
if (auth_token) {
    console.log('üîë Token encontrado, auto-login...');
    showPortal();
}
</script>

</body>

</html>
